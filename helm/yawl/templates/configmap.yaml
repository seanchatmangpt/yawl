{{- /*
  YAWL v6.0.0 â€“ ConfigMaps
  -------------------------
  configmap 1: main application config (environment variables)
  configmap 2: hibernate/HikariCP settings
  configmap 3: application.properties overlay (mounted at /app/config/)
  configmap 4: specification storage init (mounted as init-scripts)
*/ -}}
# -----------------------------------------------------------------------------
# ConfigMap 1: Main application environment variables
# -----------------------------------------------------------------------------
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "yawl.fullname" . }}-config
  namespace: {{ include "yawl.namespace" . }}
  labels:
    {{- include "yawl.labels" . | nindent 4 }}
    app.kubernetes.io/component: config
data:
  # Database
  DATABASE_TYPE: "postgres"
  DATABASE_HOST: {{ include "yawl.databaseHost" . | quote }}
  DATABASE_PORT: {{ include "yawl.databasePort" . | quote }}
  DATABASE_PATH: {{ include "yawl.databaseName" . | quote }}
  DATABASE_URL: {{ include "yawl.databaseUrl" . | quote }}

  # Logging
  LOGGING_LEVEL_ROOT: {{ .Values.logging.root | quote }}
  LOGGING_LEVEL_ORG_YAWLFOUNDATION: {{ .Values.logging.yawl | quote }}
  LOGGING_LEVEL_ORG_HIBERNATE: {{ .Values.logging.hibernate | quote }}

  # JVM
  JAVA_OPTS: {{ .Values.jvm.opts | quote }}

  # Spring Boot Actuator / management
  MANAGEMENT_SERVER_PORT: "9090"
  MANAGEMENT_HEALTH_PROBES_ENABLED: "true"
  MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS: "when-authorized"
  MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: "health,info,metrics,prometheus"
  SPRING_PROFILES_ACTIVE: "production"
  SPRING_THREADS_VIRTUAL_ENABLED: "true"

  # Service mesh URLs (internal ClusterIP DNS)
  ENGINE_URL: {{ printf "http://%s-engine:%d/yawl" (include "yawl.name" .) (int .Values.services.engine.service.port) | quote }}
  RESOURCE_SERVICE_URL: {{ printf "http://%s-resource-service:%d/resourceService" (include "yawl.name" .) (int .Values.services.resourceService.service.port) | quote }}
  WORKLET_SERVICE_URL: {{ printf "http://%s-worklet-service:%d/workletService" (include "yawl.name" .) (int .Values.services.workletService.service.port) | quote }}
  MONITOR_SERVICE_URL: {{ printf "http://%s-monitor-service:%d/monitorService" (include "yawl.name" .) (int .Values.services.monitorService.service.port) | quote }}
  COST_SERVICE_URL: {{ printf "http://%s-cost-service:%d/costService" (include "yawl.name" .) (int .Values.services.costService.service.port) | quote }}
  SCHEDULING_SERVICE_URL: {{ printf "http://%s-scheduling-service:%d/schedulingService" (include "yawl.name" .) (int .Values.services.schedulingService.service.port) | quote }}

  # Redis
  REDIS_HOST: {{ include "yawl.redisHost" . | quote }}
  REDIS_PORT: {{ include "yawl.redisPort" . | quote }}

  # YAWL version metadata
  YAWL_VERSION: {{ .Values.yawlVersion | quote }}
  YAWL_BUILD_NUMBER: {{ .Values.buildNumber | quote }}

  # Cloud provider hint
  CLOUD_PROVIDER: {{ .Values.cloudProvider | default "" | quote }}
---
# -----------------------------------------------------------------------------
# ConfigMap 2: Hibernate / HikariCP settings
# -----------------------------------------------------------------------------
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "yawl.fullname" . }}-hibernate-config
  namespace: {{ include "yawl.namespace" . }}
  labels:
    {{- include "yawl.labels" . | nindent 4 }}
    app.kubernetes.io/component: hibernate-config
data:
  hibernate.dialect: "org.hibernate.dialect.PostgreSQLDialect"
  hibernate.show_sql: "false"
  hibernate.format_sql: "false"
  hibernate.hbm2ddl.auto: "validate"            # v6: validate only (migrations via Flyway)
  hibernate.cache.use_second_level_cache: "true"
  hibernate.cache.use_query_cache: "true"
  hibernate.jdbc.batch_size: "50"
  hibernate.order_inserts: "true"
  hibernate.order_updates: "true"
  hibernate.generate_statistics: "false"
  hibernate.connection.provider_class: "org.hibernate.hikaricp.internal.HikariCPConnectionProvider"
  # HikariCP pool sizing (min 5, max 20 per performance baseline)
  hibernate.hikari.minimumIdle: "5"
  hibernate.hikari.maximumPoolSize: "20"
  hibernate.hikari.idleTimeout: "300000"
  hibernate.hikari.connectionTimeout: "30000"
  hibernate.hikari.maxLifetime: "1800000"
  hibernate.hikari.keepaliveTime: "60000"
  hibernate.hikari.leakDetectionThreshold: "60000"
  hibernate.hikari.poolName: "YAWLHikariPool"
---
# -----------------------------------------------------------------------------
# ConfigMap 3: application.properties overlay (mounted at /app/config/)
# Overrides bundled defaults without rebuilding the image.
# -----------------------------------------------------------------------------
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "yawl.fullname" . }}-app-config
  namespace: {{ include "yawl.namespace" . }}
  labels:
    {{- include "yawl.labels" . | nindent 4 }}
    app.kubernetes.io/component: app-config
data:
  application.properties: |
    # YAWL v6.0.0 Kubernetes application.properties overlay
    # Applied on top of bundled application.properties at startup

    # Server
    server.port=8080
    server.shutdown=graceful
    server.tomcat.threads.min-spare=10
    server.tomcat.threads.max=200
    spring.lifecycle.timeout-per-shutdown-phase=50s

    # Actuator management port (separate from engine port)
    management.server.port=9090
    management.health.probes.enabled=true
    management.endpoint.health.show-details=when-authorized
    management.endpoints.web.exposure.include=health,info,metrics,prometheus
    management.metrics.export.prometheus.enabled=true

    # Graceful shutdown (allow in-flight requests 50s)
    spring.lifecycle.timeout-per-shutdown-phase=50s

    # Database (values injected via environment variables)
    spring.datasource.url=${DATABASE_URL}
    spring.datasource.username=${DB_USER}
    spring.datasource.password=${DB_PASSWORD}
    spring.datasource.hikari.minimum-idle=5
    spring.datasource.hikari.maximum-pool-size=20

    # Flyway database migrations
    spring.flyway.enabled=true
    spring.flyway.baseline-on-migrate=false
    spring.flyway.validate-on-migrate=true
    spring.flyway.locations=classpath:db/migration

    # Virtual threads
    spring.threads.virtual.enabled=true

    # OpenTelemetry
    otel.service.name=yawl-engine
    otel.traces.exporter=otlp
    otel.metrics.exporter=prometheus
    otel.logs.exporter=otlp
