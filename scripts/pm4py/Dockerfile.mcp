# PM4Py MCP Server Container
# Python process mining MCP server with STDIO transport.
# Exposes 3 tools: pm4py_discover, pm4py_conformance, pm4py_performance.
#
# Security: Non-root user, minimal dependencies, health check
#
# Build args:
#   BUILD_DATE - OCI build date label
#   VCS_REF    - Git commit SHA label
#   VERSION    - Image version

FROM python:3.13-slim-bookworm AS base

ARG BUILD_DATE
ARG VCS_REF
ARG VERSION=1.0.0

# OCI Image Labels
LABEL org.opencontainers.image.title="PM4Py MCP Server" \
      org.opencontainers.image.description="Process mining MCP server: discovery, conformance, performance over XES logs" \
      org.opencontainers.image.created="${BUILD_DATE}" \
      org.opencontainers.image.revision="${VCS_REF}" \
      org.opencontainers.image.vendor="YAWL Foundation" \
      org.opencontainers.image.version="${VERSION}" \
      org.opencontainers.image.source="https://github.com/yawlfoundation/yawl" \
      org.opencontainers.image.licenses="LGPL-3.0"

# System dependencies for pm4py (graphviz for visualization, scipy needs build tools)
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        graphviz \
        curl \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user (security hardening)
RUN groupadd -r pm4py --gid=1000 && \
    useradd -r -g pm4py --uid=1000 --home-dir=/app --shell=/bin/false pm4py

WORKDIR /app

# Copy requirements first for Docker layer caching
COPY requirements.txt .

# Install Python dependencies
RUN pip install --no-cache-dir -r requirements.txt

# Copy application source
COPY mcp_server.py pm4py_backend.py ./

# Set proper ownership
RUN chown -R pm4py:pm4py /app

# Health check port (sidecar HTTP health endpoint alongside STDIO MCP)
EXPOSE 9091

USER pm4py

ENV PM4PY_MCP_HEALTH_PORT=9091

# STDIO MCP server (subprocess spawned by MCP client)
CMD ["python", "mcp_server.py"]

HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD curl -sf http://localhost:${PM4PY_MCP_HEALTH_PORT}/health || exit 1
