#!/usr/bin/env bash
# =============================================================================
# Observatory Configuration
# YAWL v5.2 - Code Observatory Settings
# =============================================================================

# -----------------------------------------------------------------------------
# Output Settings
# -----------------------------------------------------------------------------

# Directory where generated files are written
OUTPUT_DIR="${OUTPUT_DIR:-target/observatory}"

# Output format for facts (json, yaml, text)
FACTS_FORMAT="${FACTS_FORMAT:-json}"

# Mermaid diagram theme (default, dark, forest, neutral)
DIAGRAM_THEME="${DIAGRAM_THEME:-default}"

# -----------------------------------------------------------------------------
# Runtime Settings
# -----------------------------------------------------------------------------

# Minimum bash version required (major.minor)
BASH_MIN_VERSION="${BASH_MIN_VERSION:-4.3}"

# Number of parallel jobs for analysis (0 = auto-detect)
PARALLEL_JOBS="${PARALLEL_JOBS:-0}"

# Logging verbosity (ERROR, WARN, INFO, DEBUG, TRACE)
LOG_LEVEL="${LOG_LEVEL:-INFO}"

# Whether to collect and report metrics
ENABLE_METRICS="${ENABLE_METRICS:-true}"

# -----------------------------------------------------------------------------
# Analysis Settings
# -----------------------------------------------------------------------------

# Source directories to analyze (colon-separated)
SOURCE_DIRS="${SOURCE_DIRS:-src/main/java}"

# Test directories to analyze (colon-separated)
TEST_DIRS="${TEST_DIRS:-src/test/java}"

# File patterns to include (glob patterns, colon-separated)
INCLUDE_PATTERNS="${INCLUDE_PATTERNS:-**/*.java:**/*.xml:**/*.xsd}"

# File patterns to exclude (glob patterns, colon-separated)
EXCLUDE_PATTERNS="${EXCLUDE_PATTERNS:-**/target/**:**/node_modules/**}"

# Maximum depth for dependency traversal
MAX_DEPENDENCY_DEPTH="${MAX_DEPENDENCY_DEPTH:-10}"

# -----------------------------------------------------------------------------
# Reporting Settings
# -----------------------------------------------------------------------------

# Generate HTML report alongside JSON
GENERATE_HTML="${GENERATE_HTML:-false}"

# Include code snippets in reports
INCLUDE_CODE_SNIPPETS="${INCLUDE_CODE_SNIPPETS:-true}"

# Maximum lines per code snippet
MAX_SNIPPET_LINES="${MAX_SNIPPET_LINES:-50}"

# Timestamp format for reports
TIMESTAMP_FORMAT="${TIMESTAMP_FORMAT:-%Y-%m-%dT%H:%M:%S%z}"

# -----------------------------------------------------------------------------
# Validation Settings
# -----------------------------------------------------------------------------

# Fail on validation errors
FAIL_ON_ERROR="${FAIL_ON_ERROR:-false}"

# Warn on deprecated API usage
WARN_DEPRECATED="${WARN_DEPRECATED:-true}"

# Check for guard violations (TODO, FIXME, mock, stub)
CHECK_GUARDS="${CHECK_GUARDS:-true}"

# -----------------------------------------------------------------------------
# load_config - Load and validate configuration
# -----------------------------------------------------------------------------
# This function loads configuration from the config file and validates
# that all required settings are present and valid.
#
# Arguments:
#   $1 - (optional) Path to config file to load. Defaults to this file.
#
# Returns:
#   0 on success, 1 on failure
#
# Environment variables override file settings.
# -----------------------------------------------------------------------------
load_config() {
    local config_file="${1:-${BASH_SOURCE[0]}}"
    local config_dir

    # Resolve config directory
    if [[ -f "$config_file" ]]; then
        config_dir="$(cd "$(dirname "$config_file")" && pwd)"
    else
        echo "ERROR: Config file not found: $config_file" >&2
        return 1
    fi

    # Source the config file if it's different from current
    if [[ "$config_file" != "${BASH_SOURCE[0]}" ]]; then
        # shellcheck source=/dev/null
        source "$config_file" || {
            echo "ERROR: Failed to load config from: $config_file" >&2
            return 1
        }
    fi

    # Validate bash version
    local bash_major bash_minor
    IFS='.' read -r bash_major bash_minor <<< "$BASH_VERSION"
    local required_major required_minor
    IFS='.' read -r required_major required_minor <<< "$BASH_MIN_VERSION"

    if [[ "$bash_major" -lt "$required_major" ]] || \
       { [[ "$bash_major" -eq "$required_major" ]] && [[ "$bash_minor" -lt "$required_minor" ]]; }; then
        echo "ERROR: Bash version $BASH_VERSION is below minimum required $BASH_MIN_VERSION" >&2
        return 1
    fi

    # Auto-detect parallel jobs if set to 0
    if [[ "$PARALLEL_JOBS" -eq 0 ]]; then
        if command -v nproc &>/dev/null; then
            PARALLEL_JOBS=$(nproc)
        elif [[ -f /proc/cpuinfo ]]; then
            PARALLEL_JOBS=$(grep -c ^processor /proc/cpuinfo)
        else
            PARALLEL_JOBS=4  # Safe default
        fi
    fi

    # Validate FACTS_FORMAT
    case "$FACTS_FORMAT" in
        json|yaml|text) ;;
        *)
            echo "ERROR: Invalid FACTS_FORMAT: $FACTS_FORMAT (expected: json, yaml, text)" >&2
            return 1
            ;;
    esac

    # Validate DIAGRAM_THEME
    case "$DIAGRAM_THEME" in
        default|dark|forest|neutral) ;;
        *)
            echo "ERROR: Invalid DIAGRAM_THEME: $DIAGRAM_THEME (expected: default, dark, forest, neutral)" >&2
            return 1
            ;;
    esac

    # Validate LOG_LEVEL
    case "$LOG_LEVEL" in
        ERROR|WARN|INFO|DEBUG|TRACE) ;;
        *)
            echo "ERROR: Invalid LOG_LEVEL: $LOG_LEVEL (expected: ERROR, WARN, INFO, DEBUG, TRACE)" >&2
            return 1
            ;;
    esac

    # Normalize ENABLE_METRICS to boolean
    case "${ENABLE_METRICS,,}" in
        true|1|yes|on) ENABLE_METRICS="true" ;;
        false|0|no|off|*) ENABLE_METRICS="false" ;;
    esac

    # Create output directory if it doesn't exist
    if [[ ! -d "$OUTPUT_DIR" ]]; then
        mkdir -p "$OUTPUT_DIR" || {
            echo "ERROR: Failed to create output directory: $OUTPUT_DIR" >&2
            return 1
        }
    fi

    # Export configuration for sub-processes
    export OUTPUT_DIR
    export FACTS_FORMAT
    export DIAGRAM_THEME
    export BASH_MIN_VERSION
    export PARALLEL_JOBS
    export LOG_LEVEL
    export ENABLE_METRICS
    export SOURCE_DIRS
    export TEST_DIRS
    export INCLUDE_PATTERNS
    export EXCLUDE_PATTERNS
    export MAX_DEPENDENCY_DEPTH
    export GENERATE_HTML
    export INCLUDE_CODE_SNIPPETS
    export MAX_SNIPPET_LINES
    export TIMESTAMP_FORMAT
    export FAIL_ON_ERROR
    export WARN_DEPRECATED
    export CHECK_GUARDS

    # Store config directory for reference
    OBSERVATORY_CONFIG_DIR="$config_dir"
    export OBSERVATORY_CONFIG_DIR

    return 0
}

# -----------------------------------------------------------------------------
# get_config - Get a configuration value by name
# -----------------------------------------------------------------------------
# Arguments:
#   $1 - Configuration variable name
#
# Outputs:
#   Writes the configuration value to stdout
#
# Returns:
#   0 if found, 1 if not found
# -----------------------------------------------------------------------------
get_config() {
    local var_name="$1"
    local var_value

    # Get the value using indirect reference
    var_value="${!var_name}"

    if [[ -n "$var_value" ]]; then
        echo "$var_value"
        return 0
    else
        return 1
    fi
}

# -----------------------------------------------------------------------------
# set_config - Set a configuration value at runtime
# -----------------------------------------------------------------------------
# Arguments:
#   $1 - Configuration variable name
#   $2 - Configuration value
#
# Returns:
#   0 on success, 1 if variable name is invalid
# -----------------------------------------------------------------------------
set_config() {
    local var_name="$1"
    local var_value="$2"

    # Validate variable name (only allow known config variables)
    case "$var_name" in
        OUTPUT_DIR|FACTS_FORMAT|DIAGRAM_THEME|BASH_MIN_VERSION| \
        PARALLEL_JOBS|LOG_LEVEL|ENABLE_METRICS|SOURCE_DIRS| \
        TEST_DIRS|INCLUDE_PATTERNS|EXCLUDE_PATTERNS|MAX_DEPENDENCY_DEPTH| \
        GENERATE_HTML|INCLUDE_CODE_SNIPPETS|MAX_SNIPPET_LINES|TIMESTAMP_FORMAT| \
        FAIL_ON_ERROR|WARN_DEPRECATED|CHECK_GUARDS)
            declare -g "$var_name"="$var_value"
            export "$var_name"
            return 0
            ;;
        *)
            echo "ERROR: Unknown configuration variable: $var_name" >&2
            return 1
            ;;
    esac
}

# -----------------------------------------------------------------------------
# print_config - Print current configuration
# -----------------------------------------------------------------------------
# Outputs all current configuration values in a formatted table.
# -----------------------------------------------------------------------------
print_config() {
    printf "%-25s %s\n" "CONFIGURATION" "VALUE"
    printf "%-25s %s\n" "-------------" "-----"
    printf "%-25s %s\n" "OUTPUT_DIR" "$OUTPUT_DIR"
    printf "%-25s %s\n" "FACTS_FORMAT" "$FACTS_FORMAT"
    printf "%-25s %s\n" "DIAGRAM_THEME" "$DIAGRAM_THEME"
    printf "%-25s %s\n" "BASH_MIN_VERSION" "$BASH_MIN_VERSION"
    printf "%-25s %s\n" "PARALLEL_JOBS" "$PARALLEL_JOBS"
    printf "%-25s %s\n" "LOG_LEVEL" "$LOG_LEVEL"
    printf "%-25s %s\n" "ENABLE_METRICS" "$ENABLE_METRICS"
    printf "%-25s %s\n" "SOURCE_DIRS" "$SOURCE_DIRS"
    printf "%-25s %s\n" "TEST_DIRS" "$TEST_DIRS"
    printf "%-25s %s\n" "INCLUDE_PATTERNS" "$INCLUDE_PATTERNS"
    printf "%-25s %s\n" "EXCLUDE_PATTERNS" "$EXCLUDE_PATTERNS"
    printf "%-25s %s\n" "MAX_DEPENDENCY_DEPTH" "$MAX_DEPENDENCY_DEPTH"
    printf "%-25s %s\n" "GENERATE_HTML" "$GENERATE_HTML"
    printf "%-25s %s\n" "INCLUDE_CODE_SNIPPETS" "$INCLUDE_CODE_SNIPPETS"
    printf "%-25s %s\n" "MAX_SNIPPET_LINES" "$MAX_SNIPPET_LINES"
    printf "%-25s %s\n" "TIMESTAMP_FORMAT" "$TIMESTAMP_FORMAT"
    printf "%-25s %s\n" "FAIL_ON_ERROR" "$FAIL_ON_ERROR"
    printf "%-25s %s\n" "WARN_DEPRECATED" "$WARN_DEPRECATED"
    printf "%-25s %s\n" "CHECK_GUARDS" "$CHECK_GUARDS"
}

# =============================================================================
# Auto-load configuration if sourced directly
# =============================================================================
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    # Script is being executed directly, show config
    load_config && print_config
fi
