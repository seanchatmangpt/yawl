#!/usr/bin/env bash
# ==============================================================================
# ggen — CLI router for YAWL code generation toolchain
#
# Commands:
#   ggen --version                             Show version
#   ggen init [--verbose] [--clean]            Initialize .ggen/ workspace
#   ggen sync [--dry_run true] [--verbose]     Sync templates + SPARQL contexts
#   ggen generate --template <f> --input <f> --output <f> [--sparql <f>]
#
# ==============================================================================

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WRAPPER_SCRIPT="${SCRIPT_DIR}/ggen-wrapper.py"
INIT_SCRIPT="${SCRIPT_DIR}/ggen-init.sh"
SYNC_SCRIPT="${SCRIPT_DIR}/ggen-sync.sh"

COMMAND="${1:-}"

case "$COMMAND" in
    init)
        shift
        if [[ ! -f "$INIT_SCRIPT" ]]; then
            echo "ERROR: ggen-init.sh not found at: $INIT_SCRIPT" >&2
            exit 2
        fi
        exec bash "$INIT_SCRIPT" "$@"
        ;;
    sync)
        shift
        # Handle --dry_run true (preview only, no file writes)
        DRY_RUN=0
        PASSTHROUGH=()
        while [[ $# -gt 0 ]]; do
            case "$1" in
                --dry_run)
                    if [[ "${2:-}" == "true" ]]; then DRY_RUN=1; shift 2
                    else shift; fi ;;
                *) PASSTHROUGH+=("$1"); shift ;;
            esac
        done
        if [[ ! -f "$SYNC_SCRIPT" ]]; then
            echo "ERROR: ggen-sync.sh not found at: $SYNC_SCRIPT" >&2
            exit 2
        fi
        if [[ "$DRY_RUN" == "1" ]]; then
            echo "[dry-run] Would sync templates and SPARQL contexts from:"
            echo "  templates/ → .ggen/templates/"
            echo "  .ggen/sparql/ (7 validation queries)"
            echo "[dry-run] No files written."
            exit 0
        fi
        exec bash "$SYNC_SCRIPT" "${PASSTHROUGH[@]}"
        ;;
    generate)
        shift
        if [[ ! -f "$WRAPPER_SCRIPT" ]]; then
            echo "ERROR: ggen-wrapper.py not found at: $WRAPPER_SCRIPT" >&2
            exit 2
        fi
        exec python3 "$WRAPPER_SCRIPT" generate "$@"
        ;;
    --version|-v)
        echo "ggen 0.1.0"
        ;;
    --help|-h|"")
        cat <<'HELP'
ggen — YAWL ontology-driven code generation

Usage:
  ggen init [--verbose] [--clean]
      Initialize .ggen/ workspace (templates, SPARQL, cache)

  ggen sync [--dry_run true] [--templates-only] [--sparql-only] [--verbose]
      Sync Tera templates and SPARQL contexts; update .ggen/ cache

  ggen generate --template <file> --input <file> --output <file> [--sparql <file>]
      Generate artifact from a single RDF input + Tera template

  ggen --version
      Show version

Examples:
  ggen init
  ggen sync --dry_run true
  ggen sync
  ggen generate \
    --template templates/yawl-xml/workflow.yawl.tera \
    --input .specify/yawl-ontology.ttl \
    --output generated/workflow.yawl

HELP
        ;;
    *)
        echo "ERROR: Unknown command: $COMMAND" >&2
        echo "Run 'ggen --help' for usage." >&2
        exit 2
        ;;
esac
