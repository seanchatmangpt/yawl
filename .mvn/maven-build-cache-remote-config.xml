<?xml version="1.0" encoding="UTF-8"?>
<!--
  YAWL Distributed Build Cache — Maven Remote Cache Configuration

  Purpose:
    Enables Maven to cache build artifacts in S3/MinIO remote backend.
    Developers and CI runners download cached modules instead of rebuilding
    on every fresh machine.

  Features:
    - Local cache (per-machine): Fast, no network needed
    - Remote cache (S3): Shared across team, survives machine wipe
    - Automatic fallback: Local miss → Remote miss → Full build
    - TTL cleanup: Auto-delete artifacts older than 90 days
    - Compression: gzip (40-50% reduction)

  Activation:
    Automatically activated when YAWL_REMOTE_CACHE=1 (default).
    Can be disabled via: export YAWL_REMOTE_CACHE=0

  Environment Variables:
    YAWL_S3_ENDPOINT      - S3 endpoint (default: s3.amazonaws.com)
    YAWL_S3_BUCKET        - S3 bucket name (required)
    YAWL_S3_REGION        - AWS region (default: us-east-1)
    AWS_ACCESS_KEY_ID     - AWS credentials (or use IAM roles)
    AWS_SECRET_ACCESS_KEY - AWS credentials (or use IAM roles)
    YAWL_REMOTE_CACHE     - Enable/disable (1/0, default: 1)
-->

<cache xmlns="http://maven.apache.org/BUILD-CACHE-CONFIG/1.0.0"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://maven.apache.org/BUILD-CACHE-CONFIG/1.0.0
                           https://maven.apache.org/xsd/build-cache-config-1.0.0.xsd">

  <configuration>
    <!-- Enable caching globally -->
    <enabled>true</enabled>

    <!-- Hash algorithm for cache keys -->
    <hashAlgorithm>SHA-256</hashAlgorithm>

    <!-- Validate XML configuration -->
    <validateXml>true</validateXml>

    <!-- Adapt cache to JVM for optimal performance -->
    <adaptToJVM>true</adaptToJVM>
  </configuration>

  <!-- ─────────────────────────────────────────────────────────────────────────
       LOCAL CACHE (Per-Machine)

       Used for fast local builds. Stored in user's .m2/build-cache directory.
       Helps with frequent builds on same machine.
    ───────────────────────────────────────────────────────────────────────────→
  -->
  <local>
    <!-- Max number of builds to keep in local cache -->
    <maxBuildsCached>50</maxBuildsCached>

    <!-- How long to keep cache entries (30 days) -->
    <retentionPeriod>P30D</retentionPeriod>

    <!-- Max size of local cache directory (10 GB) -->
    <maxSize>10GB</maxSize>
  </local>

  <!-- ─────────────────────────────────────────────────────────────────────────
       REMOTE CACHE (S3 or MinIO)

       Shared cache for entire team. New machines download cached artifacts
       from S3 instead of rebuilding from scratch.

       Typical flow:
       1. Local cache hit → use cached artifact (0.1s)
       2. Local miss → Download from S3 (3-5s)
       3. S3 miss → Full build (60-90s)
    ───────────────────────────────────────────────────────────────────────────→
  -->
  <remote enabled="false" id="yawl-s3-cache">

    <!-- S3 endpoint (AWS or MinIO) -->
    <url>${YAWL_S3_ENDPOINT:-s3.amazonaws.com}</url>

    <!-- S3 bucket name (required, set via environment variable) -->
    <bucket>${YAWL_S3_BUCKET}</bucket>

    <!-- AWS region (ignored for MinIO) -->
    <region>${YAWL_S3_REGION:-us-east-1}</region>

    <!-- HTTP transport configuration -->

    <!-- Request timeout (30 seconds) -->
    <timeout>30000</timeout>

    <!-- HTTP/2 support (if available) -->
    <useHttp2>true</useHttp2>

    <!-- AWS S3 or MinIO credentials
         Can be provided via:
         1. Environment variables (AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY)
         2. IAM roles (recommended for CI/CD)
         3. Explicit credentials below (NOT RECOMMENDED)
    -->
    <credentials>
      <!-- AWS Access Key ID (prefer environment variable) -->
      <username>${AWS_ACCESS_KEY_ID}</username>

      <!-- AWS Secret Access Key (prefer environment variable) -->
      <password>${AWS_SECRET_ACCESS_KEY}</password>
    </credentials>

    <!-- Retry policy for failed uploads/downloads -->
    <retry>
      <!-- Max number of retry attempts -->
      <maxAttempts>3</maxAttempts>

      <!-- Base backoff in milliseconds (1s, then 2s, then 4s) -->
      <backoffBase>1000</backoffBase>
    </retry>

    <!-- Upload configuration -->
    <upload>
      <!-- Enable uploads after successful builds -->
      <enabled>true</enabled>

      <!-- Compression algorithm (GZIP by default, 40-50% reduction) -->
      <compression>GZIP</compression>

      <!-- Number of parallel upload streams (8 for faster uploads) -->
      <threads>8</threads>

      <!-- Upload timeout per artifact (30 seconds) -->
      <timeout>30000</timeout>
    </upload>

    <!-- Download configuration -->
    <download>
      <!-- Number of parallel download streams -->
      <threads>4</threads>

      <!-- Download timeout per artifact (10 seconds) -->
      <timeout>10000</timeout>

      <!-- Skip download if timeout (continue to local build) -->
      <timeoutAction>SKIP</timeoutAction>
    </download>

  </remote>

  <!-- ─────────────────────────────────────────────────────────────────────────
       FALLBACK POLICY

       Defines what to do when cache hits fail:
       - Local miss → Try remote cache
       - Remote miss → Execute full build
    ───────────────────────────────────────────────────────────────────────────→
  -->
  <fallbackPolicy>
    <!-- Action when local cache misses: REMOTE (try S3) -->
    <localMiss>REMOTE</localMiss>

    <!-- Action when remote cache misses: BUILD (full compile) -->
    <remoteMiss>BUILD</remoteMiss>
  </fallbackPolicy>

  <!-- ─────────────────────────────────────────────────────────────────────────
       INPUT TRACKING

       Specifies which files to hash for cache key computation.
       Changes to these files invalidate the cache automatically.
    ───────────────────────────────────────────────────────────────────────────→
  -->
  <input>
    <global>
      <!-- Include source files, configuration, dependencies -->
      <glob>{*.java,*.xml,*.properties,*.yaml,*.yml}</glob>

      <!-- Exclude generated files, git, logs -->
      <glob exclude="true">{target/**,.git/**,*.log,*.tmp,*.swp,*~,.DS_Store}</glob>
    </global>

    <!-- Module-specific input tracking (optional) -->
    <module>
      <artifactId>yawl-engine</artifactId>
      <glob>{*.java,*.xml,*.properties}</glob>
    </module>
  </input>

  <!-- ─────────────────────────────────────────────────────────────────────────
       EXECUTION CONTROL

       Specifies which goals always run (cache-bypass goals) and which
       get cached.
    ───────────────────────────────────────────────────────────────────────────→
  -->
  <executionControl>

    <!-- Goals that always run (never cached) -->
    <runAlways>
      <goalLists>
        <!-- Maven clean always executes -->
        <goalsList artifactId="maven-clean-plugin">
          <goals>clean</goals>
        </goalsList>

        <!-- Maven deploy always executes -->
        <goalsList artifactId="maven-deploy-plugin">
          <goals>deploy</goals>
        </goalsList>

        <!-- Maven release always executes -->
        <goalsList artifactId="maven-release-plugin">
          <goals>perform</goals>
        </goalsList>
      </goalLists>
    </runAlways>

    <!-- Reconciliation (logging for cache analytics) -->
    <reconcile>
      <!-- Enable verbose logging for cache hit rate analysis -->
      <logs enabled="true" compression="gzip" />
    </reconcile>

  </executionControl>

  <!-- ─────────────────────────────────────────────────────────────────────────
       PROJECT VERSIONING

       Ensures reproducible builds by adapting cache to project version.
  ───────────────────────────────────────────────────────────────────────────→
  -->
  <projectVersioning adjustMetaInf="true" />

</cache>
