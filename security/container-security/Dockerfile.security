# YAWL Security-Hardened Dockerfile
# Multi-stage build with security best practices
# Based on CIS Docker Benchmark and OWASP recommendations

# ============================================
# Stage 1: Build Stage
# ============================================
FROM eclipse-temurin:25-jdk-alpine AS builder

# Security: Pin package versions for reproducibility
RUN apk add --no-cache --virtual .build-deps \
    maven=3.9.5-r0 \
    git=2.43.0-r0 \
    && rm -rf /var/cache/apk/*

# Create non-root build user
RUN addgroup -S buildgroup -g 1000 && \
    adduser -S builder -u 1000 -G buildgroup

WORKDIR /build

# Copy Maven configuration and source files with proper ownership
COPY --chown=builder:buildgroup pom.xml ./
COPY --chown=builder:buildgroup src ./src
COPY --chown=builder:buildgroup test ./test
COPY --chown=builder:buildgroup build ./build
COPY --chown=builder:buildgroup schema ./schema

# Build as non-root user
USER builder
RUN mvn clean package -DskipTests -B

# ============================================
# Stage 2: Runtime Stage
# ============================================
FROM eclipse-temurin:25-jre-alpine AS runtime

# Security Labels
LABEL org.opencontainers.image.source="https://github.com/yawlfoundation/yawl" \
      org.opencontainers.image.vendor="YAWL Foundation" \
      org.opencontainers.image.version="5.2" \
      org.opencontainers.image.title="YAWL Engine - Security Hardened" \
      org.opencontainers.image.description="YAWL workflow engine with security hardening" \
      security-hardened="true" \
      security-scan-date="2024-01-01"

# Security: Pin package versions and minimize layers
RUN apk add --no-cache --virtual .runtime-deps \
    curl=8.5.0-r0 \
    tzdata=2024a-r0 \
    && rm -rf /var/cache/apk/* \
    && rm -rf /tmp/*

# Security: Create non-root user with fixed UID/GID
RUN addgroup -S yawlgroup -g 10001 && \
    adduser -S yawluser -u 10001 -G yawlgroup -h /app -s /sbin/nologin && \
    mkdir -p /app/logs /app/data /app/config && \
    chown -R yawluser:yawlgroup /app

# Security: Set restrictive umask
RUN echo "umask 027" >> /etc/profile

# Security: Remove unnecessary binaries and set permissions
RUN find /usr -type f -perm /u+s -exec chmod u-s {} \; 2>/dev/null || true && \
    find /usr -type f -perm /g+s -exec chmod g-s {} \; 2>/dev/null || true && \
    chmod 700 /app && \
    chmod 750 /app/logs /app/data /app/config

WORKDIR /app

# Copy built artifacts from builder stage
COPY --from=builder --chown=yawluser:yawlgroup /build/dist /app/dist
COPY --from=builder --chown=yawluser:yawlgroup /build/conf /app/config

# Security: JVM hardening options
ENV JAVA_OPTS="\
    -XX:+UseContainerSupport \
    -XX:MaxRAMPercentage=75.0 \
    -XX:InitialRAMPercentage=50.0 \
    -XX:+UseG1GC \
    -XX:MaxGCPauseMillis=200 \
    -XX:+HeapDumpOnOutOfMemoryError \
    -XX:HeapDumpPath=/app/logs \
    -Djava.security.egd=file:/dev/./urandom \
    -Djava.net.preferIPv4Stack=true \
    -Dfile.encoding=UTF-8 \
    -Djava.security.properties=/app/config/java.security \
    -Dlog4j2.formatMsgNoLookups=true \
    -Dlog4j2.loggerContextFactory=org.apache.logging.log4j.core.impl.Log4jContextFactory \
    --add-opens java.base/java.lang=ALL-UNNAMED \
    --add-opens java.base/java.util=ALL-UNNAMED"

# Security: Environment variables
ENV PATH="/app/dist/bin:${PATH}" \
    LOG_LEVEL="INFO" \
    TZ="UTC" \
    LANG="C.UTF-8" \
    LC_ALL="C.UTF-8"

# Security: Switch to non-root user
USER 10001:10001

# Security: Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8080/yawl/health || exit 1

# Security: Expose only necessary port
EXPOSE 8080

# Security: Use exec form for ENTRYPOINT to ensure signal handling
ENTRYPOINT ["/bin/sh", "-c", "exec java $JAVA_OPTS -jar /app/dist/yawl-engine.jar"]
CMD []

# ============================================
# Stage 3: Distroless (Optional - Most Secure)
# ============================================
FROM gcr.io/distroless/java25-debian12:nonroot AS distroless

# Security: Distroless has no shell, minimal attack surface
# Only suitable for simple JAR deployments

COPY --from=builder --chown=nonroot:nonroot /build/dist/yawl-engine.jar /app/yawl-engine.jar

USER nonroot:nonroot

EXPOSE 8080

HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD ["/bin/java", "-cp", "/app/yawl-engine.jar", "org.yawlfoundation.yawl.engine.YEngine"]

ENTRYPOINT ["/bin/java", "-jar", "/app/yawl-engine.jar"]
