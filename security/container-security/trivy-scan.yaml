# =============================================================================
# YAWL v6.0.0 – Trivy Security Scanner Configuration
# https://aquasecurity.github.io/trivy/
# =============================================================================
# Usage:
#   # Full image scan (CI/CD gate)
#   trivy image --config security/container-security/trivy-scan.yaml \
#     yawl/engine:6.0.0
#
#   # Filesystem scan (source tree, Dockerfiles, IaC)
#   trivy fs --config security/container-security/trivy-scan.yaml .
#
#   # Generate SBOM
#   trivy image --format cyclonedx --output sbom/yawl-engine-6.0.0.cdx.json \
#     yawl/engine:6.0.0
# =============================================================================

# Scanners to activate
scan:
  scanners:
    - vuln        # OS + library CVEs
    - misconfig   # Dockerfile / IaC misconfigurations (Rego policies)
    - secret      # Hardcoded credentials / API keys
    - license     # License compliance (fail on GPL in LGPL project)

  skip-files:
    - "**/test/**"
    - "**/tests/**"
    - "**/.git/**"
    - "**/target/**"
    - "**/.m2/**"

  skip-dirs:
    - target
    - .m2
    - docs
    - performance-reports

# ---------------------------------------------------------------------------
# Vulnerability scanning
# ---------------------------------------------------------------------------
vulnerability:
  type:
    - os        # Alpine apk packages
    - library   # Maven JAR dependencies (via pom.xml / jar manifest)

  # Fail build on unfixed vulnerabilities at HIGH+ severity
  ignore-unfixed: false

  severity:
    - CRITICAL
    - HIGH
    - MEDIUM
    - LOW

  db:
    update: true
    skip-update: false
    # Use GitHub Advisory Database + NVD + OSV
    java-db:
      update: true

  ignore-file: .trivyignore

# ---------------------------------------------------------------------------
# Misconfiguration scanning (Dockerfile, K8s manifests, Helm, Terraform)
# ---------------------------------------------------------------------------
misconfiguration:
  include-non-failures: false
  policy:
    bundle-embedded: true

  # Minimum severity to fail build on misconfig findings
  severity:
    - CRITICAL
    - HIGH

  scanners:
    - dockerfile
    - kubernetes
    - terraform
    - helm

# ---------------------------------------------------------------------------
# Secret scanning
# ---------------------------------------------------------------------------
secret:
  enable: true
  patterns:
    - name: "AWS Access Key"
      regex: "AKIA[0-9A-Z]{16}"
      severity: CRITICAL
    - name: "AWS Secret Key"
      regex: "(?i)aws(.{0,20})?['\"][0-9a-zA-Z/+=]{40}['\"]"
      severity: CRITICAL
    - name: "GCP Service Account Key"
      regex: "\"type\":\\s*\"service_account\""
      severity: CRITICAL
    - name: "Azure Client Secret"
      regex: "(?i)azure(.{0,20})?client.secret.{0,10}['\"][0-9a-zA-Z+/=]{20,}['\"]"
      severity: CRITICAL
    - name: "Private Key (PEM)"
      regex: "-----BEGIN (?:RSA |DSA |EC |OPENSSH )?PRIVATE KEY-----"
      severity: CRITICAL
    - name: "Generic API Key"
      regex: "(?i)(api_key|apikey|api-secret|api_secret)['\"]?\\s*[:=]\\s*['\"]?[a-zA-Z0-9_\\-]{20,}"
      severity: HIGH
    - name: "Database Connection String with Password"
      regex: "(?i)(jdbc|mongodb|postgres|mysql|redis)://[^\\s]+:[^\\s@]+@"
      severity: HIGH
    - name: "JWT Bearer Token"
      regex: "eyJ[a-zA-Z0-9_-]*\\.eyJ[a-zA-Z0-9_-]*\\.[a-zA-Z0-9_-]+"
      severity: MEDIUM
    - name: "YAWL Admin Password (hardcoded)"
      regex: "(?i)yawl.*password.*=.*(?!\\$\\{)"
      severity: HIGH

# ---------------------------------------------------------------------------
# License scanning – enforce LGPL-3.0 compatibility
# ---------------------------------------------------------------------------
license:
  # Packages with these licenses are FORBIDDEN in the distribution JAR
  forbidden:
    - GPL-2.0
    - GPL-3.0
    - AGPL-3.0
    - AGPL-1.0
    - CC-BY-NC-4.0
    - SSPL-1.0
  # Warn on these
  notice:
    - LGPL-2.0
    - LGPL-2.1
    - MPL-1.1
    - CDDL-1.0

# ---------------------------------------------------------------------------
# Output configuration
# ---------------------------------------------------------------------------
format:
  type: table    # table | json | sarif | cyclonedx | spdx-json | github

report:
  # Non-zero exit on findings at or above this severity
  exit-code: 1
  severity: HIGH

# ---------------------------------------------------------------------------
# Registry mirrors (replace with your internal registry)
# ---------------------------------------------------------------------------
registry:
  mirrors: {}
  auths: {}

# ---------------------------------------------------------------------------
# Local cache
# ---------------------------------------------------------------------------
cache:
  enable: true
  dir: /tmp/trivy-cache
  ttl: 24h

# ---------------------------------------------------------------------------
# SBOM output (CycloneDX JSON + SPDX JSON)
# Generated separately via CI pipeline – see .github/workflows/security.yml
# ---------------------------------------------------------------------------
sbom:
  enable: true
  format: cyclonedx    # primary format
  output: sbom/yawl-engine.cdx.json
