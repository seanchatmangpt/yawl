{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "description": "Azure Backup & Disaster Recovery ARM Templates - Multi-region backup strategy",
    "rto": "25-35 minutes",
    "rpo": "15-20 minutes",
    "author": "DevOps Team",
    "lastUpdated": "2026-02-14"
  },
  "parameters": {
    "projectPrefix": {
      "type": "string",
      "defaultValue": "prod",
      "metadata": {
        "description": "Prefix for resource names"
      }
    },
    "primaryRegion": {
      "type": "string",
      "defaultValue": "eastus",
      "metadata": {
        "description": "Primary Azure region"
      }
    },
    "backupRegion": {
      "type": "string",
      "defaultValue": "westus2",
      "metadata": {
        "description": "Backup Azure region for disaster recovery"
      }
    },
    "backupRetentionDays": {
      "type": "int",
      "defaultValue": 30,
      "metadata": {
        "description": "Number of days to retain backups"
      }
    },
    "environment": {
      "type": "string",
      "defaultValue": "production",
      "allowedValues": [
        "development",
        "staging",
        "production"
      ],
      "metadata": {
        "description": "Environment name"
      }
    },
    "rtoMinutes": {
      "type": "int",
      "defaultValue": 25,
      "metadata": {
        "description": "Recovery Time Objective in minutes"
      }
    },
    "rpoMinutes": {
      "type": "int",
      "defaultValue": 15,
      "metadata": {
        "description": "Recovery Point Objective in minutes"
      }
    }
  },
  "variables": {
    "location": "[parameters('primaryRegion')]",
    "backupLocation": "[parameters('backupRegion')]",
    "resourceGroupName": "[resourceGroup().name]",
    "timestamp": "[utcNow('u')]",
    "tags": {
      "environment": "[parameters('environment')]",
      "backupStrategy": "cross-region",
      "rto": "[format('{0} minutes', parameters('rtoMinutes'))]",
      "rpo": "[format('{0} minutes', parameters('rpoMinutes'))]",
      "createdDate": "[variables('timestamp')]"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2021-09-01",
      "name": "[format('{0}storage{1}primary', parameters('projectPrefix'), uniqueString(resourceGroup().id))]",
      "location": "[variables('location')]",
      "tags": "[variables('tags')]",
      "kind": "StorageV2",
      "sku": {
        "name": "Standard_GRS"
      },
      "properties": {
        "accessTier": "Hot",
        "minimumTlsVersion": "TLS1_2",
        "supportsHttpsTrafficOnly": true,
        "allowBlobPublicAccess": false,
        "networkAcls": {
          "bypass": "AzureServices",
          "defaultAction": "Deny"
        },
        "encryption": {
          "keySource": "Microsoft.Storage"
        }
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
      "apiVersion": "2021-09-01",
      "name": "[format('{0}{1}/{2}/{3}', format('{0}storage{1}primary', parameters('projectPrefix'), uniqueString(resourceGroup().id)), 'default', 'backups')]",
      "properties": {
        "publicAccess": "None"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', format('{0}storage{1}primary', parameters('projectPrefix'), uniqueString(resourceGroup().id)))]"
      ]
    },
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2021-09-01",
      "name": "[format('{0}storage{1}backup', parameters('projectPrefix'), uniqueString(resourceGroup().id))]",
      "location": "[variables('backupLocation')]",
      "tags": "[variables('tags')]",
      "kind": "StorageV2",
      "sku": {
        "name": "Standard_ZRS"
      },
      "properties": {
        "accessTier": "Cool",
        "minimumTlsVersion": "TLS1_2",
        "supportsHttpsTrafficOnly": true,
        "allowBlobPublicAccess": false,
        "networkAcls": {
          "bypass": "AzureServices",
          "defaultAction": "Deny"
        }
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
      "apiVersion": "2021-09-01",
      "name": "[format('{0}{1}/{2}/{3}', format('{0}storage{1}backup', parameters('projectPrefix'), uniqueString(resourceGroup().id)), 'default', 'backups')]",
      "properties": {
        "publicAccess": "None"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', format('{0}storage{1}backup', parameters('projectPrefix'), uniqueString(resourceGroup().id)))]"
      ]
    },
    {
      "type": "Microsoft.RecoveryServices/vaults",
      "apiVersion": "2021-11-01-preview",
      "name": "[format('{0}-backup-vault-{1}', parameters('projectPrefix'), variables('location'))]",
      "location": "[variables('location')]",
      "tags": "[variables('tags')]",
      "sku": {
        "name": "RS0",
        "tier": "Standard"
      },
      "properties": {
        "publicNetworkAccess": "Enabled",
        "monitoringSettings": {
          "classicAlertSettings": {
            "alertsForCriticalOperations": "Enabled"
          },
          "azureMonitorAlertSettings": {
            "alertsForAllJobFailures": "Enabled"
          }
        },
        "redundancySettings": {
          "crossRegionRestoreFlag": true,
          "standardTierStorageRedundancy": "GeoRedundant"
        }
      }
    },
    {
      "type": "Microsoft.RecoveryServices/vaults/backupConfig",
      "apiVersion": "2021-11-01-preview",
      "name": "[format('{0}-backup-vault-{1}/vaultconfig', parameters('projectPrefix'), variables('location'))]",
      "properties": {
        "enhancedSecurityState": "Enabled",
        "softDeleteFeatureState": "AlwaysOn",
        "resourceGuardOperationRequests": []
      },
      "dependsOn": [
        "[resourceId('Microsoft.RecoveryServices/vaults', format('{0}-backup-vault-{1}', parameters('projectPrefix'), variables('location')))]"
      ]
    },
    {
      "type": "Microsoft.RecoveryServices/vaults/backupPolicies",
      "apiVersion": "2021-11-01-preview",
      "name": "[format('{0}-backup-vault-{1}/DailyPolicy', parameters('projectPrefix'), variables('location'))]",
      "properties": {
        "backupManagementType": "AzureIaasVM",
        "instantRpRetentionRangeInDays": 5,
        "schedulePolicy": {
          "schedulePolicyType": "SimpleSchedulePolicy",
          "scheduleRunFrequency": "Daily",
          "scheduleRunTimes": [
            "2026-02-14T03:00:00Z"
          ],
          "scheduleWeeklyFrequency": 0
        },
        "retentionPolicy": {
          "retentionPolicyType": "LongTermRetentionPolicy",
          "dailySchedule": {
            "retentionTimes": [
              "2026-02-14T03:00:00Z"
            ],
            "retentionDuration": {
              "count": "[parameters('backupRetentionDays')]",
              "durationType": "Days"
            }
          },
          "weeklySchedule": {
            "daysOfTheWeek": [
              "Sunday"
            ],
            "retentionTimes": [
              "2026-02-14T03:00:00Z"
            ],
            "retentionDuration": {
              "count": 5,
              "durationType": "Weeks"
            }
          },
          "monthlySchedule": {
            "retentionScheduleFormatType": "Daily",
            "retentionScheduleDaily": {
              "daysOfTheMonth": [
                1
              ]
            },
            "retentionTimes": [
              "2026-02-14T03:00:00Z"
            ],
            "retentionDuration": {
              "count": 12,
              "durationType": "Months"
            }
          },
          "yearlySchedule": {
            "retentionScheduleFormatType": "Daily",
            "monthsOfYear": [
              "January"
            ],
            "retentionScheduleDaily": {
              "daysOfTheMonth": [
                1
              ]
            },
            "retentionTimes": [
              "2026-02-14T03:00:00Z"
            ],
            "retentionDuration": {
              "count": 7,
              "durationType": "Years"
            }
          }
        },
        "timeZone": "UTC"
      },
      "dependsOn": [
        "[resourceId('Microsoft.RecoveryServices/vaults', format('{0}-backup-vault-{1}', parameters('projectPrefix'), variables('location')))]"
      ]
    },
    {
      "type": "Microsoft.Sql/servers",
      "apiVersion": "2019-06-01-preview",
      "name": "[format('{0}-sql-primary', parameters('projectPrefix'))]",
      "location": "[variables('location')]",
      "tags": "[variables('tags')]",
      "properties": {
        "administratorLogin": "sqladmin",
        "administratorLoginPassword": "[uniqueString(resourceGroup().id, variables('timestamp'))]",
        "version": "12.0",
        "minimalTlsVersion": "1.2",
        "publicNetworkAccess": "Enabled"
      }
    },
    {
      "type": "Microsoft.Sql/servers/databases",
      "apiVersion": "2019-06-01-preview",
      "name": "[format('{0}-sql-primary/productiondb', parameters('projectPrefix'))]",
      "location": "[variables('location')]",
      "tags": "[variables('tags')]",
      "sku": {
        "name": "S2",
        "tier": "Standard"
      },
      "properties": {
        "collation": "SQL_Latin1_General_CP1_CI_AS",
        "maxSizeBytes": 268435456000,
        "zoneRedundant": true,
        "readReplicaCount": 0,
        "requestedBackupStorageRedundancy": "Geo",
        "minCapacity": 2
      },
      "dependsOn": [
        "[resourceId('Microsoft.Sql/servers', format('{0}-sql-primary', parameters('projectPrefix')))]"
      ]
    },
    {
      "type": "Microsoft.Sql/servers/databases/backupShortTermRetentionPolicies",
      "apiVersion": "2017-10-01-preview",
      "name": "[format('{0}-sql-primary/productiondb/default', parameters('projectPrefix'))]",
      "properties": {
        "retentionDays": "[parameters('backupRetentionDays')]",
        "diffBackupIntervalInHours": 24
      },
      "dependsOn": [
        "[resourceId('Microsoft.Sql/servers/databases', format('{0}-sql-primary/productiondb', parameters('projectPrefix')))]"
      ]
    },
    {
      "type": "Microsoft.Sql/servers/databases/backupLongTermRetentionPolicies",
      "apiVersion": "2017-10-01-preview",
      "name": "[format('{0}-sql-primary/productiondb/default', parameters('projectPrefix'))]",
      "properties": {
        "weeklyRetention": "P4W",
        "monthlyRetention": "P12M",
        "yearlyRetention": "P5Y",
        "weekOfYear": 1
      },
      "dependsOn": [
        "[resourceId('Microsoft.Sql/servers/databases', format('{0}-sql-primary/productiondb', parameters('projectPrefix')))]"
      ]
    },
    {
      "type": "Microsoft.Sql/servers/databases/geoBackupPolicies",
      "apiVersion": "2014-04-01",
      "name": "[format('{0}-sql-primary/productiondb/default', parameters('projectPrefix'))]",
      "properties": {
        "state": "Enabled"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Sql/servers/databases', format('{0}-sql-primary/productiondb', parameters('projectPrefix')))]"
      ]
    },
    {
      "type": "Microsoft.DBforMySQL/servers",
      "apiVersion": "2017-12-01",
      "name": "[format('{0}-mysql-primary', parameters('projectPrefix'))]",
      "location": "[variables('location')]",
      "tags": "[variables('tags')]",
      "sku": {
        "name": "B_Gen5_2",
        "tier": "Basic",
        "capacity": 2,
        "family": "Gen5"
      },
      "properties": {
        "createMode": "Default",
        "version": "8.0",
        "administratorLogin": "mysqladmin",
        "administratorLoginPassword": "[uniqueString(resourceGroup().id, variables('timestamp'))]",
        "sslEnforcement": "ENABLED",
        "minimalTlsVersion": "TLS1_2",
        "backupRetentionDays": "[parameters('backupRetentionDays')]",
        "geoRedundantBackup": "Enabled",
        "storageProfile": {
          "storageMB": 51200,
          "backupRetentionDays": "[parameters('backupRetentionDays')]",
          "geoRedundantBackup": "Enabled",
          "storageAutogrow": "Enabled"
        }
      }
    },
    {
      "type": "Microsoft.DBforPostgreSQL/servers",
      "apiVersion": "2017-12-01",
      "name": "[format('{0}-postgres-primary', parameters('projectPrefix'))]",
      "location": "[variables('location')]",
      "tags": "[variables('tags')]",
      "sku": {
        "name": "B_Gen5_2",
        "tier": "Basic",
        "capacity": 2,
        "family": "Gen5"
      },
      "properties": {
        "createMode": "Default",
        "version": "13",
        "administratorLogin": "pgadmin",
        "administratorLoginPassword": "[uniqueString(resourceGroup().id, variables('timestamp'))]",
        "sslEnforcement": "ENABLED",
        "minimalTlsVersion": "TLS1_2",
        "backupRetentionDays": "[parameters('backupRetentionDays')]",
        "geoRedundantBackup": "Enabled",
        "storageProfile": {
          "storageMB": 51200,
          "backupRetentionDays": "[parameters('backupRetentionDays')]",
          "geoRedundantBackup": "Enabled",
          "storageAutogrow": "Enabled"
        }
      }
    },
    {
      "type": "Microsoft.Compute/images",
      "apiVersion": "2021-03-01",
      "name": "[format('{0}-vm-image', parameters('projectPrefix'))]",
      "location": "[variables('location')]",
      "tags": "[variables('tags')]",
      "properties": {
        "storageProfile": {
          "osDisk": {
            "osType": "Linux",
            "osState": "Generalized",
            "blobUri": "https://example.blob.core.windows.net/vhds/example.vhd"
          }
        }
      }
    },
    {
      "type": "Microsoft.Compute/disks",
      "apiVersion": "2021-03-01",
      "name": "[format('{0}-backup-disk-snapshot', parameters('projectPrefix'))]",
      "location": "[variables('location')]",
      "tags": "[variables('tags')]",
      "sku": {
        "name": "Premium_LRS"
      },
      "properties": {
        "creationData": {
          "createOption": "Empty"
        },
        "diskSizeGB": 256,
        "diskEncryptionSet": {
          "id": "[resourceId('Microsoft.Compute/diskEncryptionSets', format('{0}-des', parameters('projectPrefix')))]"
        }
      }
    },
    {
      "type": "Microsoft.Compute/snapshots",
      "apiVersion": "2021-03-01",
      "name": "[format('{0}-vm-snapshot-{1}', parameters('projectPrefix'), variables('timestamp'))]",
      "location": "[variables('location')]",
      "tags": "[variables('tags')]",
      "properties": {
        "creationData": {
          "createOption": "Copy",
          "sourceResourceId": "[resourceId('Microsoft.Compute/disks', format('{0}-backup-disk-snapshot', parameters('projectPrefix')))]"
        },
        "diskEncryptionSet": {
          "id": "[resourceId('Microsoft.Compute/diskEncryptionSets', format('{0}-des', parameters('projectPrefix')))]"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Compute/disks', format('{0}-backup-disk-snapshot', parameters('projectPrefix')))]"
      ]
    },
    {
      "type": "Microsoft.Compute/diskEncryptionSets",
      "apiVersion": "2021-03-01",
      "name": "[format('{0}-des', parameters('projectPrefix'))]",
      "location": "[variables('location')]",
      "tags": "[variables('tags')]",
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "activeKey": {
          "sourceVault": {
            "id": "[resourceId('Microsoft.KeyVault/vaults', format('{0}-kv', parameters('projectPrefix')))]"
          },
          "keyUrl": "https://example.vault.azure.net/keys/key1/version"
        }
      }
    },
    {
      "type": "Microsoft.KeyVault/vaults",
      "apiVersion": "2021-06-01-preview",
      "name": "[format('{0}-kv', parameters('projectPrefix'))]",
      "location": "[variables('location')]",
      "tags": "[variables('tags')]",
      "properties": {
        "enabledForDeployment": true,
        "enabledForTemplateDeployment": true,
        "enabledForDiskEncryption": true,
        "tenantId": "[subscription().tenantId]",
        "sku": {
          "name": "standard",
          "family": "A"
        },
        "accessPolicies": [],
        "networkAcls": {
          "bypass": "AzureServices",
          "defaultAction": "Deny"
        }
      }
    },
    {
      "type": "Microsoft.KeyVault/vaults/keys",
      "apiVersion": "2021-06-01-preview",
      "name": "[format('{0}-kv/backup-encryption-key', parameters('projectPrefix'))]",
      "properties": {
        "kty": "RSA",
        "keySize": 4096,
        "keyOps": [
          "encrypt",
          "decrypt",
          "sign",
          "verify",
          "wrapKey",
          "unwrapKey"
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', format('{0}-kv', parameters('projectPrefix')))]"
      ]
    },
    {
      "type": "Microsoft.RecoveryServices/vaults/replicationFabrics",
      "apiVersion": "2018-07-10",
      "name": "[format('{0}-backup-vault-{1}/{2}-fabric', parameters('projectPrefix'), variables('location'), variables('location'))]",
      "properties": {},
      "dependsOn": [
        "[resourceId('Microsoft.RecoveryServices/vaults', format('{0}-backup-vault-{1}', parameters('projectPrefix'), variables('location')))]"
      ]
    },
    {
      "type": "Microsoft.Insights/diagnosticSettings",
      "apiVersion": "2017-05-01-preview",
      "name": "[format('{0}-backup-vault-{1}-diagnostics', parameters('projectPrefix'), variables('location'))]",
      "scope": "[resourceId('Microsoft.RecoveryServices/vaults', format('{0}-backup-vault-{1}', parameters('projectPrefix'), variables('location')))]",
      "properties": {
        "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-law', parameters('projectPrefix')))]",
        "logs": [
          {
            "category": "AzureBackupReport",
            "enabled": true
          },
          {
            "category": "CoreAzureBackup",
            "enabled": true
          },
          {
            "category": "AddonAzureBackupProtectedInstance",
            "enabled": true
          },
          {
            "category": "AddonAzureBackupJobs",
            "enabled": true
          },
          {
            "category": "AddonAzureBackupAlerts",
            "enabled": true
          }
        ],
        "metrics": [
          {
            "category": "Health",
            "enabled": true
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.RecoveryServices/vaults', format('{0}-backup-vault-{1}', parameters('projectPrefix'), variables('location')))]",
        "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-law', parameters('projectPrefix')))]"
      ]
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2021-06-01",
      "name": "[format('{0}-law', parameters('projectPrefix'))]",
      "location": "[variables('location')]",
      "tags": "[variables('tags')]",
      "properties": {
        "sku": {
          "name": "PerGB2018"
        },
        "retentionInDays": "[parameters('backupRetentionDays')]",
        "publicNetworkAccessForIngestion": "Enabled",
        "publicNetworkAccessForQuery": "Enabled"
      }
    },
    {
      "type": "Microsoft.Insights/actionGroups",
      "apiVersion": "2021-09-01",
      "name": "[format('{0}-backup-alerts-ag', parameters('projectPrefix'))]",
      "location": "global",
      "tags": "[variables('tags')]",
      "properties": {
        "groupShortName": "BackupAlerts",
        "enabled": true,
        "emailReceivers": [
          {
            "name": "Backup Team",
            "emailAddress": "backup-team@example.com",
            "useCommonAlertSchema": true
          }
        ]
      }
    },
    {
      "type": "Microsoft.Insights/metricAlerts",
      "apiVersion": "2018-03-01",
      "name": "[format('{0}-backup-failure-alert', parameters('projectPrefix'))]",
      "location": "global",
      "tags": "[variables('tags')]",
      "properties": {
        "description": "Alert when backup job fails",
        "severity": 0,
        "enabled": true,
        "scopes": [
          "[resourceId('Microsoft.RecoveryServices/vaults', format('{0}-backup-vault-{1}', parameters('projectPrefix'), variables('location')))]"
        ],
        "evaluationFrequency": "PT5M",
        "windowSize": "PT15M",
        "criteria": {
          "odata.type": "Microsoft.Azure.Monitor.MultipleResourceMultipleMetricCriteria",
          "allOf": [
            {
              "name": "BackupJobsFailed",
              "metricName": "BackupJobsFailed",
              "metricNamespace": "Microsoft.RecoveryServices/vaults",
              "operator": "GreaterThan",
              "timeAggregation": "Total",
              "threshold": 0,
              "skipMetricValidation": false
            }
          ]
        },
        "actions": [
          {
            "actionGroupId": "[resourceId('Microsoft.Insights/actionGroups', format('{0}-backup-alerts-ag', parameters('projectPrefix')))]"
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.RecoveryServices/vaults', format('{0}-backup-vault-{1}', parameters('projectPrefix'), variables('location')))]",
        "[resourceId('Microsoft.Insights/actionGroups', format('{0}-backup-alerts-ag', parameters('projectPrefix')))]"
      ]
    }
  ],
  "outputs": {
    "primaryVaultId": {
      "type": "string",
      "value": "[resourceId('Microsoft.RecoveryServices/vaults', format('{0}-backup-vault-{1}', parameters('projectPrefix'), variables('location')))]",
      "metadata": {
        "description": "ID of the primary backup vault"
      }
    },
    "primaryStorageAccount": {
      "type": "string",
      "value": "[format('{0}storage{1}primary', parameters('projectPrefix'), uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "Primary storage account name"
      }
    },
    "backupStorageAccount": {
      "type": "string",
      "value": "[format('{0}storage{1}backup', parameters('projectPrefix'), uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "Backup storage account name"
      }
    },
    "rtoMinutes": {
      "type": "int",
      "value": "[parameters('rtoMinutes')]",
      "metadata": {
        "description": "Recovery Time Objective in minutes"
      }
    },
    "rpoMinutes": {
      "type": "int",
      "value": "[parameters('rpoMinutes')]",
      "metadata": {
        "description": "Recovery Point Objective in minutes"
      }
    },
    "sqlDatabaseName": {
      "type": "string",
      "value": "productiondb",
      "metadata": {
        "description": "SQL Database name"
      }
    },
    "keyVaultId": {
      "type": "string",
      "value": "[resourceId('Microsoft.KeyVault/vaults', format('{0}-kv', parameters('projectPrefix')))]",
      "metadata": {
        "description": "Key Vault ID for encryption key management"
      }
    },
    "logAnalyticsWorkspaceId": {
      "type": "string",
      "value": "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-law', parameters('projectPrefix')))]",
      "metadata": {
        "description": "Log Analytics Workspace ID for monitoring and auditing"
      }
    }
  }
}
