# =============================================================================
# YAWL v6.0.0 - Alertmanager Configuration
# =============================================================================
# Comprehensive alert routing and notification configuration.
#
# Apply:
#   kubectl apply -f monitoring/alertmanager/alertmanager-config.yaml -n monitoring
# =============================================================================
apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: yawl-alertmanager-config
  namespace: monitoring
  labels:
    app.kubernetes.io/name: alertmanager
    app.kubernetes.io/component: config
    app.kubernetes.io/part-of: yawl-platform
spec:
  route:
    groupBy:
      - alertname
      - namespace
      - severity
    groupWait: 30s
    groupInterval: 5m
    repeatInterval: 4h
    receiver: yawl-team
    routes:
      # Critical alerts - immediate notification
      - match:
          severity: critical
        receiver: yawl-critical
        groupWait: 10s
        repeatInterval: 1h
        continue: true

      # Warning alerts - standard notification
      - match:
          severity: warning
        receiver: yawl-team
        groupWait: 5m
        repeatInterval: 4h

      # Database alerts
      - match:
          component: database
        receiver: dba-team
        routes:
          - match:
              severity: critical
            receiver: dba-critical

      # Security alerts
      - match:
          category: security
        receiver: security-team
        groupWait: 0s
        repeatInterval: 1h

  receivers:
    # Default team receiver
    - name: yawl-team
      slackConfigs:
        - channel: '#yawl-alerts'
          sendResolved: true
          title: '{{ template "slack.title" . }}'
          text: '{{ template "slack.text" . }}'
          color: '{{ if eq .Status "firing" }}{{ if eq .CommonLabels.severity "critical" }}danger{{ else }}warning{{ end }}{{ else }}good{{ end }}'
          username: 'YAWL Alertmanager'
          iconEmoji: ':yawl:'
          linkNames: false

    # Critical alerts receiver
    - name: yawl-critical
      slackConfigs:
        - channel: '#yawl-critical'
          sendResolved: true
          title: 'CRITICAL: {{ template "slack.title" . }}'
          text: '{{ template "slack.text" . }}'
          color: 'danger'
      pagerdutyConfigs:
        - serviceKey:
            name: pagerduty-yawl-key
            key: service-key
          severity: critical
          description: '{{ .CommonLabels.alertname }}'
          details:
            firing: '{{ template "pagerduty.default.instances" .Alerts.Firing }}'
            resolved: '{{ template "pagerduty.default.instances" .Alerts.Resolved }}'
            num_firing: '{{ .Alerts.Firing | len }}'
            num_resolved: '{{ .Alerts.Resolved | len }}'

    # Database team receiver
    - name: dba-team
      slackConfigs:
        - channel: '#dba-alerts'
          sendResolved: true
          title: 'DB Alert: {{ .CommonLabels.alertname }}'
          text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'

    - name: dba-critical
      slackConfigs:
        - channel: '#dba-critical'
          sendResolved: true
      pagerdutyConfigs:
        - serviceKey:
            name: pagerduty-dba-key
            key: service-key

    # Security team receiver
    - name: security-team
      slackConfigs:
        - channel: '#security-alerts'
          sendResolved: true
          title: 'SECURITY: {{ .CommonLabels.alertname }}'
          text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'

  inhibitRules:
    # If critical is firing, inhibit warning
    - sourceMatch:
        severity: critical
      targetMatch:
        severity: warning
      equal: [alertname, namespace]

    # If node is down, inhibit all alerts from that node
    - sourceMatch:
        alertname: NodeDown
      targetMatchRe:
        alertname: .*
      equal: [instance]

    # If database is down, inhibit database-related alerts
    - sourceMatch:
        alertname: YAWLDatabaseConnectionPoolExhausted
      targetMatch:
        component: database
      equal: [namespace]

---
# =============================================================================
# Alertmanager Templates
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-templates
  namespace: monitoring
  labels:
    app.kubernetes.io/name: alertmanager
    app.kubernetes.io/component: templates
data:
  slack.tmpl: |
    {{ define "slack.title" }}
    [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .CommonLabels.alertname }}
    {{ end }}

    {{ define "slack.text" }}
    {{ range .Alerts }}
    *Alert:* {{ .Labels.alertname }}
    *Severity:* {{ .Labels.severity }}
    *Namespace:* {{ .Labels.namespace }}
    *Description:* {{ .Annotations.description }}
    *Started:* {{ .StartsAt.Format "2006-01-02 15:04:05 UTC" }}
    {{ if .EndsAt }}
    *Ended:* {{ .EndsAt.Format "2006-01-02 15:04:05 UTC" }}
    {{ end }}
    *Details:*
    {{ range .Labels.SortedPairs }} â€¢ *{{ .Name }}:* {{ .Value }}
    {{ end }}

    {{ end }}
    {{ end }}

  pagerduty.tmpl: |
    {{ define "pagerduty.default.instances" }}
    {{ range . }}{{ .Labels.instance }} {{ end }}
    {{ end }}

---
# =============================================================================
# Alertmanager Main Configuration Secret
# =============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-yawl
  namespace: monitoring
  labels:
    app.kubernetes.io/name: alertmanager
    app.kubernetes.io/component: config
stringData:
  alertmanager.yaml: |
    global:
      resolve_timeout: 5m
      smtp_smarthost: 'smtp.example.com:587'
      smtp_from: 'alerts@yawl.example.com'
      smtp_require_tls: true

    templates:
      - '/etc/alertmanager/templates/*.tmpl'

    route:
      group_by: ['alertname', 'namespace', 'severity']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h
      receiver: 'yawl-team'

    receivers:
      - name: 'yawl-team'
        slack_configs:
          - api_url: 'https://hooks.slack.com/services/xxx/yyy/zzz'
            channel: '#yawl-alerts'
            send_resolved: true
            title: '{{ template "slack.title" . }}'
            text: '{{ template "slack.text" . }}'

      - name: 'yawl-critical'
        slack_configs:
          - api_url: 'https://hooks.slack.com/services/xxx/yyy/zzz'
            channel: '#yawl-critical'
            send_resolved: true
        pagerduty_configs:
          - service_key: '<pagerduty-service-key>'
            severity: critical

    inhibit_rules:
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['alertname', 'namespace']
