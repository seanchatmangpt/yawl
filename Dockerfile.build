# =============================================================================
# YAWL Build Image - Builds YAWL from source using Maven and Java 25
# =============================================================================
FROM eclipse-temurin:25-jdk-alpine AS builder

LABEL stage=builder

# Install Maven and dependencies
RUN apk add --no-cache \
    maven \
    curl \
    && rm -rf /var/cache/apk/*

WORKDIR /build

# Copy Maven configuration and source files
COPY pom.xml ./
COPY src/ ./src/
COPY test/ ./test/
COPY schema/ ./schema/
COPY build/ ./build/

# Build YAWL with Maven
RUN mvn clean package -DskipTests -B

# =============================================================================
# YAWL Runtime Image
# =============================================================================
FROM eclipse-temurin:25-jre-alpine AS runtime

ARG SERVICE=engine

# Install dependencies
RUN apk add --no-cache curl bash

# Create user
RUN addgroup -S yawl && adduser -S yawl -G yawl

# Create directories
RUN mkdir -p /yawl /opt/tomcat /data && chown -R yawl:yawl /yawl /opt/tomcat /data

# Download Tomcat 9.0.89
RUN curl -fsSL "https://archive.apache.org/dist/tomcat/tomcat-9/v9.0.89/bin/apache-tomcat-9.0.89.tar.gz" \
    | tar -xzf - -C /opt/tomcat --strip-components=1 && \
    rm -rf /opt/tomcat/webapps/* && \
    chown -R yawl:yawl /opt/tomcat

# Copy built WAR from builder (Maven packages to target/)
COPY --from=builder --chown=yawl:yawl /build/target/*.war /opt/tomcat/webapps/ROOT.war

# Environment
ENV CATALINA_HOME=/opt/tomcat \
    JAVA_OPTS="-Xms512m -Xmx1024m -XX:+UseG1GC" \
    DB_TYPE=postgres \
    DB_HOST=postgres \
    DB_PORT=5432 \
    DB_NAME=yawl \
    DB_USER=yawl \
    DB_PASSWORD=yawl

USER yawl
WORKDIR /yawl

EXPOSE 8080

HEALTHCHECK --interval=30s --timeout=10s --start-period=90s --retries=3 \
    CMD curl -f http://localhost:8080/ || exit 1

CMD ["/opt/tomcat/bin/catalina.sh", "run"]
