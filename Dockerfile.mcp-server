# YAWL MCP Server Container
# Builds the YawlMcpServer with the official MCP Java SDK 0.17.2.
# Runs on Java 25 with virtual threads for scalable STDIO transport.
#
# Build args:
#   JAVA_VERSION - JDK version (default: 25)
#   IMAGE_TAG    - Image tag / VCS reference

ARG JAVA_VERSION=25
FROM eclipse-temurin:${JAVA_VERSION}-jre-noble AS base

ARG IMAGE_TAG=dev
LABEL org.opencontainers.image.title="YAWL MCP Server" \
      org.opencontainers.image.description="YAWL Model Context Protocol server - 15 workflow tools, 3 resources, 4 prompts" \
      org.opencontainers.image.version="${IMAGE_TAG}" \
      org.opencontainers.image.vendor="YAWL Foundation" \
      org.opencontainers.image.source="https://github.com/yawlfoundation/yawl"

# Create non-root user
RUN groupadd -r yawl --gid=1000 && \
    useradd -r -g yawl --uid=1000 --home-dir=/opt/yawl --shell=/bin/false yawl

WORKDIR /opt/yawl

# Copy the integration JAR (built by Maven in CI)
COPY target/yawl-*.jar app.jar

# Copy entrypoint script
COPY --chmod=755 scripts/docker/mcp-server-entrypoint.sh entrypoint.sh

# Expose health port (HTTP proxy wraps STDIO MCP for k8s probes)
EXPOSE 8082

USER yawl

# JVM flags: virtual threads + compact object headers + ZGC
ENV JAVA_OPTS="-Xms256m -Xmx768m \
    -XX:+UseZGC -XX:+ZGenerational \
    -XX:+UseCompactObjectHeaders \
    --enable-preview \
    -Djava.awt.headless=true \
    -Djdk.tracePinnedThreads=short"

ENTRYPOINT ["./entrypoint.sh"]

HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8082/health || exit 1
