# YAWL v6.0.0-Alpha - Modernized Multi-Stage Docker Build (Java 25)
#
# Features:
# - Multi-stage build (build stage + runtime stage)
# - JDK 25 for build, JRE 25 for runtime (smaller image)
# - Virtual threads support (Java 25 native, no preview flags)
# - Health checks for container orchestration (multi-strategy)
# - Non-root user for security (UID/GID 1000)
# - Optimized layer caching for faster rebuilds
# - Optimized JVM settings for containers (ZGC generational)
# - Minimal attack surface with Alpine base
# - OCI image labels for container metadata

# ============================================================================
# Build Stage - Optimized for Layer Caching
# ============================================================================
FROM eclipse-temurin:25-jdk-alpine AS builder

LABEL stage=builder
ARG MAVEN_VERSION=3.9.9

# Install build dependencies in single layer (cached separately)
RUN apk add --no-cache \
    curl \
    tar \
    git \
    && curl -fsSL https://archive.apache.org/dist/maven/maven-3/${MAVEN_VERSION}/binaries/apache-maven-${MAVEN_VERSION}-bin.tar.gz \
    | tar -xzf - -C /opt \
    && ln -s /opt/apache-maven-${MAVEN_VERSION}/bin/mvn /usr/local/bin/mvn \
    && rm -rf /var/cache/apk/* /tmp/*

WORKDIR /build

# Layer 1: Copy pom files for dependency caching (most stable layer)
COPY pom.xml ./
COPY yawl-utilities/pom.xml ./yawl-utilities/
COPY yawl-elements/pom.xml ./yawl-elements/
COPY yawl-authentication/pom.xml ./yawl-authentication/
COPY yawl-engine/pom.xml ./yawl-engine/
COPY yawl-stateless/pom.xml ./yawl-stateless/
COPY yawl-resourcing/pom.xml ./yawl-resourcing/
COPY yawl-worklet/pom.xml ./yawl-worklet/
COPY yawl-scheduling/pom.xml ./yawl-scheduling/
COPY yawl-integration/pom.xml ./yawl-integration/
COPY yawl-monitoring/pom.xml ./yawl-monitoring/
COPY yawl-webapps/pom.xml ./yawl-webapps/
COPY yawl-control-panel/pom.xml ./yawl-control-panel/

# Layer 2: Download dependencies (cached if poms unchanged)
RUN mvn dependency:go-offline -B --no-transfer-progress || true

# Layer 3: Copy source code (changes frequently - last layer)
COPY src ./src
COPY test ./test
COPY build ./build
COPY schema ./schema
COPY yawl-utilities ./yawl-utilities
COPY yawl-elements ./yawl-elements
COPY yawl-authentication ./yawl-authentication
COPY yawl-engine ./yawl-engine
COPY yawl-stateless ./yawl-stateless
COPY yawl-resourcing ./yawl-resourcing
COPY yawl-worklet ./yawl-worklet
COPY yawl-scheduling ./yawl-scheduling
COPY yawl-integration ./yawl-integration
COPY yawl-monitoring ./yawl-monitoring
COPY yawl-webapps ./yawl-webapps
COPY yawl-control-panel ./yawl-control-panel

# Build with Maven (skip test compilation and execution in Docker build, run in CI)
# Use -Dmaven.test.skip=true to skip both compilation and execution
# This is necessary because test sources reference classes across modules
RUN mvn clean package -Dmaven.test.skip=true -B --no-transfer-progress

# ============================================================================
# Runtime Stage - Minimal JRE with Health Checks
# ============================================================================
FROM eclipse-temurin:25-jre-alpine AS runtime

# Build arguments for labels
ARG VERSION=6.0.0-Alpha
ARG BUILD_DATE
ARG VCS_REF
ARG MAINTAINER="YAWL Foundation <info@yawlfoundation.org>"

# OCI Image Labels (https://github.com/opencontainers/image-spec/blob/main/annotations.md)
LABEL maintainer="${MAINTAINER}"
LABEL org.opencontainers.image.title="YAWL Workflow Engine"
LABEL org.opencontainers.image.description="YAWL v6.0.0-Alpha - Yet Another Workflow Language with Petri Net semantics, Virtual Threads, and Cloud-Native support"
LABEL org.opencontainers.image.version="${VERSION}"
LABEL org.opencontainers.image.created="${BUILD_DATE}"
LABEL org.opencontainers.image.revision="${VCS_REF}"
LABEL org.opencontainers.image.source="https://github.com/yawlfoundation/yawl"
LABEL org.opencontainers.image.url="https://yawlfoundation.org"
LABEL org.opencontainers.image.vendor="YAWL Foundation"
LABEL org.opencontainers.image.licenses="LGPL-3.0-or-later"
LABEL org.opencontainers.image.documentation="https://yawlfoundation.github.io/yawl/"
LABEL org.yawlfoundation.yawl.java-version="25"
LABEL org.yawlfoundation.yawl.features="virtual-threads,zgc,petri-net,mcp,a2a"

# Install runtime dependencies in single layer
RUN apk add --no-cache \
    bash \
    curl \
    netcat-openbsd \
    procps-ng \
    postgresql-client \
    mysql-client \
    tzdata \
    ca-certificates \
    && rm -rf /var/cache/apk/* /tmp/*

# Create application user and group for security (non-root)
RUN addgroup -S yawl --gid 1000 && \
    adduser -S yawl --uid 1000 --ingroup yawl --home /app --shell /sbin/nologin

# Set working directory
WORKDIR /app

# Create directories for workflow specifications, logs, and data
RUN mkdir -p \
    /app/specifications \
    /app/logs \
    /app/data \
    /app/temp \
    /app/config \
    && chown -R yawl:yawl /app

# Copy built artifacts from builder stage
# The shaded JAR is in yawl-control-panel module with all dependencies
COPY --from=builder --chown=yawl:yawl /build/yawl-control-panel/target/yawl-control-panel-*.jar /app/yawl.jar

# Copy health check script with production-ready fallback logic
# Strategy: HTTP health endpoint -> TCP port check -> Process check
# See docker/healthcheck.sh for full documentation and configuration options
COPY --chown=yawl:yawl docker/healthcheck.sh /app/healthcheck.sh

# Switch to non-root user
USER yawl

# Expose ports
# 8080 - Main application / Engine API
# 9090 - Management/Actuator / Prometheus metrics
# 8081 - Resource Service
EXPOSE 8080 9090 8081

# Health check with multiple fallback strategies
# Production-ready settings:
# - interval: 30s between checks
# - timeout: 15s per check (increased for slow networks)
# - start-period: 120s for JVM warmup (increased for container environments)
# - retries: 3 before marking unhealthy
HEALTHCHECK --interval=30s \
            --timeout=15s \
            --start-period=120s \
            --retries=3 \
    CMD /app/healthcheck.sh

# ============================================================================
# JVM Options optimized for containers and Java 25
# Virtual Threads are standard in Java 25 (no --enable-preview needed)
# ============================================================================
ENV JAVA_OPTS="\
    -XX:+UseContainerSupport \
    -XX:MaxRAMPercentage=75.0 \
    -XX:InitialRAMPercentage=50.0 \
    -XX:+UseZGC \
    -XX:+ZGenerational \
    -XX:+UseStringDeduplication \
    -XX:+ExitOnOutOfMemoryError \
    -XX:+HeapDumpOnOutOfMemoryError \
    -XX:HeapDumpPath=/app/logs/heap-dump.hprof \
    -Djava.security.egd=file:/dev/./urandom \
    -Djava.io.tmpdir=/app/temp \
    -Dfile.encoding=UTF-8 \
    -Djdk.virtualThreadScheduler.parallelism=200 \
    -Djdk.virtualThreadScheduler.maxPoolSize=256 \
    -Djdk.tracePinnedThreads=short"

# Application configuration
ENV SPRING_PROFILES_ACTIVE=production
ENV MANAGEMENT_HEALTH_PROBES_ENABLED=true
ENV MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS=when-authorized
ENV MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,metrics,prometheus

# OpenTelemetry configuration (if agent is added)
ENV OTEL_SERVICE_NAME=yawl-engine
ENV OTEL_TRACES_EXPORTER=otlp
ENV OTEL_METRICS_EXPORTER=prometheus
ENV OTEL_LOGS_EXPORTER=otlp

# Logging Configuration
ENV LOGGING_LEVEL_ROOT=INFO
ENV LOGGING_LEVEL_ORG_YAWLFOUNDATION=DEBUG
ENV TZ=UTC

# Database Configuration (Override with environment variables or ConfigMap)
ENV DB_TYPE=postgres
ENV DB_HOST=postgres
ENV DB_PORT=5432
ENV DB_NAME=yawl
ENV DB_USER=yawl

# Start application with exec form for proper signal handling
ENTRYPOINT ["sh", "-c", "exec java $JAVA_OPTS -jar /app/yawl.jar"]
