# YAWL v5.2 - Modernized Multi-Stage Docker Build
#
# Features:
# - Multi-stage build (build stage + runtime stage)
# - JDK 25 for build, JRE 25 for runtime (smaller image)
# - Virtual threads support (Java 25 native)
# - Health checks for container orchestration
# - Non-root user for security
# - Optimized JVM settings for containers

# ============================================================================
# Build Stage
# ============================================================================
FROM eclipse-temurin:25-jdk-alpine AS builder

LABEL stage=builder

# Install build dependencies
RUN apk add --no-cache \
    maven \
    git \
    && rm -rf /var/cache/apk/*

WORKDIR /build

# Copy Maven configuration and source
COPY pom.xml ./
COPY src ./src
COPY test ./test
COPY build ./build
COPY schema ./schema

# Build with Maven (skip tests in Docker build, run in CI)
RUN mvn clean package -DskipTests -B

# ============================================================================
# Runtime Stage
# ============================================================================
FROM eclipse-temurin:25-jre-alpine

LABEL maintainer="YAWL Foundation"
LABEL version="5.2"
LABEL description="YAWL Workflow Engine - Cloud-Native with Virtual Threads Support"
LABEL org.opencontainers.image.source="https://github.com/yawlfoundation/yawl"
LABEL org.opencontainers.image.vendor="YAWL Foundation"
LABEL org.opencontainers.image.licenses="LGPL-3.0"

# Install runtime dependencies
RUN apk add --no-cache \
    bash \
    curl \
    postgresql-client \
    mysql-client \
    tzdata \
    ca-certificates \
    && rm -rf /var/cache/apk/*

# Create application user and group for security
RUN addgroup -S yawl && adduser -S yawl -G yawl

# Set working directory
WORKDIR /app

# Copy built artifacts from builder stage
COPY --from=builder --chown=yawl:yawl /build/target/*.jar /app/yawl.jar

# Create directories for workflow specifications, logs, and data
RUN mkdir -p \
    /app/specifications \
    /app/logs \
    /app/data \
    /app/temp \
    /app/config \
    && chown -R yawl:yawl /app

# Switch to non-root user
USER yawl

# Expose ports
# 8080 - Main application
# 9090 - Management/Actuator
# 8081 - Engine API
EXPOSE 8080 9090 8081

# Health check using Spring Boot Actuator liveness endpoint
HEALTHCHECK --interval=30s \
            --timeout=5s \
            --start-period=60s \
            --retries=3 \
    CMD curl -f http://localhost:8080/actuator/health/liveness || exit 1

# ============================================================================
# JVM Options optimized for containers and Java 25 Virtual Threads
# ============================================================================
ENV JAVA_OPTS="\
    -XX:+UseContainerSupport \
    -XX:MaxRAMPercentage=75.0 \
    -XX:InitialRAMPercentage=50.0 \
    -XX:+UseG1GC \
    -XX:+UseStringDeduplication \
    -XX:MaxGCPauseMillis=200 \
    -XX:G1ReservePercent=10 \
    -XX:+ExitOnOutOfMemoryError \
    -XX:+HeapDumpOnOutOfMemoryError \
    -XX:HeapDumpPath=/app/logs/heap-dump.hprof \
    -Djava.security.egd=file:/dev/./urandom \
    -Djava.io.tmpdir=/app/temp \
    -Dfile.encoding=UTF-8"

# Virtual Threads configuration (Java 25+)
ENV JAVA_OPTS="${JAVA_OPTS} \
    --enable-preview \
    -Djdk.virtualThreadScheduler.parallelism=200 \
    -Djdk.virtualThreadScheduler.maxPoolSize=256 \
    -Djdk.tracePinnedThreads=short"

# Application configuration
ENV SPRING_PROFILES_ACTIVE=production
ENV MANAGEMENT_HEALTH_PROBES_ENABLED=true
ENV MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS=when-authorized
ENV MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,metrics,prometheus

# OpenTelemetry configuration (if agent is added)
ENV OTEL_SERVICE_NAME=yawl-engine
ENV OTEL_TRACES_EXPORTER=otlp
ENV OTEL_METRICS_EXPORTER=prometheus
ENV OTEL_LOGS_EXPORTER=otlp

# Logging Configuration
ENV LOGGING_LEVEL_ROOT=INFO
ENV LOGGING_LEVEL_ORG_YAWLFOUNDATION=DEBUG
ENV TZ=UTC

# Database Configuration (Override with environment variables or ConfigMap)
ENV DB_TYPE=postgres
ENV DB_HOST=postgres
ENV DB_PORT=5432
ENV DB_NAME=yawl
ENV DB_USER=yawl

# Start application
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar /app/yawl.jar"]
