# Build Stage
FROM eclipse-temurin:25-jdk-alpine AS builder

LABEL stage=builder

# Install Maven and dependencies
RUN apk add --no-cache \
    maven \
    git \
    && rm -rf /var/cache/apk/*

WORKDIR /build

# Copy Maven configuration and source
COPY pom.xml ./
COPY src ./src
COPY test ./test
COPY build ./build
COPY schema ./schema

# Build with Maven
RUN mvn clean package -DskipTests -B

# Runtime Stage
FROM eclipse-temurin:25-jre-alpine

# Metadata
LABEL maintainer="YAWL Team"
LABEL version="5.2.0"
LABEL environment="staging"

# Install dependencies
RUN apk add --no-cache \
    curl \
    postgresql-client \
    bash

# Create app user
RUN addgroup -S yawl && adduser -S yawl -G yawl

# Create app directory
RUN mkdir -p /app && chown -R yawl:yawl /app

# Copy artifact from builder
COPY --from=builder --chown=yawl:yawl /build/target/*.jar /app/yawl.jar

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:8080/actuator/health || exit 1

# Run as non-root
USER yawl
WORKDIR /app

# JVM tuning for staging with Java 25
ENV JAVA_OPTS="-Xmx512m -Xms256m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -Djdk.virtualThreadScheduler.parallelism=64"

EXPOSE 8080 8081 9090

ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar /app/yawl.jar"]
