# WCP-22: Cancel Region Pattern
# Cancel all tasks in a specific region of the workflow.
#
# CRITICAL FIX (v6.0.0): Flow Graph Token Semantics
#
# Problem Fixed:
# The cancel region pattern requires proper handling of two distinct execution paths:
# 1. Cancel path: Single token through CancelRegion task -> RegionJoin
# 2. Normal path: Three parallel tokens through TaskA, TaskB, TaskC -> RegionJoin
# Original bug: AND-join on RegionJoin expected N tokens to fire but lacked threshold definition.
#
# Solution Implemented:
# - CheckCondition uses XOR-split to create EITHER cancel OR normal execution
# - NormalPath uses AND-split to create 3 concurrent tokens for tasks A, B, C
# - All region tasks (A, B, C) and CancelRegion converge at RegionJoin
# - RegionJoin uses OR-join with explicit threshold to handle:
#   * 1 token from CancelRegion (immediate completion), OR
#   * 3 tokens from TaskA + TaskB + TaskC (synchronization)
# - RegionJoin produces single token to end (Petri net constraint)
#
# Petri Net Semantics:
# - Place(StartTask): 1 token
# - Transition(CheckCondition): XOR-split creates path exclusion
# - Transition(NormalPath): AND-split creates 3 concurrent tokens
# - Transition(RegionJoin): OR-join (threshold-based) consolidates to 1 token
# - Place(End): Final place, single token on completion

name: CancelRegionPattern
uri: cancel-region.xml
first: CheckCondition

variables:
  - name: shouldCancel
    type: xs:boolean
    default: false
  - name: cancelReason
    type: xs:string
    default: "user_request"
  - name: regionStatus
    type: xs:string
    default: "active"
  - name: completionTime
    type: xs:long
    default: 0

tasks:
  # Entry point: single decision node (XOR-split to prevent token duplication)
  - id: CheckCondition
    flows: [CancelRegion, NormalPath]
    condition: shouldCancel == true -> CancelRegion
    default: NormalPath
    split: xor
    join: xor
    description: "Gate decision: cancel or proceed normally. XOR-split ensures single token path."

  # CANCEL PATH: Execute cancellation logic
  - id: CancelRegion
    flows: [RegionJoin]
    split: xor
    join: xor
    cancelRegion: [TaskA, TaskB, TaskC]
    description: "Cancel all tasks in the region (TaskA, TaskB, TaskC). Emits cancellation event."

  # NORMAL PATH: Parallel execution of region tasks
  # AND-split creates one token per output flow (TaskA, TaskB, TaskC).
  # All three tasks will execute concurrently and independently flow to RegionJoin.
  - id: NormalPath
    flows: [TaskA, TaskB, TaskC]
    split: and
    join: xor
    description: "Normal path: AND-split creates concurrent tokens for region tasks (A, B, C)."

  # Region tasks (can complete independently or be cancelled)
  - id: TaskA
    flows: [RegionJoin]
    split: xor
    join: xor
    description: "Region task A. Flows to RegionJoin regardless of cancel status."

  - id: TaskB
    flows: [RegionJoin]
    split: xor
    join: xor
    description: "Region task B. Flows to RegionJoin regardless of cancel status."

  - id: TaskC
    flows: [RegionJoin]
    split: xor
    join: xor
    description: "Region task C. Flows to RegionJoin regardless of cancel status."

  # SYNCHRONIZATION POINT: Join all paths before completion
  # CRITICAL: This is a mixed-input join.
  # - From CancelRegion path: 1 token arrives
  # - From NormalPath (A, B, C): 3 tokens arrive
  # Solution: Use explicit threshold join or OR-join semantics.
  # The join fires when ANY path completes (XOR-join-like) OR when all region tasks complete (AND-like).
  # In YAWL, this is typically a discriminator or multi-merge junction.
  # For semantic correctness with single output token: use threshold join with incoming set {CancelRegion} OR {TaskA,TaskB,TaskC}
  - id: RegionJoin
    flows: [end]
    split: xor
    join: or
    description: "Consolidation point. Either cancel path (1 token) or all normal path tasks (3 tokens) trigger exit. Produces 1 token."
    threshold: "1"
    joinCondition: "CancelRegion completed OR (TaskA AND TaskB AND TaskC completed)"

  # END: Workflow completion
