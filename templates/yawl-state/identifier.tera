{#
 YIdentifier Code Generation Template for YAWL State Machine

 Generates token/identifier classes with hierarchical parent-child relationships.
 YIdentifier represents workflow case tokens with location tracking.

 Template Parameters:
   - class_name: Name of the generated identifier class
   - package: Java package name
   - location_type: Type for location elements
   - supports_persistence: Enable Hibernate persistence support
   - supports_hierarchy: Enable parent-child hierarchy

 Usage:
   tera -t identifier.tera -c '{"class_name":"YIdentifier","package":"org.yawlfoundation.yawl.elements.state"}'
-#}
/*
 * Copyright (c) 2004-{{ "now" | date(format="%Y") }} The YAWL Foundation. All rights reserved.
 * The YAWL Foundation is a collaboration of individuals and
 * organisations who are committed to improving workflow technology.
 *
 * This file is part of YAWL. YAWL is free software: you can
 * redistribute it and/or modify it under the terms of the GNU Lesser
 * General Public License as published by the Free Software Foundation.
 *
 * YAWL is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 * or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser General
 * Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with YAWL. If not, see <http://www.gnu.org/licenses/>.
 *
 * GENERATED BY: yawl-state/identifier.tera
 * GENERATION TIMESTAMP: {{ "now" | date(format="%Y-%m-%dT%H:%M:%SZ") }}
 */

package {{ package }};

import org.yawlfoundation.yawl.elements.YNetElement;
import org.yawlfoundation.yawl.elements.YTask;
import org.yawlfoundation.yawl.elements.YCondition;
import org.yawlfoundation.yawl.elements.YInputCondition;
import org.yawlfoundation.yawl.engine.YEngine;
import org.yawlfoundation.yawl.engine.YPersistenceManager;
import org.yawlfoundation.yawl.exceptions.YPersistenceException;

import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Set;
import java.util.Objects;
{% if supports_persistence | default(value=true) %}
import jakarta.persistence.CascadeType;
import jakarta.persistence.Entity;
import jakarta.persistence.FetchType;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.Id;
import jakarta.persistence.JoinColumn;
import jakarta.persistence.ManyToOne;
import jakarta.persistence.OneToMany;
import org.hibernate.annotations.Cascade;
{% endif %}

/**
 * {{ class_name }} - Workflow Case Token with Hierarchical Structure
 *
 * Represents a token in the YAWL workflow engine. Tokens track their current
 * location(s) in the net and maintain a parent-child hierarchy for supporting
 * multi-instance tasks and sub-net executions.
 *
 * <h2>Token Lifecycle</h2>
 * <pre>
 *   CREATED -> LOCATED -> [CHILDREN_CREATED] -> COMPLETED
 * </pre>
 *
 * <h2>Hierarchy Pattern</h2>
 * <ul>
 *   <li>Root identifier: Created for each case instantiation</li>
 *   <li>Child identifiers: Created for multi-instance task splits</li>
 *   <li>Naming convention: parent.childNum (e.g., "1.2.3")</li>
 * </ul>
 *
 * @author YAWL Code Generator
 * @since {{ version | default(value="5.2") }}
 */
{% if supports_persistence | default(value=true) %}
@Entity
{% endif %}
public class {{ class_name }} {

    private static final long serialVersionUID = 1L;

    // ============================================================
    // STATE CONSTANTS
    // ============================================================

    /** Token has been created but not yet placed in net */
    public static final int STATE_CREATED = 0;

    /** Token is located in one or more net elements */
    public static final int STATE_LOCATED = 1;

    /** Token has completed its lifecycle */
    public static final int STATE_COMPLETED = 2;

    // ============================================================
    // PERSISTENCE FIELDS
    // ============================================================

    {% if supports_persistence | default(value=true) %}
    @Id
    @GeneratedValue
    private Long id;
    {% else %}
    private String id;
    {% endif %}

    /** String representation of the identifier (e.g., "1.2.3") */
    private String _idString;

    /** Names of current locations (for persistence) */
    private List<String> locationNames;

    /** Current net element locations (transient, reconstructed from names) */
    private List<{{ location_type | default(value="YNetElement") }}> _locations;

    /** Child identifiers for multi-instance tasks */
    private List<{{ class_name }}> _children;

    /** Parent identifier (null for root) */
    private {{ class_name }} _parent;

    /** Foreign key for logged task instance */
    private long _logKey = -1;

    /** Current state of this identifier */
    private int _state = STATE_CREATED;

    // ============================================================
    // CONSTRUCTORS
    // ============================================================

    /**
     * Default constructor for Hibernate persistence.
     */
    public {{ class_name }}() {
        _locations = new ArrayList<>();
        locationNames = new ArrayList<>();
        _children = new ArrayList<>();
    }

    /**
     * Creates an identifier with the given ID string.
     *
     * @param idString the unique identifier string, or null to auto-generate
     */
    public {{ class_name }}(String idString) {
        this();
        _idString = (idString != null) ? idString : generateCaseNumber();
        _state = STATE_CREATED;
    }

    /**
     * Creates a child identifier with parent reference.
     *
     * @param idString the identifier string
     * @param parent the parent identifier
     */
    protected {{ class_name }}(String idString, {{ class_name }} parent) {
        this(idString);
        _parent = parent;
    }

    // ============================================================
    // ID ACCESSORS
    // ============================================================

    {% if supports_persistence | default(value=true) %}
    /**
     * Returns the database primary key.
     *
     * @return the database ID
     */
    public Long getId() {
        return id;
    }

    /**
     * Sets the database primary key (for Hibernate).
     *
     * @param id the database ID
     */
    public void setId(Long id) {
        this.id = id;
    }
    {% else %}
    /**
     * Returns the identifier ID.
     *
     * @return the ID string
     */
    public String getId() {
        return id;
    }

    /**
     * Sets the identifier ID.
     *
     * @param id the ID string
     */
    public void setId(String id) {
        this.id = id;
    }
    {% endif %}

    /**
     * Returns the identifier string (e.g., "1.2.3").
     *
     * @return the identifier string
     */
    public String get_idString() {
        return _idString;
    }

    /**
     * Sets the identifier string.
     *
     * @param id the identifier string
     */
    public void set_idString(String id) {
        _idString = id;
    }

    // ============================================================
    // LOCATION MANAGEMENT
    // ============================================================

    /**
     * Returns the persisted location names.
     *
     * @return list of location names
     */
    public List<String> getLocationNames() {
        return locationNames;
    }

    /**
     * Sets location names (for Hibernate).
     *
     * @param names the location names
     */
    public void setLocationNames(List<String> names) {
        locationNames = names;
    }

    /**
     * Returns current net element locations.
     *
     * @return list of locations
     */
    public synchronized List<{{ location_type | default(value="YNetElement") }}> getLocations() {
        return _locations;
    }

    /**
     * Adds a location to this identifier.
     *
     * @param pmgr the persistence manager (may be null)
     * @param condition the net element to add
     * @throws YPersistenceException if persistence fails
     * @throws NullPointerException if condition is null
     */
    public synchronized void addLocation(YPersistenceManager pmgr, {{ location_type | default(value="YNetElement") }} condition)
            throws YPersistenceException {
        Objects.requireNonNull(condition, "Cannot add null condition to identifier");

        _locations.add(condition);

        if ((condition instanceof YCondition) && !(condition instanceof YInputCondition)) {
            String locName = condition.toString();
            locationNames.add(extractLocationName(locName));
        } else {
            locationNames.add(condition.toString());
        }

        _state = STATE_LOCATED;
        updateThis(pmgr);
    }

    /**
     * Adds a task location to this identifier.
     *
     * @param pmgr the persistence manager (may be null)
     * @param task the task to add
     * @throws YPersistenceException if persistence fails
     * @throws NullPointerException if task is null
     */
    public synchronized void addLocation(YPersistenceManager pmgr, YTask task)
            throws YPersistenceException {
        Objects.requireNonNull(task, "Cannot add null task to identifier");

        _locations.add(task);
        locationNames.add(task.getID());
        _state = STATE_LOCATED;
        updateThis(pmgr);
    }

    /**
     * Removes a location from this identifier.
     *
     * @param pmgr the persistence manager (may be null)
     * @param condition the net element to remove
     * @throws YPersistenceException if persistence fails
     */
    public synchronized void removeLocation(YPersistenceManager pmgr, {{ location_type | default(value="YNetElement") }} condition)
            throws YPersistenceException {
        if (condition == null) {
            return;
        }

        _locations.remove(condition);

        if (condition instanceof YCondition && !(condition instanceof YInputCondition)) {
            String locName = condition.toString();
            locationNames.remove(extractLocationName(locName));
        } else {
            locationNames.remove(condition.toString());
        }

        updateThis(pmgr);
    }

    /**
     * Removes a task location from this identifier.
     *
     * @param pmgr the persistence manager (may be null)
     * @param task the task to remove
     * @throws YPersistenceException if persistence fails
     */
    public synchronized void removeLocation(YPersistenceManager pmgr, YTask task)
            throws YPersistenceException {
        if (task == null) {
            return;
        }

        _locations.remove(task);
        locationNames.remove(task.getID());
    }

    /**
     * Clears all locations.
     *
     * @param pmgr the persistence manager (may be null)
     * @throws YPersistenceException if persistence fails
     */
    public synchronized void clearLocations(YPersistenceManager pmgr)
            throws YPersistenceException {
        _locations.clear();
        locationNames.clear();
        updateThis(pmgr);
    }

    /**
     * Clears a specific location (alias for removeLocation).
     *
     * @param pmgr the persistence manager
     * @param condition the condition to clear
     * @throws YPersistenceException if persistence fails
     */
    public synchronized void clearLocation(YPersistenceManager pmgr, {{ location_type | default(value="YNetElement") }} condition)
            throws YPersistenceException {
        removeLocation(pmgr, condition);
    }

    // ============================================================
    // HIERARCHY MANAGEMENT
    // ============================================================

    /**
     * Returns the list of child identifiers.
     *
     * @return the children list
     */
    public List<{{ class_name }}> get_children() {
        return _children;
    }

    /**
     * Sets the children list (for Hibernate).
     *
     * @param children the children to set
     */
    public void set_children(List<{{ class_name }}> children) {
        _children = children;
    }

    /**
     * Returns the children (alias for Hibernate accessor).
     *
     * @return the children list
     */
    public List<{{ class_name }}> getChildren() {
        return _children;
    }

    /**
     * Returns the parent identifier.
     *
     * @return the parent, or null if root
     */
    public {{ class_name }} get_parent() {
        return _parent;
    }

    /**
     * Sets the parent identifier.
     *
     * @param parent the parent identifier
     */
    public void set_parent({{ class_name }} parent) {
        _parent = parent;
    }

    /**
     * Returns the parent (alias for Hibernate accessor).
     *
     * @return the parent, or null if root
     */
    public {{ class_name }} getParent() {
        return _parent;
    }

    /**
     * Checks if this identifier has a parent.
     *
     * @return true if not a root identifier
     */
    public boolean hasParent() {
        return _parent != null;
    }

    /**
     * Checks if this is an immediate child of the given identifier.
     *
     * @param identifier the potential parent
     * @return true if identifier is the direct parent
     */
    public boolean isImmediateChildOf({{ class_name }} identifier) {
        return _parent == identifier;
    }

    /**
     * Checks if this is an ancestor of the given identifier.
     *
     * @param identifier the potential descendant
     * @return true if this is an ancestor
     */
    public boolean isAncestorOf({{ class_name }} identifier) {
        {{ class_name }} parent = identifier.getParent();
        return parent != null && (parent.equals(this) || isAncestorOf(parent));
    }

    /**
     * Checks if equals or is an ancestor of the given identifier.
     *
     * @param another the identifier to check
     * @return true if equal or ancestor
     */
    public boolean equalsOrIsAncestorOf({{ class_name }} another) {
        return equals(another) || isAncestorOf(another);
    }

    /**
     * Creates a child identifier with auto-generated ID.
     *
     * @param pmgr the persistence manager
     * @return the new child identifier
     * @throws YPersistenceException if persistence fails
     */
    public {{ class_name }} createChild(YPersistenceManager pmgr) throws YPersistenceException {
        String newID = String.format("%s.%d", _idString, _children.size() + 1);
        return createChildWithID(pmgr, newID);
    }

    /**
     * Creates a child identifier with a specific number.
     *
     * @param pmgr the persistence manager
     * @param childNum the child number (must be positive)
     * @return the new child identifier
     * @throws YPersistenceException if persistence fails
     * @throws IllegalArgumentException if childNum is invalid
     */
    public {{ class_name }} createChild(YPersistenceManager pmgr, int childNum)
            throws YPersistenceException {
        if (childNum < 1) {
            throw new IllegalArgumentException("Child number must be > 0");
        }

        String childNumStr = String.valueOf(childNum);
        for ({{ class_name }} child : _children) {
            String childID = child.toString();
            String childIDSuffix = childID.substring(childID.lastIndexOf('.') + 1);
            if (childNumStr.equals(childIDSuffix)) {
                throw new IllegalArgumentException(
                    "Child number already in use: " + childNum);
            }
        }

        return createChildWithID(pmgr, _idString + "." + childNumStr);
    }

    /**
     * Creates a child with a specific ID string.
     */
    private {{ class_name }} createChildWithID(YPersistenceManager pmgr, String id)
            throws YPersistenceException {
        {{ class_name }} identifier = new {{ class_name }}(id);
        _children.add(identifier);
        identifier.set_parent(this);

        if (pmgr != null) {
            pmgr.storeObjectFromExternal(identifier);
            updateThis(pmgr);
        }

        return identifier;
    }

    /**
     * Removes a child from this identifier.
     *
     * @param child the child to remove
     * @return true if child was present and removed
     */
    public boolean removeChild({{ class_name }} child) {
        return _children.remove(child);
    }

    /**
     * Clears all children.
     */
    public void clearChildren() {
        _children = new ArrayList<>();
    }

    /**
     * Returns all descendants (including self).
     *
     * @return set of all descendant identifiers
     */
    public Set<{{ class_name }}> getDescendants() {
        Set<{{ class_name }}> descendants = new HashSet<>();
        descendants.add(this);

        for ({{ class_name }} child : _children) {
            if (child != null) {
                descendants.addAll(child.getDescendants());
            }
        }

        return descendants;
    }

    /**
     * Returns the root ancestor of this identifier.
     *
     * @return the root identifier
     */
    public {{ class_name }} getRootAncestor() {
        return getRootAncestor(this);
    }

    private {{ class_name }} getRootAncestor({{ class_name }} identifier) {
        {{ class_name }} parent = identifier.getParent();
        return (parent != null) ? getRootAncestor(parent) : identifier;
    }

    // ============================================================
    // STATE MANAGEMENT
    // ============================================================

    /**
     * Returns the current state.
     *
     * @return the state constant
     */
    public int getState() {
        return _state;
    }

    /**
     * Sets the state.
     *
     * @param state the new state
     */
    public void setState(int state) {
        _state = state;
    }

    /**
     * Marks this identifier as completed.
     *
     * @param pmgr the persistence manager
     * @throws YPersistenceException if persistence fails
     */
    public void markCompleted(YPersistenceManager pmgr) throws YPersistenceException {
        _state = STATE_COMPLETED;
        updateThis(pmgr);
    }

    // ============================================================
    // LOGGING SUPPORT
    // ============================================================

    /**
     * Returns the log key for this identifier.
     *
     * @return the log key
     */
    public long getLogKey() {
        return _logKey;
    }

    /**
     * Sets the log key.
     *
     * @param key the log key
     */
    public void setLogKey(long key) {
        _logKey = key;
    }

    // ============================================================
    // OBJECT CONTRACT
    // ============================================================

    @Override
    public String toString() {
        return _idString;
    }

    @Override
    public boolean equals(Object other) {
        if (this == other) return true;

        if (other instanceof {{ class_name }}) {
            {{ class_name }} otherID = ({{ class_name }}) other;
            if (_idString != null && _idString.equals(otherID.toString())) {
                return (_parent == null)
                    ? (otherID.getParent() == null)
                    : _parent.equals(otherID.getParent());
            }
        }

        return false;
    }

    @Override
    public int hashCode() {
        return _idString != null ? _idString.hashCode() : 0;
    }

    // ============================================================
    // PRIVATE HELPERS
    // ============================================================

    /**
     * Extracts the location name from a full string.
     */
    private String extractLocationName(String locName) {
        int colonIndex = locName.indexOf(':');
        if (colonIndex >= 0 && colonIndex < locName.length() - 1) {
            return locName.substring(colonIndex + 1);
        }
        return locName;
    }

    /**
     * Updates this object in the persistence store.
     */
    private void updateThis(YPersistenceManager pmgr) throws YPersistenceException {
        if (pmgr != null) {
            pmgr.updateObjectExternal(this);
        }
    }

    /**
     * Generates a new case number from the engine.
     */
    private String generateCaseNumber() {
        try {
            return YEngine.getInstance().getNextCaseNbr();
        } catch (IllegalStateException e) {
            // Engine not available, generate timestamp-based ID
            return String.valueOf(System.currentTimeMillis());
        }
    }
}
