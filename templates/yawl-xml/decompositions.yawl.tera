{#
 YAWL Decompositions Template
 Generates <decomposition> elements for task definitions, including composite tasks
 and web service gateway specifications.

 Context Variables (from ggen):
   - decompositions: Array of decomposition rows {?decompId, ?decompName, ?type, ?isRootNet, ?documentation}
   - tasks: Array of task definitions from main workflow
   - variables: Array of local variables in parent net

 Pattern:
   Each task that has a decomposesTo reference generates a corresponding decomposition.
   Simple tasks map to WebServiceGatewayFactsType (manual execution).
   Composite tasks map to NetFactsType (nested workflow nets).
#}
{% set processed_decomps = [] %}
{% for task in tasks %}
  {% set decomp_id = task.get('?decomposesTo') or task.get('decomposesTo') or task.get('?taskId') or task.get('taskId') %}
  {% if decomp_id not in processed_decomps %}
    {% set _ = processed_decomps.append(decomp_id) %}

    {# Simple Task Decomposition (WebServiceGatewayFactsType) #}
    <decomposition id="{{ decomp_id }}" xsi:type="WebServiceGatewayFactsType">
      {% if task.get('?taskName') or task.get('taskName') %}
      <name>{{ task.get('?taskName') or task.get('taskName') }}</name>
      {% endif %}

      {# Input Parameters (from task's incoming data mappings) #}
      {% set param_index = 0 %}
      {% for variable in (variables or []) %}
      <inputParam>
        <index>{{ param_index }}</index>
        <name>{{ variable.get('?varName') or variable.get('varName') }}</name>
        <type>{{ variable.get('?varType') or variable.get('varType') or "string" }}</type>
        <namespace>http://www.w3.org/2001/XMLSchema</namespace>
      </inputParam>
      {% set param_index = param_index + 1 %}
      {% endfor %}

      {# Output Parameters (from task's outgoing data mappings) #}
      {% set out_param_index = 0 %}
      {% for variable in (variables or []) %}
      <outputParam>
        <index>{{ out_param_index }}</index>
        <name>{{ variable.get('?varName') or variable.get('varName') }}</name>
        <type>{{ variable.get('?varType') or variable.get('varType') or "string" }}</type>
        <namespace>http://www.w3.org/2001/XMLSchema</namespace>
      </outputParam>
      {% set out_param_index = out_param_index + 1 %}
      {% endfor %}

      {# External Interaction Mode #}
      <externalInteraction>manual</externalInteraction>
    </decomposition>

  {% endif %}
{% endfor %}

{# Alternative: Composite Task Decomposition Pattern (for multi-instance or nested nets) #}
{# This is commented as a reference for future enhancement when composite tasks are needed

{% for task in tasks %}
  {% if task.isComposite or task['?isComposite'] %}
    {% set decomp_id = task['?decomposesTo'] | default(value=task.decomposesTo) | default(value=task['?taskId']) %}
    <decomposition id="{{ decomp_id }}" isRootNet="false" xsi:type="NetFactsType">
      <name>{{ task['?taskName'] | default(value=task.taskName) }} Subprocess</name>

      {# Subprocess local variables (can be filtered from parent) #}
      {% set sub_var_index = 0 %}
      {% for variable in variables | default(value=[]) %}
      <localVariable>
        <index>{{ sub_var_index }}</index>
        <name>{{ variable['?varName'] | default(value=variable.varName) }}</name>
        <type>{{ variable['?varType'] | default(value=variable.varType) | default(value="string") }}</type>
        <namespace>http://www.w3.org/2001/XMLSchema</namespace>
        {% if variable['?initialValue'] or variable.initialValue %}
        <initialValue>{{ variable['?initialValue'] | default(value=variable.initialValue) }}</initialValue>
        {% endif %}
      </localVariable>
      {% set sub_var_index = sub_var_index + 1 %}
      {% endfor %}

      {# Subprocess control elements #}
      <processControlElements>
        <inputCondition id="InputCondition">
          <flowsInto>
            <nextElementRef id="SubprocessStart" />
          </flowsInto>
        </inputCondition>

        <task id="SubprocessStart">
          <name>{{ task['?taskName'] | default(value=task.taskName) }} Start</name>
          <flowsInto>
            <nextElementRef id="OutputCondition" />
          </flowsInto>
          <join code="xor" />
          <split code="and" />
          <resourcing>
            <offer initiator="user" />
            <allocate initiator="user" />
            <start initiator="user" />
          </resourcing>
          <decomposesTo id="{{ decomp_id }}_impl" />
        </task>

        <outputCondition id="OutputCondition" />
      </processControlElements>
    </decomposition>
  {% endif %}
{% endfor %}

#}
