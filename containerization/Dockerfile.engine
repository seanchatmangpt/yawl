# =============================================================================
# YAWL Engine Service Dockerfile
# =============================================================================
# Core workflow engine implementing Interface A (design) and Interface B (client)
# =============================================================================

# Build stage - use Debian-based image with Maven
FROM eclipse-temurin:25-jdk AS builder

ARG YAWL_VERSION=5.2

# Install build dependencies (Debian-based)
RUN apt-get update && apt-get install -y maven curl && rm -rf /var/lib/apt/lists/*

WORKDIR /build

# Copy Maven configuration and source files
COPY pom.xml ./
COPY src/ ./src/
COPY test/ ./test/
COPY build/ ./build/
COPY schema/ ./schema/

# Build YAWL with Maven
RUN mvn clean package -DskipTests -B

# =============================================================================
# Runtime stage
# =============================================================================
FROM eclipse-temurin:25-jre AS runtime

ARG YAWL_VERSION=5.2
ARG TOMCAT_VERSION=9.0.89

LABEL org.opencontainers.image.title="YAWL Engine"
LABEL org.opencontainers.image.description="YAWL Workflow Engine - Core Service"
LABEL org.opencontainers.image.version="${YAWL_VERSION}"
LABEL org.opencontainers.image.vendor="YAWL Foundation"

# Install runtime dependencies
RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

# Create non-root user
RUN groupadd -r yawl && \
    useradd -r -g yawl -d /yawl -s /sbin/nologin yawl && \
    mkdir -p /yawl /opt/tomcat /data/engine && \
    chown -R yawl:yawl /yawl /opt/tomcat /data

# Download and configure Tomcat
RUN curl -fsSL "https://archive.apache.org/dist/tomcat/tomcat-9/v${TOMCAT_VERSION}/bin/apache-tomcat-${TOMCAT_VERSION}.tar.gz" \
    | tar -xzf - -C /opt/tomcat --strip-components=1 && \
    rm -rf /opt/tomcat/webapps/* /opt/tomcat/webapps.dist && \
    sed -i 's/<Connector port="8080"/<Connector port="8080" URIEncoding="UTF-8"/' \
    /opt/tomcat/conf/server.xml && \
    chown -R yawl:yawl /opt/tomcat

# Copy built WAR from builder (Maven packages to target/)
COPY --from=builder --chown=yawl:yawl /build/target/*.war /opt/tomcat/webapps/ROOT.war

# Environment configuration
ENV CATALINA_HOME=/opt/tomcat \
    JAVA_OPTS="-Xms512m -Xmx2048m -Djava.awt.headless=true -Dfile.encoding=UTF-8" \
    TZ=UTC \
    YAWL_VERSION=${YAWL_VERSION} \
    DB_TYPE=postgres \
    DB_HOST=postgres \
    DB_PORT=5432 \
    DB_NAME=yawl \
    DB_USER=yawl \
    DB_PASSWORD=yawl \
    ENABLE_PERSISTENCE=true \
    ENABLE_LOGGING=true \
    LOG_LEVEL=WARN \
    RESOURCE_SERVICE_URL=http://resource-service:8080/ib

# Expose ports
EXPOSE 8080 8000

# Health check - Interface B endpoint
HEALTHCHECK --interval=30s --timeout=10s --start-period=90s --retries=3 \
    CMD curl -f http://localhost:8080/ || exit 1

# Switch to non-root user
USER yawl

WORKDIR /yawl

# Start Tomcat
CMD ["/opt/tomcat/bin/catalina.sh", "run"]
