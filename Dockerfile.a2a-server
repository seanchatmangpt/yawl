# YAWL A2A Server Container
# Builds the YawlA2AServer with the official A2A Java SDK.
# Exposes the A2A REST API on port 8081 with virtual thread HTTP handling.
#
# Build args:
#   JAVA_VERSION - JDK version (default: 25)
#   IMAGE_TAG    - Image tag / VCS reference

ARG JAVA_VERSION=25
FROM eclipse-temurin:${JAVA_VERSION}-jre-noble AS base

ARG IMAGE_TAG=dev
LABEL org.opencontainers.image.title="YAWL A2A Server" \
      org.opencontainers.image.description="YAWL Agent-to-Agent protocol server - launch_workflow, query_workflows, manage_workitems, cancel_workflow" \
      org.opencontainers.image.version="${IMAGE_TAG}" \
      org.opencontainers.image.vendor="YAWL Foundation" \
      org.opencontainers.image.source="https://github.com/yawlfoundation/yawl"

# Install curl for health checks
RUN apt-get update && \
    apt-get install -y --no-install-recommends curl && \
    rm -rf /var/lib/apt/lists/*

# Create non-root user
RUN groupadd -r yawl --gid=1000 && \
    useradd -r -g yawl --uid=1000 --home-dir=/opt/yawl --shell=/bin/false yawl

WORKDIR /opt/yawl

# Copy the integration JAR (built by Maven in CI)
COPY target/yawl-*.jar app.jar

EXPOSE 8081

USER yawl

# JVM flags: virtual threads + compact object headers + ZGC
ENV JAVA_OPTS="-Xms256m -Xmx768m \
    -XX:+UseZGC -XX:+ZGenerational \
    -XX:+UseCompactObjectHeaders \
    --enable-preview \
    -Djava.awt.headless=true"

CMD java $JAVA_OPTS -cp app.jar \
    org.yawlfoundation.yawl.integration.a2a.YawlA2AServer

HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -sf http://localhost:8081/.well-known/agent.json | grep -q '"name"' || exit 1
