# YAWL Agent Registry Container
# Builds the AgentRegistry HTTP server (port 9090).
# Must be deployed before other agents so they can self-register on startup.
#
# Build args:
#   JAVA_VERSION - JDK version (default: 25)

ARG JAVA_VERSION=25
FROM eclipse-temurin:${JAVA_VERSION}-jre-noble AS base

LABEL org.opencontainers.image.title="YAWL Agent Registry" \
      org.opencontainers.image.description="YAWL agent registry - registration, heartbeat, and capability discovery" \
      org.opencontainers.image.vendor="YAWL Foundation" \
      org.opencontainers.image.source="https://github.com/yawlfoundation/yawl"

# Install curl for health checks
RUN apt-get update && \
    apt-get install -y --no-install-recommends curl && \
    rm -rf /var/lib/apt/lists/*

# Create non-root user
RUN groupadd -r yawl --gid=1000 && \
    useradd -r -g yawl --uid=1000 --home-dir=/opt/yawl --shell=/bin/false yawl

WORKDIR /opt/yawl

# Copy the integration JAR
COPY target/yawl-*.jar app.jar

EXPOSE 9090

USER yawl

ENV JAVA_OPTS="-Xms128m -Xmx512m \
    -XX:+UseZGC -XX:+ZGenerational \
    -XX:+UseCompactObjectHeaders \
    --enable-preview \
    -Djava.awt.headless=true"

CMD java $JAVA_OPTS -cp app.jar \
    org.yawlfoundation.yawl.integration.autonomous.registry.AgentRegistry

HEALTHCHECK --interval=15s --timeout=5s --start-period=20s --retries=3 \
    CMD curl -sf http://localhost:9090/agents || exit 1
