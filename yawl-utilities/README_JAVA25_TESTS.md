# Java 25 Feature Test Suite - Quick Reference

Fast, comprehensive test suite for Java 25 features in YAWL 6.0.0.

## What's Included

| Feature | Tests | Methods | Coverage |
|---------|-------|---------|----------|
| **Records** | 3 classes | 36+ | Serialization, compact constructors, auto-methods |
| **Sealed Classes** | 1 class | 12+ | Pattern matching, exhaustiveness, type safety |
| **Virtual Threads** | 2 classes | 24+ | Concurrency, naming, exception handling, ScopedValue |
| **Structured Concurrency** | 1 class | 14+ | Fan-out/fan-in, error handling, cancellation |
| **Performance** | 1 class | 13+ | Records vs classes, virtual vs platform, benchmarks |
| **TOTAL** | **8 classes** | **99+** | Production-ready tests |

## Quick Start

### Run All Java 25 Tests
```bash
mvn test -Dtest=org.yawlfoundation.yawl.util.java25.**
```

### Run Specific Test Suite
```bash
# Records
mvn test -Dtest=RecordSerializationTest
mvn test -Dtest=RecordCompactConstructorTest
mvn test -Dtest=RecordAutoGeneratedMethodsTest

# Sealed Classes
mvn test -Dtest=SealedClassPatternMatchingTest

# Virtual Threads
mvn test -Dtest=VirtualThreadConcurrencyTest
mvn test -Dtest=ScopedValuePropagationTest

# Structured Concurrency
mvn test -Dtest=StructuredConcurrencyTest

# Performance
mvn test -Dtest=PerformanceComparisonTest
```

### With Coverage Report
```bash
mvn clean test -P analysis
```

## Test Locations

```
yawl-utilities/src/test/java/org/yawlfoundation/yawl/util/java25/
├── records/
│   ├── RecordSerializationTest.java
│   ├── RecordCompactConstructorTest.java
│   └── RecordAutoGeneratedMethodsTest.java
├── sealed/
│   └── SealedClassPatternMatchingTest.java
├── virtual/
│   ├── VirtualThreadConcurrencyTest.java
│   └── ScopedValuePropagationTest.java
├── structured/
│   └── StructuredConcurrencyTest.java
├── performance/
│   └── PerformanceComparisonTest.java
├── package-info.java
└── JAVA25_TEST_SUITE.md (detailed documentation)
```

## Key Features

### Chicago TDD Approach
- **Real Objects**: No mocks, stubs, or fake implementations
- **Integration Tests**: Real Java platform features tested
- **Collaboration Tests**: Multiple threads/tasks work together
- **End-to-End Confidence**: Complete workflow verification

### HYPER_STANDARDS Compliance
- ✅ NO TODO/FIXME/XXX/HACK comments
- ✅ NO mock objects or stub implementations
- ✅ Real implementation OR UnsupportedOperationException
- ✅ NO silent fallbacks on errors
- ✅ Code behavior matches documentation

### Comprehensive Coverage
- **Records**: Serialization, compact constructors, auto-generated methods
- **Sealed Classes**: Exhaustive pattern matching, type safety
- **Virtual Threads**: 1000+ concurrent threads, naming, interruption
- **Structured Concurrency**: Fan-out/fan-in, 1000+ subtasks
- **ScopedValue**: Context propagation, isolation, multi-layer nesting
- **Performance**: Real benchmarks (1M+ iterations, 10K threads)

## Test Highlights

### Records Tests (36+ methods)
```java
// Serialization with real Java streams
RecordTaskItem original = new RecordTaskItem("case-1", "task-1", "active", now);
objectOutput.writeObject(original);
WorkItem restored = (WorkItem) objectInput.readObject();
assertEquals(original, restored);

// Compact constructor validation
CaseIdentifier ci = new CaseIdentifier("  case-123  ", "task-a");
assertEquals("CASE-123", ci.caseId());  // Normalized

// Auto-generated methods (equals, hashCode, toString)
assertEquals(t1, t2);  // Auto equals()
assertTrue(set.contains(t1));  // HashCode works
assertTrue(t.toString().contains("case-1"));  // toString()
```

### Sealed Classes Tests (12+ methods)
```java
// Exhaustive pattern matching - no default case needed
String result = switch (element) {
    case Task t -> "Task: " + t.getTaskId();
    case AndGateway g -> "And Gateway: " + g.getGatewayId();
    case OrGateway g -> "Or Gateway: " + g.getGatewayId();
    case Event e -> "Event: " + e.getEventId();
};

// Type narrowing with instanceof
if (element instanceof Task task) {
    assertEquals("t1", task.getTaskId());
}
```

### Virtual Threads Tests (12+ methods)
```java
// Create 1000 virtual threads
CountDownLatch latch = new CountDownLatch(1000);
for (int i = 0; i < 1000; i++) {
    Thread.ofVirtual()
        .name("virtual-worker-" + i)
        .start(() -> {
            executedCount.incrementAndGet();
            latch.countDown();
        });
}
latch.await();

// Executor service
ExecutorService executor = Executors.newVirtualThreadPerTaskExecutor();
executor.submit(() -> processTask());
```

### Scoped Values Tests (12+ methods)
```java
// Context propagation to child threads
ScopedValue.callWhere(WORKFLOW_CONTEXT, context, () -> {
    Thread.ofVirtual()
        .start(() -> {
            WorkflowContext childContext = WORKFLOW_CONTEXT.get();
            assertEquals("case-002", childContext.getCaseId());
        });
});
```

### Structured Concurrency Tests (14+ methods)
```java
// Fan-out/fan-in with automatic error handling
try (var scope = new StructuredTaskScope.ShutdownOnFailure()) {
    StructuredTaskScope.Subtask<String> task1 = scope.fork(() -> "result-1");
    StructuredTaskScope.Subtask<String> task2 = scope.fork(() -> "result-2");

    scope.join();  // Waits for all, cancels on first failure
    assertEquals("result-1", task1.get());
}
```

### Performance Tests (13+ methods)
```java
// Record vs traditional class creation (1M iterations)
long recordTime = System.nanoTime();
for (int i = 0; i < 1_000_000; i++) {
    new RecordTaskItem(...);
}

// Virtual threads (10K concurrent)
testManyVirtualThreads();  // 10000 threads, <30s completion

// ScopedValue vs ThreadLocal (10M access iterations)
testScopedValueVsThreadLocal();
```

## Standards & Quality

### Coverage Targets
- **Line Coverage**: 80%+
- **Branch Coverage**: 70%+
- **Mutation Testing**: Ready for pit-test

### Test Statistics
- 8 test classes
- 99+ test methods
- 0 TODOs, FIXMEs, or mocks
- 100% real implementation

### Documentation
- Comprehensive javadoc on all tests
- `JAVA25_TEST_SUITE.md` - detailed guide
- `package-info.java` - architectural overview
- Inline comments on complex scenarios

## Integration with YAWL

These tests are designed to validate Java 25 features used throughout YAWL:

### Records
- `WorkItem`, `WorkflowEvent` - domain models
- DTOs, API payloads
- Serializable data structures

### Sealed Classes
- `WorkflowElement` hierarchies
- Task/Gateway/Event types
- Domain model safety

### Virtual Threads
- Per-case processing threads
- High-throughput workflows
- 1000+ concurrent cases

### Structured Concurrency
- Parallel task execution
- Error handling and cancellation
- Resource cleanup

### ScopedValue
- Case context propagation
- Request ID tracking
- User session info

## Running in CI/CD

```bash
# Fast check (compile only)
mvn compile -pl yawl-utilities

# Full test suite
mvn test -pl yawl-utilities

# With coverage and analysis
mvn clean verify -P analysis -pl yawl-utilities

# Specific module only
mvn test -Dtest=VirtualThreadConcurrencyTest -pl yawl-utilities
```

## Troubleshooting

### Tests fail with "UnsupportedOperationException"
This is expected for unimplemented features. Tests verify the contract.

### Tests timeout
Increase timeout via `-Dtimeout=30` or individual @Timeout annotations.

### Memory issues with 10K thread test
This is expected behavior testing. Reduce iterations if needed:
```bash
mvn test -Dtest=VirtualThreadConcurrencyTest#testManyVirtualThreads
```

### Network/Maven issues
Use offline mode:
```bash
mvn test -o -pl yawl-utilities
```

## Future Enhancements

1. **Pattern Matching for Switch** (JEP 441)
   - Guard patterns in switch expressions
   - Refined patterns with when clauses

2. **Record Patterns** (JEP 405)
   - Destructuring in switch statements
   - Nested patterns

3. **Implicit Classes** (Preview)
   - Testing preview features

4. **Module System**
   - Sealed class boundaries
   - Module visibility tests

## References

- **YAWL Java 25 Guide**: `.claude/rules/java25/modern-java.md`
- **Testing Standards**: `.claude/rules/testing/chicago-tdd.md`
- **Code Standards**: `.claude/HYPER_STANDARDS.md`
- **OpenJDK Project Amber**: https://openjdk.org/projects/amber/

## Support

For questions about specific tests:
1. Check `JAVA25_TEST_SUITE.md` for detailed documentation
2. Review test method javadoc and comments
3. Check OpenJDK JEP documentation
4. Review test output and assertion messages

---

**Created**: 2026-02-20
**Java Version**: 21+
**Test Framework**: JUnit 5
**Coverage**: 80%+ target
**Status**: Production-ready
