%%{ init: { 'theme': 'base' } }%%
graph TD
    classDef critical fill:#e53e3e,stroke:#c53030,color:#fff
    classDef high fill:#dd6b20,stroke:#c05621,color:#fff
    classDef medium fill:#d69e2e,stroke:#b7791f,color:#fff
    classDef low fill:#38a169,stroke:#2f855a,color:#fff
    classDef mitigated fill:#3182ce,stroke:#2b6cb0,color:#fff

    FMEA["FMEA Risk Surface Map<br/>YAWL V6 Observatory"]

    %% ═══════════════════════════════════════════════════
    %% FAILURE MODE 1: Shared Source Path Confusion
    %% Severity=9 Occurrence=8 Detection=3 RPN=216
    %% ═══════════════════════════════════════════════════
    subgraph FM1["FM1: Shared Source Path Confusion<br/>RPN=216 CRITICAL"]
        FM1_CAUSE["Cause: 5 modules share ../src<br/>with include/exclude filters"]
        FM1_EFFECT["Effect: Agent edits wrong file<br/>or misattributes class ownership"]
        FM1_DETECT["Detection: shared-src.json +<br/>15-shared-src-map.mmd"]:::mitigated
    end
    FM1:::critical

    %% ═══════════════════════════════════════════════════
    %% FAILURE MODE 2: Dual-Family Class Confusion
    %% Severity=8 Occurrence=7 Detection=4 RPN=224
    %% ═══════════════════════════════════════════════════
    subgraph FM2["FM2: Dual-Family Class Confusion<br/>RPN=224 CRITICAL"]
        FM2_CAUSE["Cause: 48+ mirrored classes in<br/>stateful + stateless packages"]
        FM2_EFFECT["Effect: Change applied to wrong<br/>variant; silent behavioral divergence"]
        FM2_DETECT["Detection: dual-family.json +<br/>16-dual-family-map.mmd"]:::mitigated
    end
    FM2:::critical

    %% ═══════════════════════════════════════════════════
    %% FAILURE MODE 3: Dependency Version Skew
    %% Severity=7 Occurrence=6 Detection=5 RPN=210
    %% ═══════════════════════════════════════════════════
    subgraph FM3["FM3: Dependency Version Skew<br/>RPN=210 HIGH"]
        FM3_CAUSE["Cause: Transitive deps pull<br/>different versions across modules"]
        FM3_EFFECT["Effect: Runtime ClassNotFound or<br/>NoSuchMethod at deploy time"]
        FM3_DETECT["Detection: deps-conflicts.json +<br/>17-deps-conflicts.mmd"]:::mitigated
    end
    FM3:::high

    %% ═══════════════════════════════════════════════════
    %% FAILURE MODE 4: Maven Cached Missing Artifacts
    %% Severity=6 Occurrence=5 Detection=2 RPN=60
    %% ═══════════════════════════════════════════════════
    subgraph FM4["FM4: Maven Cached Missing Artifacts<br/>RPN=60 MEDIUM"]
        FM4_CAUSE["Cause: Failed download cached in<br/>~/.m2 with .lastUpdated marker"]
        FM4_EFFECT["Effect: Build fails even after<br/>network restored; misleading errors"]
        FM4_DETECT["Detection: maven-hazards.json<br/>+ actionable remediation"]:::mitigated
    end
    FM4:::medium

    %% ═══════════════════════════════════════════════════
    %% FAILURE MODE 5: Test Selection Ambiguity
    %% Severity=7 Occurrence=4 Detection=3 RPN=84
    %% ═══════════════════════════════════════════════════
    subgraph FM5["FM5: Test Selection Ambiguity<br/>RPN=84 MEDIUM"]
        FM5_CAUSE["Cause: Shared ../test root with<br/>module-scoped test filtering"]
        FM5_EFFECT["Effect: Test runs wrong test class<br/>or misses coverage target"]
        FM5_DETECT["Detection: tests.json +<br/>30-test-topology.mmd"]:::mitigated
    end
    FM5:::medium

    %% ═══════════════════════════════════════════════════
    %% FAILURE MODE 6: Gate Bypass via Skip Flags
    %% Severity=8 Occurrence=3 Detection=6 RPN=144
    %% ═══════════════════════════════════════════════════
    subgraph FM6["FM6: Gate Bypass via Skip Flags<br/>RPN=144 HIGH"]
        FM6_CAUSE["Cause: -DskipTests, -Denforcer.skip<br/>disable safety gates"]
        FM6_EFFECT["Effect: Broken code merged;<br/>bugs reach production"]
        FM6_DETECT["Detection: gates.json +<br/>40-ci-gates.mmd"]:::mitigated
    end
    FM6:::high

    %% ═══════════════════════════════════════════════════
    %% FAILURE MODE 7: Reactor Order Violation
    %% Severity=5 Occurrence=3 Detection=7 RPN=105
    %% ═══════════════════════════════════════════════════
    subgraph FM7["FM7: Reactor Order Violation<br/>RPN=105 MEDIUM"]
        FM7_CAUSE["Cause: Module added to POM in<br/>wrong position vs its deps"]
        FM7_EFFECT["Effect: Compile failure on first<br/>build; confusing error messages"]
        FM7_DETECT["Detection: reactor.json +<br/>10-maven-reactor.mmd"]:::mitigated
    end
    FM7:::medium

    %% Connections: FMEA -> Failure Modes
    FMEA --> FM1
    FMEA --> FM2
    FMEA --> FM3
    FMEA --> FM4
    FMEA --> FM5
    FMEA --> FM6
    FMEA --> FM7

    %% Mitigation chain: Diagrams + Facts reduce Detection score
    subgraph Mitigation["Observatory Mitigations"]
        M_FACTS["Facts: 9 JSON files<br/>Machine-readable truth"]:::mitigated
        M_DIAGRAMS["Diagrams: 7 Mermaid files<br/>Visual topology maps"]:::mitigated
        M_YAWL["YAWL XML: Build workflow<br/>as executable net"]:::mitigated
        M_RECEIPT["Receipt: observatory.json<br/>Deterministic verification"]:::mitigated
    end

    FM1_DETECT --> M_FACTS
    FM2_DETECT --> M_DIAGRAMS
    FM3_DETECT --> M_FACTS
    FM4_DETECT --> M_FACTS
    FM5_DETECT --> M_DIAGRAMS
    FM6_DETECT --> M_DIAGRAMS
    FM7_DETECT --> M_FACTS
