# YAWL v5.2 - Development Environment Dockerfile
#
# =============================================================================
# DEVELOPMENT USAGE:
# =============================================================================
#
# Build the development image:
#   docker build -f docker/development/Dockerfile.dev -t yawl-dev:latest .
#
# Run with source code mounted for hot reload:
#   docker run -it --rm \
#     -p 8080:8080 \
#     -p 9090:9090 \
#     -p 5005:5005 \
#     -v $(pwd)/src:/app/src:ro \
#     -v $(pwd)/test:/app/test:ro \
#     -v $(pwd)/yawl-engine:/app/yawl-engine:ro \
#     -v $(pwd)/yawl-elements:/app/yawl-elements:ro \
#     -v $(pwd)/yawl-utilities:/app/yawl-utilities:ro \
#     -v $(pwd)/yawl-control-panel:/app/yawl-control-panel:ro \
#     -v yawl-maven-cache:/root/.m2 \
#     yawl-dev:latest
#
# Run with remote debugging enabled:
#   docker run -it --rm \
#     -p 8080:8080 \
#     -p 5005:5005 \
#     -e JAVA_DEBUG=true \
#     -v yawl-maven-cache:/root/.m2 \
#     yawl-dev:latest
#
# Interactive shell for development:
#   docker run -it --rm \
#     -v $(pwd):/app \
#     -v yawl-maven-cache:/root/.m2 \
#     --entrypoint /bin/bash \
#     yawl-dev:latest
#
# Run tests in container:
#   docker run -it --rm \
#     -v $(pwd):/app \
#     -v yawl-maven-cache:/root/.m2 \
#     yawl-dev:latest mvn clean test
#
# Quick compile without running:
#   docker run -it --rm \
#     -v $(pwd):/app \
#     -v yawl-maven-cache:/root/.m2 \
#     yawl-dev:latest mvn clean compile -DskipTests
#
# Environment Variables:
#   - JAVA_DEBUG=true          Enable remote debugging on port 5005
#   - JAVA_DEBUG_SUSPEND=y     Suspend execution until debugger attaches
#   - MAVEN_OPTS               Additional Maven JVM options
#   - SPRING_PROFILES_ACTIVE   Spring profile (default: development)
#
# =============================================================================
# FEATURES:
# =============================================================================
# - JDK 25 with full development tools
# - Maven 3.9.9 with dependency caching
# - Remote debugging support (JDWP) on port 5005
# - Hot reload via source volume mounts
# - Test dependencies included
# - Development JVM options (faster startup, more debugging info)
# - Non-root user for security
# - Health checks for development monitoring
#
# =============================================================================
# EXPOSED PORTS:
# =============================================================================
# - 8080: Main application / Engine API
# - 9090: Management/Actuator / Prometheus metrics
# - 5005: Remote debugging (JDWP)
# - 8081: Resource Service
# =============================================================================

# Use full JDK image for development (includes debugging tools)
FROM eclipse-temurin:25-jdk-alpine

# Build arguments for labels
ARG VERSION=5.2
ARG MAVEN_VERSION=3.9.9
ARG BUILD_DATE
ARG VCS_REF

LABEL maintainer="YAWL Foundation"
LABEL version="${VERSION}"
LABEL description="YAWL Workflow Engine - Development Environment"
LABEL org.opencontainers.image.title="YAWL Development Environment"
LABEL org.opencontainers.image.description="YAWL Workflow Engine - Development Environment with full tooling"
LABEL org.opencontainers.image.source="https://github.com/yawlfoundation/yawl"
LABEL org.opencontainers.image.vendor="YAWL Foundation"
LABEL org.opencontainers.image.version="${VERSION}"
LABEL org.opencontainers.image.licenses="LGPL-3.0"
LABEL org.opencontainers.image.created="${BUILD_DATE}"
LABEL org.opencontainers.image.revision="${VCS_REF}"
LABEL environment="development"

# Install development tools in single layer
# - git: Version control for development
# - bash: Interactive shell
# - curl: HTTP client for API testing
# - netcat-openbsd: Network debugging
# - vim: Text editor
# - htop: Process monitoring
# - jq: JSON processing for API responses
# - postgresql-client, mysql-client: Database debugging
# - tzdata: Timezone support
# - ca-certificates: SSL/TLS certificates
RUN apk add --no-cache \
    git \
    bash \
    curl \
    netcat-openbsd \
    vim \
    htop \
    jq \
    postgresql-client \
    mysql-client \
    tzdata \
    ca-certificates \
    && rm -rf /var/cache/apk/* /tmp/*

# Install Maven for building and dependency management
RUN curl -fsSL https://archive.apache.org/dist/maven/maven-3/${MAVEN_VERSION}/binaries/apache-maven-${MAVEN_VERSION}-bin.tar.gz \
    | tar -xzf - -C /opt \
    && ln -s /opt/apache-maven-${MAVEN_VERSION}/bin/mvn /usr/local/bin/mvn \
    && rm -rf /tmp/*

# Create application user and group (non-root for security)
RUN addgroup -S yawl --gid 1000 && \
    adduser -S yawl --uid 1000 --ingroup yawl --home /app --shell /bin/bash

# Set working directory
WORKDIR /app

# Create directories for development
# - specifications: Workflow spec files
# - logs: Application logs (mounted for persistence)
# - data: H2 database files
# - temp: Temporary files
# - config: Configuration files
# - target: Build output (for mounted builds)
RUN mkdir -p \
    /app/specifications \
    /app/logs \
    /app/data \
    /app/temp \
    /app/config \
    /app/target \
    && chown -R yawl:yawl /app

# Copy Maven wrapper and pom files first for dependency caching
COPY --chown=yawl:yawl pom.xml ./
COPY --chown=yawl:yawl yawl-utilities/pom.xml ./yawl-utilities/
COPY --chown=yawl:yawl yawl-elements/pom.xml ./yawl-elements/
COPY --chown=yawl:yawl yawl-authentication/pom.xml ./yawl-authentication/
COPY --chown=yawl:yawl yawl-engine/pom.xml ./yawl-engine/
COPY --chown=yawl:yawl yawl-stateless/pom.xml ./yawl-stateless/
COPY --chown=yawl:yawl yawl-resourcing/pom.xml ./yawl-resourcing/
COPY --chown=yawl:yawl yawl-worklet/pom.xml ./yawl-worklet/
COPY --chown=yawl:yawl yawl-scheduling/pom.xml ./yawl-scheduling/
COPY --chown=yawl:yawl yawl-integration/pom.xml ./yawl-integration/
COPY --chown=yawl:yawl yawl-monitoring/pom.xml ./yawl-monitoring/
COPY --chown=yawl:yawl yawl-webapps/pom.xml ./yawl-webapps/
COPY --chown=yawl:yawl yawl-control-panel/pom.xml ./yawl-control-panel/

# Pre-download dependencies for faster iteration
# This layer is cached if pom.xml files don't change
RUN mvn dependency:go-offline -B --no-transfer-progress || true

# Copy source code (will be overridden by volume mounts in development)
COPY --chown=yawl:yawl src ./src
COPY --chown=yawl:yawl test ./test
COPY --chown=yawl:yawl build ./build
COPY --chown=yawl:yawl schema ./schema
COPY --chown=yawl:yawl yawl-utilities ./yawl-utilities
COPY --chown=yawl:yawl yawl-elements ./yawl-elements
COPY --chown=yawl:yawl yawl-authentication ./yawl-authentication
COPY --chown=yawl:yawl yawl-engine ./yawl-engine
COPY --chown=yawl:yawl yawl-stateless ./yawl-stateless
COPY --chown=yawl:yawl yawl-resourcing ./yawl-resourcing
COPY --chown=yawl:yawl yawl-worklet ./yawl-worklet
COPY --chown=yawl:yawl yawl-scheduling ./yawl-scheduling
COPY --chown=yawl:yawl yawl-integration ./yawl-integration
COPY --chown=yawl:yawl yawl-monitoring ./yawl-monitoring
COPY --chown=yawl:yawl yawl-webapps ./yawl-webapps
COPY --chown=yawl:yawl yawl-control-panel ./yawl-control-panel

# Create development helper scripts
RUN echo '#!/bin/bash' > /app/dev-tools.sh && \
    echo '# YAWL Development Helper Script' >> /app/dev-tools.sh && \
    echo '' >> /app/dev-tools.sh && \
    echo 'compile() { mvn clean compile -DskipTests -B --no-transfer-progress; }' >> /app/dev-tools.sh && \
    echo '' >> /app/dev-tools.sh && \
    echo 'test() { mvn clean test -B --no-transfer-progress; }' >> /app/dev-tools.sh && \
    echo '' >> /app/dev-tools.sh && \
    echo 'package() { mvn clean package -DskipTests -B --no-transfer-progress; }' >> /app/dev-tools.sh && \
    echo '' >> /app/dev-tools.sh && \
    echo 'run() {' >> /app/dev-tools.sh && \
    echo '    if [ ! -f yawl-control-panel/target/yawl-control-panel-*.jar ]; then' >> /app/dev-tools.sh && \
    echo '        package' >> /app/dev-tools.sh && \
    echo '    fi' >> /app/dev-tools.sh && \
    echo '    java $JAVA_OPTS -jar yawl-control-panel/target/yawl-control-panel-*.jar' >> /app/dev-tools.sh && \
    echo '}' >> /app/dev-tools.sh && \
    echo '' >> /app/dev-tools.sh && \
    echo 'debug() {' >> /app/dev-tools.sh && \
    echo '    export JAVA_DEBUG=true' >> /app/dev-tools.sh && \
    echo '    run' >> /app/dev-tools.sh && \
    echo '}' >> /app/dev-tools.sh && \
    echo '' >> /app/dev-tools.sh && \
    echo 'watch() {' >> /app/dev-tools.sh && \
    echo '    echo "Watching for changes... Press Ctrl+C to stop"' >> /app/dev-tools.sh && \
    echo '    while inotifywait -r -e modify src/ test/ 2>/dev/null; do' >> /app/dev-tools.sh && \
    echo '        echo "Change detected, recompiling..."' >> /app/dev-tools.sh && \
    echo '        compile' >> /app/dev-tools.sh && \
    echo '    done' >> /app/dev-tools.sh && \
    echo '}' >> /app/dev-tools.sh && \
    echo '' >> /app/dev-tools.sh && \
    echo 'health() { curl -sf http://localhost:8080/actuator/health || echo "Service not healthy"; }' >> /app/dev-tools.sh && \
    echo '' >> /app/dev-tools.sh && \
    echo 'logs() { tail -f /app/logs/*.log 2>/dev/null || echo "No log files found"; }' >> /app/dev-tools.sh && \
    echo '' >> /app/dev-tools.sh && \
    echo '# Source this file: source /app/dev-tools.sh' >> /app/dev-tools.sh && \
    chmod +x /app/dev-tools.sh && \
    chown yawl:yawl /app/dev-tools.sh

# Create startup script with debug support
RUN echo '#!/bin/bash' > /app/start-dev.sh && \
    echo '# YAWL Development Startup Script' >> /app/start-dev.sh && \
    echo 'set -e' >> /app/start-dev.sh && \
    echo '' >> /app/start-dev.sh && \
    echo 'echo "=== YAWL Development Environment ==="' >> /app/start-dev.sh && \
    echo 'echo "Java Version: $(java -version 2>&1 | head -1)"' >> /app/start-dev.sh && \
    echo 'echo "Maven Version: $(mvn -version 2>&1 | head -1)"' >> /app/start-dev.sh && \
    echo '' >> /app/start-dev.sh && \
    echo '# Build if JAR does not exist' >> /app/start-dev.sh && \
    echo 'if [ ! -f yawl-control-panel/target/yawl-control-panel-*.jar ]; then' >> /app/start-dev.sh && \
    echo '    echo "Building application..."' >> /app/start-dev.sh && \
    echo '    mvn clean package -Dmaven.test.skip=true -B --no-transfer-progress' >> /app/start-dev.sh && \
    echo 'fi' >> /app/start-dev.sh && \
    echo '' >> /app/start-dev.sh && \
    echo '# Configure debug options' >> /app/start-dev.sh && \
    echo 'DEBUG_OPTS=""' >> /app/start-dev.sh && \
    echo 'if [ "${JAVA_DEBUG}" = "true" ]; then' >> /app/start-dev.sh && \
    echo '    SUSPEND_OPT="${JAVA_DEBUG_SUSPEND:-n}"' >> /app/start-dev.sh && \
    echo '    DEBUG_OPTS="-agentlib:jdwp=transport=dt_socket,server=y,suspend=${SUSPEND_OPT},address=*:5005"' >> /app/start-dev.sh && \
    echo '    echo "Remote debugging enabled on port 5005 (suspend=${SUSPEND_OPT})"' >> /app/start-dev.sh && \
    echo 'fi' >> /app/start-dev.sh && \
    echo '' >> /app/start-dev.sh && \
    echo '# Start application' >> /app/start-dev.sh && \
    echo 'echo "Starting YAWL Engine..."' >> /app/start-dev.sh && \
    echo 'exec java $DEBUG_OPTS $JAVA_OPTS -jar yawl-control-panel/target/yawl-control-panel-*.jar' >> /app/start-dev.sh && \
    chmod +x /app/start-dev.sh && \
    chown yawl:yawl /app/start-dev.sh

# Create health check script
RUN echo '#!/bin/sh' > /app/healthcheck.sh && \
    echo 'set -e' >> /app/healthcheck.sh && \
    echo '' >> /app/healthcheck.sh && \
    echo '# Try Spring Boot Actuator health endpoint first' >> /app/healthcheck.sh && \
    echo 'if curl -sf http://localhost:8080/actuator/health/liveness >/dev/null 2>&1; then' >> /app/healthcheck.sh && \
    echo '    exit 0' >> /app/healthcheck.sh && \
    echo 'fi' >> /app/healthcheck.sh && \
    echo '' >> /app/healthcheck.sh && \
    echo '# Fallback: Check if port 8080 is listening' >> /app/healthcheck.sh && \
    echo 'if nc -z localhost 8080 2>/dev/null; then' >> /app/healthcheck.sh && \
    echo '    exit 0' >> /app/healthcheck.sh && \
    echo 'fi' >> /app/healthcheck.sh && \
    echo '' >> /app/healthcheck.sh && \
    echo '# Fallback: Check if Java process is running' >> /app/healthcheck.sh && \
    echo 'if pgrep -f "yaw[a-z]*\\.jar" >/dev/null 2>&1; then' >> /app/healthcheck.sh && \
    echo '    exit 0' >> /app/healthcheck.sh && \
    echo 'fi' >> /app/healthcheck.sh && \
    echo '' >> /app/healthcheck.sh && \
    echo 'exit 1' >> /app/healthcheck.sh && \
    chmod +x /app/healthcheck.sh && \
    chown yawl:yawl /app/healthcheck.sh

# Switch to non-root user
USER yawl

# Expose ports
# 8080 - Main application / Engine API
# 9090 - Management/Actuator / Prometheus metrics
# 5005 - Remote debugging (JDWP)
# 8081 - Resource Service
EXPOSE 8080 9090 5005 8081

# Health check with longer start period for development builds
HEALTHCHECK --interval=30s \
            --timeout=10s \
            --start-period=120s \
            --retries=3 \
    CMD /app/healthcheck.sh

# ============================================================================
# Development JVM Options
# - Container support for Docker/Kubernetes
# - Z Generational Garbage Collector (Java 25 optimized)
# - Compact object headers (Java 25 performance)
# - AOT cache for faster startup
# - Maximum RAM percentage for containers
# - Virtual threads support (Java 25 standard)
# - Heap dump on OOM for debugging
# - TLS 1.3 enforcement (security by default)
# ============================================================================
ENV JAVA_OPTS="\
    -XX:+UseContainerSupport \
    -XX:+UseZGC \
    -XX:+ZGenerational \
    -XX:MaxRAMPercentage=75.0 \
    -XX:InitialRAMPercentage=25.0 \
    -XX:+UseCompactObjectHeaders \
    -XX:+UseAOTCache \
    -XX:+UseStringDeduplication \
    -XX:+ExitOnOutOfMemoryError \
    -XX:+HeapDumpOnOutOfMemoryError \
    -XX:HeapDumpPath=/app/logs/heap-dump.hprof \
    -XX:+TieredCompilation \
    -XX:TieredStopAtLevel=1 \
    -Xlog:gc*:file=/app/logs/gc.log:time,tags \
    -Djava.security.egd=file:/dev/./urandom \
    -Djava.io.tmpdir=/app/temp \
    -Dfile.encoding=UTF-8 \
    -Djdk.virtualThreadScheduler.parallelism=200 \
    -Djdk.virtualThreadScheduler.maxPoolSize=256 \
    -Djdk.tracePinnedThreads=full \
    -Djdk.tls.disabledAlgorithms=SSLv3,TLSv1,TLSv1.1,RC4,MD5,SHA-1,DES,3DES \
    -Djdk.certpath.disabledAlgorithms=MD2,MD5,SHA1,RSA\ keySize\ <3072 \
    -Djdk.jce.disabledAlgorithms=DES,3DES,RC4,Blowfish \
    -Dorg.slf4j.simpleLogger.defaultLogLevel=DEBUG \
    -Dlog4j2.debug=true"

# Development application configuration
ENV SPRING_PROFILES_ACTIVE=development
ENV MANAGEMENT_HEALTH_PROBES_ENABLED=true
ENV MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS=always
ENV MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,metrics,prometheus,env,beans,configprops,loggers

# OpenTelemetry configuration for development
ENV OTEL_SERVICE_NAME=yawl-engine-dev
ENV OTEL_TRACES_EXPORTER=logging
ENV OTEL_METRICS_EXPORTER=prometheus
ENV OTEL_LOGS_EXPORTER=logging
ENV OTEL_LOG_LEVEL=DEBUG

# Logging configuration (verbose for development)
ENV LOGGING_LEVEL_ROOT=DEBUG
ENV LOGGING_LEVEL_ORG_YAWLFOUNDATION=TRACE
ENV LOGGING_LEVEL_ORG_HIBERNATE_SQL=DEBUG
ENV LOGGING_LEVEL_ORG_HIBERNATE_TYPE=TRACE
ENV TZ=UTC

# Development database configuration (H2 in-memory by default)
ENV DB_TYPE=h2
ENV DB_URL=jdbc:h2:file:/app/data/yawl;MODE=PostgreSQL;AUTO_SERVER=TRUE
ENV DB_USER=sa
ENV DB_PASSWORD=

# H2 Console for development database inspection
ENV H2_CONSOLE_ENABLED=true
ENV H2_CONSOLE_PATH=/h2-console

# Remote debugging configuration (set JAVA_DEBUG=true to enable)
ENV JAVA_DEBUG=false
ENV JAVA_DEBUG_SUSPEND=n

# Maven options for faster builds
ENV MAVEN_OPTS="-Xmx1g -XX:+UseG1GC -XX:+TieredCompilation -XX:TieredStopAtLevel=1"

# Entry point - use start script with debug support
ENTRYPOINT ["/app/start-dev.sh"]

# Default command (can be overridden)
# For interactive development: docker run -it --entrypoint /bin/bash yawl-dev:latest
CMD []