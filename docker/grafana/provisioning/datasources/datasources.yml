# =============================================================================
# YAWL v6.0.0-GA - Grafana Datasources Configuration
# =============================================================================
# Pre-configured datasources for YAWL monitoring stack.
# Includes: Prometheus, AlertManager, PostgreSQL, Loki (optional).
# =============================================================================

apiVersion: 1

# Delete datasources that are not defined in this file
deleteDatasources:
  - name: Prometheus-Old
    orgId: 1

datasources:
  # ==========================================================================
  # Prometheus - Primary metrics datasource
  # ==========================================================================
  - name: Prometheus
    type: prometheus
    access: proxy
    orgId: 1
    url: http://prometheus:9090
    basicAuth: false
    isDefault: true
    version: 1
    editable: false
    jsonData:
      httpMethod: POST
      manageAlerts: true
      prometheusType: Prometheus
      prometheusVersion: "2.45.0"
      cacheLevel: 'High'
      incrementalQuerying: true
      incrementalQueryOverlapWindow: 10m
      disableRecordingRules: false
      exemplarTraceIdDestinations:
        - name: traceID
          datasourceUid: tempo
    uid: prometheus

  # ==========================================================================
  # AlertManager - For alert annotations
  # ==========================================================================
  - name: AlertManager
    type: alertmanager
    access: proxy
    orgId: 1
    url: http://alertmanager:9093
    basicAuth: false
    isDefault: false
    version: 1
    editable: false
    jsonData:
      implementation: prometheus
      handleGrafanaManagedAlerts: true
    uid: alertmanager

  # ==========================================================================
  # PostgreSQL - For YAWL operational data queries
  # ==========================================================================
  - name: YAWL-PostgreSQL
    type: postgres
    access: proxy
    orgId: 1
    url: postgres:5432
    database: yawl
    user: ${POSTGRES_USER}
    secureJsonData:
      password: ${POSTGRES_PASSWORD}
    jsonData:
      sslmode: disable
      maxOpenConns: 10
      maxIdleConns: 5
      connMaxLifetime: 14400
      postgresVersion: 1500
      timescaledb: false
    editable: false
    uid: yawl-postgres

  # ==========================================================================
  # Loki - Log aggregation (optional, if deployed)
  # ==========================================================================
  - name: Loki
    type: loki
    access: proxy
    orgId: 1
    url: http://loki:3100
    basicAuth: false
    isDefault: false
    version: 1
    editable: false
    jsonData:
      maxLines: 1000
      derivedFields:
        - name: TraceID
          matcherRegex: '"traceId":"(\w+)"'
          url: '$${__value.raw}'
          datasourceUid: tempo
    uid: loki

  # ==========================================================================
  # Tempo - Distributed tracing (optional, if deployed)
  # ==========================================================================
  - name: Tempo
    type: tempo
    access: proxy
    orgId: 1
    url: http://tempo:3200
    basicAuth: false
    isDefault: false
    version: 1
    editable: false
    jsonData:
      httpMethod: GET
      tracesToLogsV2:
        datasourceUid: 'loki'
        spanStartTimeShift: '-1h'
        spanEndTimeShift: '1h'
        filterByTraceID: true
        filterBySpanID: true
      serviceMap:
        datasourceUid: 'prometheus'
      search:
        hide: false
      nodeGraph:
        enabled: true
    uid: tempo
