# Multi-stage Dockerfile for YAWL A2A Server
# Stage 1: Builder
FROM maven:3.9-eclipse-temurin-17 AS builder

WORKDIR /build

# Copy source code
COPY . .

# Build the project
RUN mvn -T 1.5C clean compile -pl yawl-engine,yawl-integration,yawl-mcp-a2a-app -am -DskipTests

# Stage 2: Runtime
FROM eclipse-temurin:25-jre-alpine

# Install curl for health checks
RUN apk add --no-cache curl

# Create non-root user
RUN addgroup -S yawl && \
    adduser -S dev -G yawl && \
    mkdir -p /app/classes /app/libs /app/logs && \
    chown -R dev:yawl /app

# Switch to non-root user
USER dev:yawl

# Set working directory
WORKDIR /app

# Copy compiled classes from builder
COPY --from=builder /build/yawl-engine/target/classes /app/classes
COPY --from=builder /build/yawl-integration/target/classes /app/classes
COPY --from=builder /build/yawl-mcp-a2a-app/target/classes /app/classes

# Copy dependencies
COPY --from=builder /build/yawl-engine/target/dependency/*.jar /app/libs/ 2>/dev/null || true
COPY --from=builder /build/yawl-integration/target/dependency/*.jar /app/libs/ 2>/dev/null || true
COPY --from=builder /build/yawl-mcp-a2a-app/target/dependency/*.jar /app/libs/ 2>/dev/null || true

# Copy the MCP-A2A app JAR
COPY --from=builder /build/yawl-mcp-a2a-app/target/yawl-mcp-a2a-app-6.0.0-Alpha.jar /app/libs/

# Environment variables
ENV JAVA_OPTS="-XX:+UseCompactObjectHeaders -XX:MaxRAMPercentage=75.0"
ENV JAVA_TOOL_OPTIONS="-Djava.security.egd=file:/dev/./urandom"

# Expose ports
EXPOSE 8080 8081 8082

# Health check
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:8081/health || exit 1

# Default command to start A2A server
CMD ["sh", "-c", "java $JAVA_OPTS -cp '/app/classes:/app/libs/*' org.yawlfoundation.yawl.integration.a2a.YawlA2AServer"]