# =============================================================================
# Dockerfile.engine.simplified - YAWL Engine Production Image
# =============================================================================
# Simplified YAWL workflow engine production image that:
# - Uses pre-built JARs if available (fallback to dependency)
# - Java 25 with virtual threads and ZGC
# - Health checks and observability
# - Non-root user for security
#
# Build:
#   docker build -t yawl-engine:6.0.0-alpha -f docker/production/Dockerfile.engine.simplified .
#
# Run:
#   docker run -p 8080:8080 -p 9090:9090 yawl-engine:6.0.0-alpha
# =============================================================================

# Use Eclipse Temurin JRE 25 Alpine as base
FROM eclipse-temurin:25-jre-alpine AS runtime

ARG BUILD_DATE
ARG VCS_REF
ARG VERSION=6.0.0-alpha

# OCI Image Labels
LABEL maintainer="YAWL Foundation"
LABEL description="YAWL Workflow Engine"
LABEL version="${VERSION}"
LABEL org.opencontainers.image.title="YAWL Engine"
LABEL org.opencontainers.image.description="Production-ready YAWL workflow engine with security hardening"
LABEL org.opencontainers.image.created="${BUILD_DATE}"
LABEL org.opencontainers.image.revision="${VCS_REF}"
LABEL org.opencontainers.image.vendor="YAWL Foundation"
LABEL org.opencontainers.image.version="${VERSION}"
LABEL org.opencontainers.image.source="https://github.com/yawlfoundation/yawl"
LABEL org.opencontainers.image.licenses="LGPL-3.0"

# Install runtime dependencies
RUN apk add --no-cache curl bash && \
    rm -rf /var/cache/apk/*

# Create non-root user for production security
RUN addgroup -S yawl --gid 1000 && \
    adduser -S dev --uid 1000 --ingroup yawl --home /home/dev --shell /bin/bash

# Create directories with proper ownership
RUN mkdir -p /app/logs /app/data /app/temp /app/config /app/specifications && \
    chown -R dev:yawl /app

# JVM optimizations for Java 25 with virtual threads and ZGC
ENV JAVA_OPTS="\
    -XX:+UseContainerSupport \
    -XX:MaxRAMPercentage=75.0 \
    -XX:InitialRAMPercentage=50.0 \
    -XX:+UseZGC \
    -XX:+UseCompactObjectHeaders \
    -XX:+UseStringDeduplication \
    -XX:+ExitOnOutOfMemoryError \
    -XX:+HeapDumpOnOutOfMemoryError \
    -XX:HeapDumpPath=/app/logs/heap-dump.hprof \
    -Djava.security.egd=file:/dev/./urandom \
    -Djava.io.tmpdir=/app/temp \
    -Dfile.encoding=UTF-8 \
    -Djdk.virtualThreadScheduler.parallelism=200 \
    -Djdk.virtualThreadScheduler.maxPoolSize=256 \
    -Djdk.tracePinnedThreads=short \
    -Djdk.tls.disabledAlgorithms=SSLv3,TLSv1,TLSv1.1,RC4,MD5,SHA-1,DES,3DES \
    -Djdk.certpath.disabledAlgorithms=MD2,MD5,SHA1,RSA\ keySize\ <3072 \
    -Djdk.jce.disabledAlgorithms=DES,3DES,RC4,Blowfish"

# Environment
ENV SPRING_PROFILES_ACTIVE=production
ENV DB_TYPE=h2
ENV TZ=UTC

# Copy JAR - check multiple locations for pre-built artifacts
COPY --chown=dev:yawl \
    ./yawl-mcp-a2a-app/yawl-mcp-a2a-app/target/dependency/yawl-engine-*.jar \
    /app/yawl-engine.jar || \
    COPY --chown=dev:yawl \
    ./yawl-engine/target/yawl-engine-*.jar \
    /app/yawl-engine.jar || \
    echo "No pre-built JAR found, will need to build first"

WORKDIR /app

# Switch to non-root user
USER dev

# Expose ports
EXPOSE 8080 9090

# Health check - Check if the engine is responding
HEALTHCHECK --interval=30s --timeout=10s --start-period=90s --retries=3 \
    CMD curl -sf http://localhost:8080/actuator/health/liveness || exit 1

# Create simple startup script
RUN cat > /app/start-engine.sh << 'EOF'
#!/bin/bash
set -euo pipefail

# Wait for database if needed
# TODO: Add database connection check here

# Start the YAWL Engine
echo "Starting YAWL Engine v6.0.0-Alpha..."
echo "JVM Options: $JAVA_OPTS"

# Run the engine with JVM options
exec java $JAVA_OPTS -jar yawl-engine.jar \
    --engine-url=http://localhost:8080 \
    --data-dir=/app/data \
    --log-dir=/app/logs \
    --temp-dir=/app/temp \
    --spec-dir=/app/specifications
EOF

RUN chmod +x /app/start-engine.sh

# Entry point
ENTRYPOINT ["sh", "/app/start-engine.sh"]