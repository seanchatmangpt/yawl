# =============================================================================
# Dockerfile.engine - YAWL Engine Production Image
# =============================================================================
# Production-ready YAWL workflow engine with:
# - Java 25 virtual threads for concurrent case execution
# - Generational ZGC for low-latency garbage collection
# - Health checks and observability
# - Non-root user for security
# - TLS 1.3+ enforcement (CNSA compliant)
#
# Build:
#   docker build -t yawl-engine:6.0.0-alpha -f docker/production/Dockerfile.engine .
#
# Run:
#   docker run -p 8080:8080 -p 9090:9090 yawl-engine:6.0.0-alpha
# =============================================================================

# Stage 1: Builder (Maven build)
# -----------------------------------------------------------------------------
FROM eclipse-temurin:25-jdk-alpine AS builder

# Install Maven
RUN apk add --no-cache maven

# Create working directory
WORKDIR /build

# Copy entire project (excludes handled by .dockerignore)
COPY . .

# Build the engine with dependencies
# -T 1.5C enables parallel builds (1.5 x CPU cores)
# -pl yawl-engine builds only the specified module
# -am builds required dependencies
# -DskipTests skips tests for faster builds
RUN mvn -T 1.5C clean package \
  -pl yawl-engine \
  -am \
  -DskipTests \
  -Dmaven.javadoc.skip

# Stage 2: Runtime (Minimal Java 25 JRE)
# -----------------------------------------------------------------------------
FROM eclipse-temurin:25-jre-alpine AS runtime

ARG BUILD_DATE
ARG VCS_REF
ARG VERSION=6.0.0-alpha

# OCI Image Labels
LABEL maintainer="YAWL Foundation"
LABEL description="YAWL Workflow Engine"
LABEL version="${VERSION}"
LABEL org.opencontainers.image.title="YAWL Engine"
LABEL org.opencontainers.image.description="Production-ready YAWL workflow engine with security hardening"
LABEL org.opencontainers.image.created="${BUILD_DATE}"
LABEL org.opencontainers.image.revision="${VCS_REF}"
LABEL org.opencontainers.image.vendor="YAWL Foundation"
LABEL org.opencontainers.image.version="${VERSION}"
LABEL org.opencontainers.image.source="https://github.com/yawlfoundation/yawl"
LABEL org.opencontainers.image.licenses="LGPL-3.0"

# Install runtime dependencies
RUN apk add --no-cache curl bash && \
    rm -rf /var/cache/apk/*

# Create non-root user (dev user for production security)
RUN addgroup -S yawl --gid 1000 && \
    adduser -S dev --uid 1000 --ingroup yawl --home /home/dev --shell /bin/bash

# Create directories with proper ownership
RUN mkdir -p /app/logs /app/data /app/temp /app/config /app/specifications /opt/yawl && \
    chown -R dev:yawl /app /opt/yawl

# JVM optimizations for Java 25 with Shenandoah GC and production tuning
ENV JAVA_OPTS="\
    -Xms4g -Xmx8g \
    -XX:+UseContainerSupport \
    -XX:+UseShenandoahGC \
    -XX:ShenandoahGCHeuristics=compact \
    -XX:+UseCompactObjectHeaders \
    -XX:+UseStringDeduplication \
    -XX:SharedArchiveFile=/app/classes.jsa \
    -XX:AOTCache=/app/aot.cache \
    --enable-preview \
    -XX:+ExitOnOutOfMemoryError \
    -XX:HeapDumpOnOutOfMemoryError \
    -XX:HeapDumpPath=/app/logs/heap-dump.hprof \
    -XX:MaxGCPauseMillis=50 \
    -XX:MaxRAMPercentage=75.0 \
    -XX:InitialRAMPercentage=50.0 \
    -Djava.security.egd=file:/dev/./urandom \
    -Djava.io.tmpdir=/app/temp \
    -Dfile.encoding=UTF-8 \
    -Djava.util.concurrent.ForkJoinPool.common.parallelism=8 \
    -Djdk.virtualThreadScheduler.parallelism=200 \
    -Djdk.virtualThreadScheduler.maxPoolSize=256 \
    -Djdk.tracePinnedThreads=short \
    -Djdk.tls.disabledAlgorithms=SSLv3,TLSv1,TLSv1.1,RC4,MD5,SHA-1,DES,3DES \
    -Djdk.certpath.disabledAlgorithms=MD2,MD5,SHA1,RSA\ keySize\ <3072 \
    -Djdk.jce.disabledAlgorithms=DES,3DES,RC4,Blowfish"

# Environment
ENV SPRING_PROFILES_ACTIVE=production
ENV DB_TYPE=h2
ENV TZ=UTC

# Copy built artifacts
COPY --from=builder --chown=dev:yawl /build/yawl-engine/target/yawl-engine-*.jar /opt/yawl/yawl-engine.jar
COPY --from=builder --chown=dev:yawl /build/yawl-elements/target/yawl-elements-*.jar /opt/yawl/lib/
COPY --from=builder --chown=dev:yawl /build/yawl-utilities/target/yawl-utilities-*.jar /opt/yawl/lib/

# Copy CDS and AOT caches if available
COPY --from=builder --chown=dev:yawl /build/scripts/cds/classes.jsa /opt/yawl/classes.jsa 2>/dev/null || true
COPY --from=builder --chown=dev:yawl /build/scripts/aot/aot.cache /opt/yawl/aot.cache 2>/dev/null || true

# Copy JAR to app directory for compatibility
COPY --from=builder --chown=dev:yawl /build/yawl-engine/target/yawl-engine-*.jar /app/yawl-engine.jar

WORKDIR /app

# Switch to non-root user
USER dev

# Expose ports
EXPOSE 8080 9090

# Health check (supports both YAWL health endpoint and actuator)
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD wget -q --spider http://localhost:8080/health || curl -sf http://localhost:8080/actuator/health/liveness || exit 1

# Default working directory
WORKDIR /app

# Alternative working directory for optimized JVM
WORKDIR /opt/yawl

# Entry point
ENTRYPOINT ["sh", "-c", "cd /opt/yawl && java $JAVA_OPTS -jar yawl-engine.jar"]
