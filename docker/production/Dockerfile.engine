# =============================================================================
# Dockerfile.engine â€” YAWL Engine Production Image
# =============================================================================
# Production-ready YAWL workflow engine with:
# - Java 25 virtual threads for concurrent case execution
# - Generational ZGC for low-latency garbage collection
# - Health checks and observability
# - Non-root user for security
# - TLS 1.3+ enforcement (CNSA compliant)
# - Security hardening (no secrets, minimal attack surface)
#
# Build:
#   docker build -t yawl-engine:6.0.0 -f docker/production/Dockerfile.engine .
#
# Run:
#   docker run -p 8080:8080 yawl-engine:6.0.0
# =============================================================================

# Stage 1: Build
FROM eclipse-temurin:25-jdk-alpine AS builder

WORKDIR /build

# Copy Maven files first for dependency caching
COPY pom.xml .
COPY .mvn .mvn
COPY mvnw .

# Copy module POMs
COPY yawl-utilities/pom.xml yawl-utilities/
COPY yawl-elements/pom.xml yawl-elements/
COPY yawl-authentication/pom.xml yawl-authentication/
COPY yawl-engine/pom.xml yawl-engine/
COPY yawl-stateless/pom.xml yawl-stateless/
COPY yawl-resourcing/pom.xml yawl-resourcing/
COPY yawl-scheduling/pom.xml yawl-scheduling/
COPY yawl-security/pom.xml yawl-security/
COPY yawl-integration/pom.xml yawl-integration/
COPY yawl-monitoring/pom.xml yawl-monitoring/
COPY yawl-webapps/pom.xml yawl-webapps/
COPY yawl-control-panel/pom.xml yawl-control-panel/

# Download dependencies
RUN ./mvnw dependency:go-offline -B -q || true

# Copy source code
COPY src ./src
COPY yawl-utilities/src ./yawl-utilities/src
COPY yawl-elements/src ./yawl-elements/src
COPY yawl-authentication/src ./yawl-authentication/src
COPY yawl-engine/src ./yawl-engine/src
COPY yawl-stateless/src ./yawl-stateless/src
COPY yawl-resourcing/src ./yawl-resourcing/src
COPY yawl-scheduling/src ./yawl-scheduling/src
COPY yawl-security/src ./yawl-security/src
COPY yawl-integration/src ./yawl-integration/src
COPY yawl-monitoring/src ./yawl-monitoring/src
COPY yawl-webapps/src ./yawl-webapps/src
COPY yawl-control-panel/src ./yawl-control-panel/src

# Build
RUN ./mvnw package -DskipTests -B -q

# Stage 2: Runtime
FROM eclipse-temurin:25-jre-alpine

ARG BUILD_DATE
ARG VCS_REF
ARG VERSION=6.0.0

# OCI Image Labels
LABEL maintainer="YAWL Foundation"
LABEL description="YAWL Workflow Engine"
LABEL version="${VERSION}"
LABEL org.opencontainers.image.title="YAWL Engine"
LABEL org.opencontainers.image.description="Production-ready YAWL workflow engine with security hardening"
LABEL org.opencontainers.image.created="${BUILD_DATE}"
LABEL org.opencontainers.image.revision="${VCS_REF}"
LABEL org.opencontainers.image.vendor="YAWL Foundation"
LABEL org.opencontainers.image.version="${VERSION}"
LABEL org.opencontainers.image.source="https://github.com/yawlfoundation/yawl"
LABEL org.opencontainers.image.licenses="LGPL-3.0"

# Install runtime dependencies
RUN apk add --no-cache curl bash && \
    rm -rf /var/cache/apk/*

# Create non-root user (dev user for production security)
RUN addgroup -S yawl --gid 1000 && \
    adduser -S dev --uid 1000 --ingroup yawl --home /home/dev --shell /bin/bash

# Create directories with proper ownership
RUN mkdir -p /app/logs /app/data /app/temp /app/config /app/specifications && \
    chown -R dev:yawl /app

# JVM optimizations for Java 25 with full TLS 1.3 enforcement
ENV JAVA_OPTS="\
    -XX:+UseContainerSupport \
    -XX:MaxRAMPercentage=75.0 \
    -XX:InitialRAMPercentage=50.0 \
    -XX:+UseZGC \
    -XX:+ZGenerational \
    -XX:+UseCompactObjectHeaders \
    -XX:+UseStringDeduplication \
    -XX:+UseAOTCache \
    -XX:+ExitOnOutOfMemoryError \
    -XX:+HeapDumpOnOutOfMemoryError \
    -XX:HeapDumpPath=/app/logs/heap-dump.hprof \
    -Djava.security.egd=file:/dev/./urandom \
    -Djava.io.tmpdir=/app/temp \
    -Dfile.encoding=UTF-8 \
    -Djdk.virtualThreadScheduler.parallelism=200 \
    -Djdk.virtualThreadScheduler.maxPoolSize=256 \
    -Djdk.tracePinnedThreads=short \
    -Djdk.tls.disabledAlgorithms=SSLv3,TLSv1,TLSv1.1,RC4,MD5,SHA-1,DES,3DES \
    -Djdk.certpath.disabledAlgorithms=MD2,MD5,SHA1,RSA\ keySize\ <3072 \
    -Djdk.jce.disabledAlgorithms=DES,3DES,RC4,Blowfish"

# Environment
ENV SPRING_PROFILES_ACTIVE=production
ENV DB_TYPE=h2
ENV TZ=UTC

# Copy JAR from builder
COPY --from=builder --chown=dev:yawl /build/yawl-engine/target/yawl-engine-*.jar /app/yawl-engine.jar

# Copy healthcheck
COPY docker/scripts/healthcheck.sh /app/healthcheck.sh
RUN chmod +x /app/healthcheck.sh && chown dev:yawl /app/healthcheck.sh

WORKDIR /app

# Switch to non-root user
USER dev

# Expose ports
EXPOSE 8080 9090

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=90s --retries=3 \
    CMD ["/app/healthcheck.sh"]

# Entry point
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar /app/yawl-engine.jar"]
