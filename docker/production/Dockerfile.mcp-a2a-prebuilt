# =============================================================================
# Dockerfile.mcp-a2a-prebuilt - Uses pre-built JAR for faster testing
# =============================================================================
# Use this when you already have a built JAR file.
# Build: docker build -t yawl-mcp-a2a:6.0.0-alpha -f docker/production/Dockerfile.mcp-a2a-prebuilt .
# =============================================================================

FROM eclipse-temurin:25-jre-alpine

# Install curl for health checks
RUN apk add --no-cache curl bash

# Create non-root user for security
RUN addgroup -S yawl && \
    adduser -S dev -G yawl && \
    mkdir -p /app /var/log/yawl && \
    chown -R dev:yawl /app /var/log/yawl

# Switch to non-root user
USER dev:yawl

# Set working directory
WORKDIR /app

# Copy pre-built JAR
COPY docker/production/app-fixed.jar app.jar

# Environment variables for optimization
ENV JAVA_OPTS="-XX:+UseZGC -XX:MaxRAMPercentage=75.0"
ENV JAVA_TOOL_OPTIONS="-Djava.security.egd=file:/dev/./urandom"

# Expose ports
# - 8080: Spring Boot application
# - 8081: MCP server
# - 8082: A2A agent
EXPOSE 8080 8081 8082

# Health check endpoints
HEALTHCHECK --interval=30s --timeout=5s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8080/actuator/health/liveness || exit 1

# Default command to start the application
# Use Spring Boot's JarLauncher directly since manifest is incomplete
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -cp app.jar org.springframework.boot.loader.launch.JarLauncher"]
