apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: yawl-task-executor
  namespace: yawl
  labels:
    app.kubernetes.io/name: yawl-task-executor
    app.kubernetes.io/component: serverless
    app.kubernetes.io/part-of: yawl
  annotations:
    # Scale to zero after 5 minutes of inactivity
    autoscaling.knative.dev/min-scale: "0"
    autoscaling.knative.dev/max-scale: "50"
    autoscaling.knative.dev/target: "10"
    autoscaling.knative.dev/scale-down-delay: "5m"
spec:
  template:
    metadata:
      labels:
        app.kubernetes.io/name: yawl-task-executor
        app.kubernetes.io/part-of: yawl
      annotations:
        autoscaling.knative.dev/min-scale: "0"
        autoscaling.knative.dev/max-scale: "50"
    spec:
      serviceAccountName: yawl-engine
      containerConcurrency: 5
      timeoutSeconds: 300
      containers:
        - image: yawl/task-executor:5.2
          ports:
            - containerPort: 8080
              protocol: TCP
          env:
            - name: YAWL_ENGINE_URL
              value: "http://yawl-engine.yawl.svc.cluster.local:8080"
            - name: EXECUTION_MODE
              value: "serverless"
            - name: JAVA_OPTS
              value: "-Xms64m -Xmx128m -XX:+UseSerialGC"
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 256Mi
          readinessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 3
            periodSeconds: 5
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1000
---
# KEDA ScaledObject: autoscales task executor pods based on YAWL work item queue depth
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: yawl-workitem-scaler
  namespace: yawl
  labels:
    app.kubernetes.io/name: yawl-workitem-scaler
    app.kubernetes.io/component: autoscaling
    app.kubernetes.io/part-of: yawl
spec:
  scaleTargetRef:
    name: yawl-engine
  pollingInterval: 15
  cooldownPeriod: 120
  minReplicaCount: 1
  maxReplicaCount: 10
  fallback:
    failureThreshold: 3
    replicas: 2
  triggers:
    # Scale based on YAWL work item queue depth via Prometheus
    - type: prometheus
      metadata:
        serverAddress: http://prometheus.yawl.svc.cluster.local:9090
        metricName: yawl_workitems_queued_total
        query: sum(yawl_workitems_queued_total{namespace="yawl"})
        threshold: "10"
        activationThreshold: "3"
    # Scale based on active case count
    - type: prometheus
      metadata:
        serverAddress: http://prometheus.yawl.svc.cluster.local:9090
        metricName: yawl_active_cases_total
        query: sum(yawl_active_cases_total{namespace="yawl"})
        threshold: "50"
        activationThreshold: "5"
---
# KEDA ScaledObject: scale resource service based on pending allocations
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: yawl-resource-allocation-scaler
  namespace: yawl
  labels:
    app.kubernetes.io/name: yawl-resource-scaler
    app.kubernetes.io/component: autoscaling
    app.kubernetes.io/part-of: yawl
spec:
  scaleTargetRef:
    name: yawl-resource-service
  pollingInterval: 15
  cooldownPeriod: 180
  minReplicaCount: 1
  maxReplicaCount: 8
  triggers:
    - type: prometheus
      metadata:
        serverAddress: http://prometheus.yawl.svc.cluster.local:9090
        metricName: yawl_pending_allocations_total
        query: sum(yawl_pending_allocations_total{namespace="yawl"})
        threshold: "20"
        activationThreshold: "5"
---
# Knative Eventing: route YAWL engine events to serverless handlers
apiVersion: eventing.knative.dev/v1
kind: Trigger
metadata:
  name: yawl-workitem-created
  namespace: yawl
  labels:
    app.kubernetes.io/part-of: yawl
spec:
  broker: default
  filter:
    attributes:
      type: io.yawl.workitem.created
  subscriber:
    ref:
      apiVersion: serving.knative.dev/v1
      kind: Service
      name: yawl-task-executor
---
apiVersion: eventing.knative.dev/v1
kind: Trigger
metadata:
  name: yawl-case-completed
  namespace: yawl
  labels:
    app.kubernetes.io/part-of: yawl
spec:
  broker: default
  filter:
    attributes:
      type: io.yawl.case.completed
  subscriber:
    ref:
      apiVersion: serving.knative.dev/v1
      kind: Service
      name: yawl-task-executor
