apiVersion: batch/v1
kind: CronJob
metadata:
  name: yawl-db-backup
  namespace: yawl
  labels:
    app.kubernetes.io/name: yawl-db-backup
    app.kubernetes.io/component: backup
    app.kubernetes.io/part-of: yawl
spec:
  schedule: "0 2 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 7
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backupLimit: 4
      activeDeadlineSeconds: 3600
      template:
        metadata:
          labels:
            app.kubernetes.io/name: yawl-db-backup
            app.kubernetes.io/component: backup
        spec:
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            fsGroup: 1000
          restartPolicy: OnFailure
          containers:
            - name: pg-backup
              image: postgres:15-alpine
              command:
                - /bin/sh
                - -c
                - |
                  set -euo pipefail
                  TIMESTAMP=$(date +%Y%m%d_%H%M%S)
                  BACKUP_FILE="/backups/yawl_${TIMESTAMP}.sql.gz"
                  echo "Starting YAWL database backup: ${BACKUP_FILE}"
                  pg_dump \
                    -h "${DATABASE_HOST}" \
                    -p "${DATABASE_PORT}" \
                    -U "${DATABASE_USER}" \
                    -d "${DATABASE_NAME}" \
                    --no-owner \
                    --no-privileges \
                    --format=custom \
                    | gzip > "${BACKUP_FILE}"
                  BACKUP_SIZE=$(stat -c%s "${BACKUP_FILE}" 2>/dev/null || echo "unknown")
                  echo "Backup completed: ${BACKUP_FILE} (${BACKUP_SIZE} bytes)"
                  # Prune backups older than 30 days
                  find /backups -name "yawl_*.sql.gz" -mtime +30 -delete
                  echo "Pruned backups older than 30 days"
              env:
                - name: DATABASE_HOST
                  valueFrom:
                    configMapKeyRef:
                      name: yawl-config
                      key: DATABASE_PATH
                - name: DATABASE_PORT
                  value: "5432"
                - name: DATABASE_USER
                  valueFrom:
                    secretKeyRef:
                      name: yawl-db-credentials
                      key: DATABASE_USER
                - name: DATABASE_NAME
                  value: yawl
                - name: PGPASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: yawl-db-credentials
                      key: DATABASE_PASSWORD
              resources:
                requests:
                  cpu: 100m
                  memory: 256Mi
                limits:
                  cpu: 500m
                  memory: 512Mi
              volumeMounts:
                - name: backup-storage
                  mountPath: /backups
          volumes:
            - name: backup-storage
              persistentVolumeClaim:
                claimName: yawl-db-backups
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: yawl-db-backups
  namespace: yawl
  labels:
    app.kubernetes.io/name: yawl-db-backups
    app.kubernetes.io/component: backup
    app.kubernetes.io/part-of: yawl
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 50Gi
