# Z.AI / ZHIPU API Secrets for YAWL MCP Server
#
# This manifest defines the Secret structure. The actual secret VALUES
# must never be stored in this file or committed to source control.
#
# Populate secrets using one of the following approaches:
#
# Option A: kubectl (manual, for development clusters)
#   kubectl create secret generic zai-secrets \
#     --namespace=yawl \
#     --from-literal=zhipu_api_key="${ZHIPU_API_KEY}" \
#     --dry-run=client -o yaml | kubectl apply -f -
#
# Option B: External Secrets Operator (recommended for production)
#   See zai-external-secret.yaml for ESO configuration with AWS Secrets Manager,
#   GCP Secret Manager, or HashiCorp Vault.
#
# Option C: Sealed Secrets (GitOps-safe encryption)
#   kubeseal --cert=pub-cert.pem < zai-secrets-plaintext.yaml > zai-secrets-sealed.yaml
#   # Commit the sealed file; never commit the plaintext.
#
# Key names used by the YAWL MCP Server deployment:
#   zhipu_api_key  - Primary ZHIPU AI API key (maps to ZAI_API_KEY env var)
#
# The MCP server reads ZAI_API_KEY at startup. If absent or empty,
# the yawl_natural_language tool is disabled. All other 15 MCP tools
# continue to function without the Z.AI key.
#
# Z.AI API documentation: https://open.bigmodel.cn/dev/api
# Model: GLM-4 (glm-4-0520) for function calling workflows

apiVersion: v1
kind: Secret
metadata:
  name: zai-secrets
  namespace: yawl
  labels:
    app.kubernetes.io/name: zai-secrets
    app.kubernetes.io/component: credentials
    app.kubernetes.io/part-of: yawl
    app.kubernetes.io/managed-by: kubectl
  annotations:
    # Rotation reminder: rotate ZHIPU API keys every 90 days
    # Last rotation: set via CI pipeline (see observatory-refresh workflow)
    secret.kubernetes.io/rotation-period: "90d"
    description: "Z.AI (ZHIPU) API credentials for YAWL natural language workflow tool"
# Type: Opaque - arbitrary key-value pairs (standard for API keys)
type: Opaque
# VALUES ARE INTENTIONALLY ABSENT - populate via CI/CD pipeline secret injection
# or External Secrets Operator. See comments above.
# data:
#   zhipu_api_key: <base64-encoded-key>

---
# External Secrets Operator configuration for AWS Secrets Manager
# Requires ExternalSecrets CRD to be installed in the cluster.
# Remove this block if not using ESO.
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: zai-secrets-eso
  namespace: yawl
  labels:
    app.kubernetes.io/name: zai-secrets-eso
    app.kubernetes.io/component: credentials
    app.kubernetes.io/part-of: yawl
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: yawl-secret-store
    kind: ClusterSecretStore
  target:
    name: zai-secrets
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: zai-secrets
          app.kubernetes.io/component: credentials
          app.kubernetes.io/part-of: yawl
  data:
    - secretKey: zhipu_api_key
      remoteRef:
        # AWS Secrets Manager path: /yawl/production/zai/zhipu_api_key
        # GCP Secret Manager: projects/PROJECT/secrets/yawl-zhipu-api-key
        # HashiCorp Vault:    secret/yawl/production/zai#zhipu_api_key
        key: /yawl/production/zai/zhipu_api_key
