# Fluent Bit Configuration for YAWL Workflow Engine
# Collects logs from YAWL services, enriches with metadata, and forwards to multiple destinations

[SERVICE]
    # Service configuration
    Flush           5
    Daemon          Off
    Log_Level       info
    Log_File        /var/log/fluent-bit/fluent-bit.log
    Parsers_File    parsers.conf
    Plugins_File    plugins.conf

    # HTTP Server for monitoring
    HTTP_Server     On
    HTTP_Listen     0.0.0.0
    HTTP_Port       2020
    Health_Check    On

    # Storage/Buffer configuration
    storage.path               /var/log/fluent-bit/buffer
    storage.sync               normal
    storage.checksum           off
    storage.backlog.mem_limit  50M
    storage.max_chunks_up      128
    storage.metrics            on

# Input: YAWL Engine logs (Java application)
[INPUT]
    Name              tail
    Tag               yawl.engine
    Path              /var/log/yawl/engine/*.log
    Path_Key          filename
    Exclude_Path      *.gz, *.zip
    Refresh_Interval  5
    Rotate_Wait       30
    Skip_Long_Lines   On
    Skip_Empty_Lines  On
    DB                /var/log/fluent-bit/tail_engine.db
    Mem_Buf_Limit     50MB
    Buffer_Chunk_Size 512KB
    Buffer_Max_Size   5MB
    Read_from_Head    Off
    multiline.parser  java_multiline

# Input: YAWL Resource Service logs
[INPUT]
    Name              tail
    Tag               yawl.resource
    Path              /var/log/yawl/resource-service/*.log
    Path_Key          filename
    Refresh_Interval  5
    Rotate_Wait       30
    Skip_Long_Lines   On
    DB                /var/log/fluent-bit/tail_resource.db
    Mem_Buf_Limit     50MB
    multiline.parser  java_multiline

# Input: YAWL Worklet Service logs
[INPUT]
    Name              tail
    Tag               yawl.worklet
    Path              /var/log/yawl/worklet-service/*.log
    Path_Key          filename
    Refresh_Interval  5
    Rotate_Wait       30
    Skip_Long_Lines   On
    DB                /var/log/fluent-bit/tail_worklet.db
    Mem_Buf_Limit     50MB
    multiline.parser  java_multiline

# Input: YAWL Monitor Service logs
[INPUT]
    Name              tail
    Tag               yawl.monitor
    Path              /var/log/yawl/monitor-service/*.log
    Path_Key          filename
    Refresh_Interval  5
    Rotate_Wait       30
    Skip_Long_Lines   On
    DB                /var/log/fluent-bit/tail_monitor.db
    Mem_Buf_Limit     50MB
    multiline.parser  java_multiline

# Input: System logs (syslog)
[INPUT]
    Name              syslog
    Tag               system.syslog
    Parser            syslog-rfc5424
    Listen            0.0.0.0
    Port              5140
    Mode              tcp
    Chunk_Size        32KB
    Buffer_Size       64KB

# Input: Docker container logs (when running in containers)
[INPUT]
    Name              tail
    Tag               docker.*
    Path              /var/lib/docker/containers/*/*.log
    Parser            docker
    DB                /var/log/fluent-bit/tail_docker.db
    Mem_Buf_Limit     100MB
    Skip_Long_Lines   On
    Refresh_Interval  10
    Rotate_Wait       30

# Input: Kubernetes logs (when deployed in K8s)
[INPUT]
    Name              tail
    Tag               kube.*
    Path              /var/log/containers/*.log
    Parser            docker
    DB                /var/log/fluent-bit/tail_kube.db
    Mem_Buf_Limit     100MB
    Skip_Long_Lines   On
    Refresh_Interval  10
    Rotate_Wait       30

# Filter: Add hostname and timestamp
[FILTER]
    Name        record_modifier
    Match       yawl.*
    Record      hostname ${HOSTNAME}
    Record      collected_at ${TIMESTAMP}
    Record      environment production

# Filter: Enrich with YAWL-specific metadata
[FILTER]
    Name        lua
    Match       yawl.*
    Script      /etc/fluent-bit/lua/yawl_enrich.lua
    Call        enrich_yawl_log

# Filter: Extract case IDs and task IDs from log messages
[FILTER]
    Name        parser
    Match       yawl.*
    Key_Name    log
    Parser      yawl_case_id
    Reserve_Data On

# Filter: Add Kubernetes metadata
[FILTER]
    Name                kubernetes
    Match               kube.*
    Kube_URL            https://kubernetes.default.svc:443
    Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
    Kube_Tag_Prefix     kube.var.log.containers.
    Merge_Log           On
    Merge_Log_Trim      On
    Keep_Log            Off
    K8s-Logging.Parser  On
    K8s-Logging.Exclude On
    Labels              On
    Annotations         On

# Filter: Grep for errors and warnings
[FILTER]
    Name        grep
    Match       yawl.*
    Regex       log (ERROR|WARN|Exception|Failed|Timeout)

# Filter: Deduplicate logs
[FILTER]
    Name        dedot
    Match       *
    Field       kubernetes.labels.*
    Field       kubernetes.annotations.*
    Separator   _

# Filter: Sampling for high-volume non-error logs
[FILTER]
    Name        record_modifier
    Match       yawl.*
    Condition   Key_Value_Equals level DEBUG
    Record      sampled true

# Output: Elasticsearch / OpenSearch
[OUTPUT]
    Name            es
    Match           yawl.*
    Host            elasticsearch
    Port            9200
    Index           yawl-logs-%Y.%m.%d
    Logstash_Format On
    Logstash_Prefix yawl-logs
    Logstash_DateFormat %Y.%m.%d
    Time_Key        @timestamp
    Time_Key_Format %Y-%m-%dT%H:%M:%S.%LZ
    TLS             Off
    HTTP_User       ${ES_USER}
    HTTP_Passwd     ${ES_PASSWORD}
    Compress        gzip
    Buffer_Size     16KB
    Path            /es
    Trace_Error     On
    Trace_Output    Off
    Replace_Dots    On

# Output: Loki (Grafana Cloud / Loki stack)
[OUTPUT]
    Name            loki
    Match           yawl.*
    Host            loki
    Port            3100
    Tenant_ID       yawl-workflows
    Labels          job=yawl, service=engine, environment=production
    Label_keys      level, case_id, task_id
    Remove_keys     level, case_id, task_id
    Line_Key        log
    Drop_single_key On
    Batch_Wait      5s
    Batch_Size      10MB
    Compress        gzip

# Output: Kafka for stream processing
[OUTPUT]
    Name            kafka
    Match           yawl.*
    Brokers         kafka-1:9092,kafka-2:9092,kafka-3:9092
    Topics          yawl-logs
    Timestamp_Key   @timestamp
    Retry_Limit     false
    rdkafka.debug   all
    rdkafka.log.connection.close false
    rdkafka.log.thread.name false
    rdkafka.request.required.acks 1
    rdkafka.queue.buffering.max.messages 100000
    rdkafka.queue.buffering.max.kbytes 1048576
    rdkafka.queue.buffering.max.ms 50
    rdkafka.message.send.max.retries 3
    rdkafka.retry.backoff.ms 200
    rdkafka.compression.codec snappy

# Output: Standard output (for debugging)
[OUTPUT]
    Name            stdout
    Match           *
    Format          json_lines
    Json_date_key   timestamp
    Json_date_format iso8601

# Output: File for backup
[OUTPUT]
    Name            file
    Match           yawl.*
    Path            /var/log/fluent-bit/output/yawl-backup.log
    Format          plain
    Mkdir           true

# Output: Prometheus metrics from logs
[OUTPUT]
    Name            prometheus_exporter
    Match           yawl.*
    Host            0.0.0.0
    Port            2021
    Add_label       app yawl
    Metrics_counter yawl_log_lines_total
    Metrics_gauge   yawl_log_bytes_total

# Custom parsers
@INCLUDE parsers.conf
