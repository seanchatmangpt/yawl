# =============================================================================
# YAWL v6.0.0 â€“ Automated CVE Scanning for Maven Dependencies
# =============================================================================
# Triggers: Push to main/release branches, PRs to main, scheduled daily
# Gates: OWASP Dependency-Check scans all transitive dependencies
# Reports: HTML/JSON/XML to GitHub Artifacts + PR comments
# Failures: Build fails on HIGH/CRITICAL CVEs (CVSS >= 7.0)
# =============================================================================
name: CVE Scanning - Maven Dependencies

on:
  push:
    branches: [main, "release/**"]
    paths:
      - "pom.xml"
      - "**/pom.xml"
      - "owasp-suppressions.xml"
      - ".github/workflows/cve-scanning.yml"
  pull_request:
    branches: [main]
    paths:
      - "pom.xml"
      - "**/pom.xml"
      - "owasp-suppressions.xml"
  schedule:
    # Daily CVE database update + scan at 02:00 UTC
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      profiles:
        description: "Maven profiles to apply (e.g., security-audit,ci-security)"
        required: false
        default: "ci-security"
      fail_threshold:
        description: "CVSS threshold to fail build (7.0 = HIGH+)"
        required: false
        default: "7.0"

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

permissions:
  contents: read
  pull-requests: write
  security-events: write

env:
  JAVA_VERSION: "25"
  MAVEN_BATCH_FLAGS: --batch-mode --no-transfer-progress
  REPORT_DIR: target/dependency-check

jobs:
  # ===========================================================================
  # CVE Scan - OWASP Dependency-Check
  # ===========================================================================
  cve-scan:
    name: OWASP Dependency-Check Scan
    runs-on: ubuntu-latest
    timeout-minutes: 30

    outputs:
      report_url: ${{ steps.upload-reports.outputs.artifact_url }}
      cves_found: ${{ steps.scan.outputs.cves_found }}
      high_cves: ${{ steps.scan.outputs.high_cves }}
      critical_cves: ${{ steps.scan.outputs.critical_cves }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: temurin
          cache: maven

      - name: Run CVE scan (dependency-check)
        id: scan
        run: |
          set +e  # Don't exit on failure; we'll parse results

          # Determine profile to use
          PROFILE="${{ github.event.inputs.profiles || 'ci-security' }}"

          echo "Starting OWASP Dependency-Check scan..."
          echo "Profile: $PROFILE"
          echo "---"

          # Run dependency-check with specified profile
          mvn clean verify \
            -P "$PROFILE" \
            ${{ env.MAVEN_BATCH_FLAGS }} \
            -DskipTests \
            -DskipITs \
            2>&1 | tee /tmp/cve-scan.log

          SCAN_EXIT=$?
          echo "Scan exit code: $SCAN_EXIT"

          # Parse results from JSON report
          if [ -f "${{ env.REPORT_DIR }}/dependency-check-report.json" ]; then
            # Count CVEs by severity using jq
            TOTAL_CVES=$(jq '.reportSchema // .reportVersion | length' "${{ env.REPORT_DIR }}/dependency-check-report.json" 2>/dev/null || echo "0")
            
            # Try to extract CVSS scores and count by severity
            # This is a simplified parse; full parsing is in post-processing
            HIGH_CVES=$(grep -c '"cvssScore":7\|"cvssScore":8\|"cvssScore":9' "${{ env.REPORT_DIR }}/dependency-check-report.json" 2>/dev/null || echo "0")
            CRITICAL_CVES=$(grep -c '"cvssScore":9\.' "${{ env.REPORT_DIR }}/dependency-check-report.json" 2>/dev/null || echo "0")

            echo "cves_found=detected" >> $GITHUB_OUTPUT
            echo "high_cves=$HIGH_CVES" >> $GITHUB_OUTPUT
            echo "critical_cves=$CRITICAL_CVES" >> $GITHUB_OUTPUT

            echo "Results:"
            echo "  High severity CVEs: $HIGH_CVES"
            echo "  Critical severity CVEs: $CRITICAL_CVES"
          else
            echo "cves_found=none" >> $GITHUB_OUTPUT
            echo "high_cves=0" >> $GITHUB_OUTPUT
            echo "critical_cves=0" >> $GITHUB_OUTPUT
            echo "No CVE report found"
          fi

          # Return original exit code for gate enforcement
          exit $SCAN_EXIT

      - name: Parse CVE report
        id: parse
        if: always()
        run: |
          # Generate summary from JSON report
          if [ -f "${{ env.REPORT_DIR }}/dependency-check-report.json" ]; then
            echo "## CVE Scan Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Report Location:** \`${{ env.REPORT_DIR }}/dependency-check-report.html\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Count vulnerabilities (requires jq)
            which jq >/dev/null 2>&1 && {
              VULN_COUNT=$(jq '.reportSchema.dependencies[].vulnerabilities[] | .cve' "${{ env.REPORT_DIR }}/dependency-check-report.json" 2>/dev/null | wc -l)
              echo "**Total Vulnerabilities Found:** $VULN_COUNT" >> $GITHUB_STEP_SUMMARY
            } || {
              echo "**Report Format:** JSON (full analysis in artifacts)" >> $GITHUB_STEP_SUMMARY
            }

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Thresholds:**" >> $GITHUB_STEP_SUMMARY
            echo "- CVSS >= 7.0 (HIGH+): âŒ FAIL" >> $GITHUB_STEP_SUMMARY
            echo "- CVSS 4.0-6.9 (MEDIUM): âš ï¸ WARN" >> $GITHUB_STEP_SUMMARY
            echo "- CVSS < 4.0 (LOW): âœ… INFO" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Suppressions:** See \`owasp-suppressions.xml\` for accepted risks" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload CVE reports as artifacts
        id: upload-reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cve-reports-${{ github.run_number }}
          path: |
            ${{ env.REPORT_DIR }}/dependency-check-report.html
            ${{ env.REPORT_DIR }}/dependency-check-report.json
            ${{ env.REPORT_DIR }}/dependency-check-report.xml
          retention-days: 90
          if-no-files-found: warn

      - name: Comment PR with CVE summary
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = '${{ env.REPORT_DIR }}/dependency-check-report.json';

            let comment = '## ðŸ”’ CVE Scan Results\n\n';

            if (fs.existsSync(reportPath)) {
              try {
                const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
                comment += 'âœ… Scan completed\n\n';
                comment += '**Threshold:** CVSS >= 7.0 (HIGH+) fails build\n\n';
                comment += 'ðŸ“Š [View Full Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n';
              } catch (e) {
                comment += 'âš ï¸ Report generated (view in artifacts)\n\n';
              }
            } else {
              comment += 'âŒ No report generated\n\n';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Upload SARIF report for GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ env.REPORT_DIR }}/dependency-check-report.json
          category: cve-scanning
        continue-on-error: true

  # ===========================================================================
  # Summary - Report results to CI/CD pipeline
  # ===========================================================================
  summary:
    name: CVE Scan Summary
    runs-on: ubuntu-latest
    needs: cve-scan
    if: always()

    steps:
      - name: Print summary
        run: |
          echo "## CVE Scanning Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ needs.cve-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Reports:**" >> $GITHUB_STEP_SUMMARY
          echo "- CVEs Found: ${{ needs.cve-scan.outputs.cves_found }}" >> $GITHUB_STEP_SUMMARY
          echo "- High Severity: ${{ needs.cve-scan.outputs.high_cves }}" >> $GITHUB_STEP_SUMMARY
          echo "- Critical: ${{ needs.cve-scan.outputs.critical_cves }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Review reports in Actions artifacts" >> $GITHUB_STEP_SUMMARY
          echo "2. Check \`owasp-suppressions.xml\` for suppressed CVEs" >> $GITHUB_STEP_SUMMARY
          echo "3. If HIGH+ found: Create issue to remediate" >> $GITHUB_STEP_SUMMARY
          echo "4. Document accepted risks in suppressions file" >> $GITHUB_STEP_SUMMARY

      - name: Fail if HIGH/CRITICAL CVEs found
        if: needs.cve-scan.result == 'failure'
        run: |
          echo "::error::CVE scan detected HIGH/CRITICAL vulnerabilities (CVSS >= 7.0)"
          echo ""
          echo "Build FAILED due to dependency vulnerabilities."
          echo "You must remediate or suppress (with justification) before merging."
          exit 1
