name: YAWL Validation

on:
  push:
    branches: [ master, main, claude/* ]
  pull_request:
    branches: [ master, main ]

jobs:
  validation:
    name: YAWL Validation
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        java-version: [17, 21]
        os: [ubuntu-latest, macos-latest]
        
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for accurate change detection
        
    - name: Set up JDK ${{ matrix.java-version }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java-version }}
        distribution: temurin
        
    - name: Cache Maven packages and dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-
          
    - name: Validate Java compilation
      run: |
        ./scripts/dx.sh compile
        
    - name: Run validation scripts
      run: |
        ./scripts/validation/validate-80-20.sh --mode ci --json --junit
      continue-on-error: false
      
    - name: Upload validation results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: validation-results-${{ matrix.java-version }}-${{ matrix.os }}
        path: |
          validation-results.json
          validation-results.xml
          
  parallel-validation:
    name: Parallel Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: 21
        distribution: temurin
        
    - name: Cache Maven packages and dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ubuntu-latest-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ubuntu-latest-maven-
          
    - name: Run parallel validation
      run: |
        ./scripts/validation/validate-80-20.sh --mode ci --parallel --json --junit
      continue-on-error: false
      
    - name: Upload parallel validation results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: parallel-validation-results
        path: |
          validation-results.json
          validation-results.xml
          
  comprehensive-validation:
    name: Comprehensive Validation
    runs-on: ubuntu-latest
    needs: validation
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: 21
        distribution: temurin
        
    - name: Cache Maven packages and dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ubuntu-latest-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ubuntu-latest-maven-
          
    - name: Run full validation with Maven
      run: |
        ./scripts/validation/validate-80-20.sh --mode full --json --junit
        
    - name: Upload comprehensive results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: comprehensive-validation-results
        path: |
          validation-results.json
          validation-results.xml
          
    - name: Publish test results
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always()
      with:
        files: validation-results.xml
        check_name: Validation Results
        
    - name: Upload JSON results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: validation-json-results
        path: validation-results.json
