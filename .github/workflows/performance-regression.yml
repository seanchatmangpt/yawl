name: Performance Regression Detection

on:
  push:
    branches: [ master, main, develop ]
    paths:
      - 'src/org/yawlfoundation/yawl/performance/**'
      - 'test/org/yawlfoundation/yawl/performance/**'
      - 'scripts/regression-detection.sh'
  pull_request:
    branches: [ master, main ]
    paths:
      - 'src/org/yawlfoundation/yawl/performance/**'
      - 'test/org/yawlfoundation/yawl/performance/**'
      - 'scripts/regression-detection.sh'
  schedule:
    # Run performance regression check every Sunday at 2 AM UTC
    - cron: '0 2 * * 0'

jobs:
  regression-detection:
    name: Performance Regression Detection
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate baseline comparison

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      - name: Install dependencies
        run: |
          # Install JMH and benchmark dependencies
          cd yawl-performance
          mvn clean install -DskipTests
          
          # Install script dependencies
          sudo apt-get update
          sudo apt-get install -y jq bc
      
      - name: Run regression detection
        env:
          CI_MODE: true
          SAVE_BASELINE: true
          CLEANUP_OLD: true
        run: |
          cd yawl-performance
          chmod +x ../scripts/regression-detection.sh
          ../scripts/regression-detection.sh \
            --ci-mode \
            --save-baseline \
            --cleanup-old \
            --threshold 20 \
            --p-value 0.05 \
            --output regression-results.md

      - name: Upload performance report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-regression-report
          path: |
            yawl-performance/regression-results.md
            yawl-performance/performance/results/
            yawl-performance/performance/reports/

      - name: Comment on PR
        if: github.event_name == 'pull_request' && github.event.action == 'opened'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'yawl-performance/regression-results.md';
            
            if (fs.existsSync(path)) {
              const report = fs.readFileSync(path, 'utf8');
              
              const comment = `
              üîç **Performance Regression Detection Results**
              
              ${report}
              
              ---
              *Generated by YAWL Performance Regression Detection Framework*
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      - name: Slack notification
        if: failure()
        uses: rtCamp/action-slack-notify@v2.0.0
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_CHANNEL: '#performance-alerts'
          SLACK_USERNAME: 'yawl-bot'
          SLACK_COLOR: 'danger'
        with:
          status: 'failure'
          fields: |
            { "title": "Performance Regression Detected", "value": "Performance regression detected in YAWL workflow engine. See report for details." }

  performance-trend-analysis:
    name: Performance Trend Analysis
    runs-on: ubuntu-latest
    needs: regression-detection
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run trend analysis
        run: |
          cd yawl-performance
          chmod +x ../scripts/regression-detection.sh
          ../scripts/regression-detection.sh \
            --ci-mode \
            --threshold 10 \
            --output trend-analysis.md

      - name: Generate trend visualization
        run: |
          # Generate simple trend chart using gnuplot
          cd yawl-performance
          gnuplot -e "
            set terminal pngcairo size 1200 800 enhanced font 'arial,12'
            set output 'performance-trend.png'
            set title 'YAWL Performance Trend Analysis'
            set xlabel 'Timestamp'
            set ylabel 'Response Time (ms)'
            set grid
            plot 'performance/baselines/baseline-*.json' using 1:2 with linespoints title 'P95 Latency'
          "

      - name: Upload trend analysis
        uses: actions/upload-artifact@v4
        with:
          name: performance-trend-analysis
          path: |
            yawl-performance/trend-analysis.md
            yawl-performance/performance-trend.png

  benchmark-optimization:
    name: Benchmark Optimization Check
    runs-on: ubuntu-latest
    needs: regression-detection
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run optimization benchmarks
        run: |
          cd yawl-performance
          chmod +x ../scripts/regression-detection.sh
          ../scripts/regression-detection.sh \
            --ci-mode \
            --threshold 5 \
            --save-baseline \
            --output optimization-report.md

      - name: Check for optimization opportunities
        run: |
          # Analyze baseline for optimization opportunities
          cd yawl-performance
          if grep -q "üî¥ REGRESSION" optimization-report.md; then
            echo "::warning::Performance issues detected. Review optimization-report.md for details."
          else
            echo "‚úÖ Performance is within optimization targets."
          fi

      - name: Create optimization issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'yawl-performance/optimization-report.md';
            
            if (fs.existsSync(path)) {
              const report = fs.readFileSync(path, 'utf8');
              
              const issueBody = `
              ## Performance Optimization Required

              Performance regression detected. Below are the affected metrics:

              ${report}

              ### Recommended Actions

              1. Review the affected benchmark suites
              2. Investigate recent code changes
              3. Implement optimizations
              4. Re-run regression detection after fixes

              ### Priority Level

              Based on the regression severity, please assign appropriate priority.

              ---
              Generated by YAWL Performance Regression Detection Framework
              `;
              
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Performance Regression: Requires Investigation',
                body: issueBody,
                labels: ['performance', 'regression', 'optimization']
              });
            }
