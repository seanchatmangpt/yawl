# YAWL CI/CD GitHub Actions Integration

This document describes the GitHub Actions workflow for YAWL's validation gates integration (Λ phase of CLAUDE.md).

## Overview

The workflow `validate-gates.yml` automatically runs YAWL's build and validation gates (`scripts/dx.sh all`) on every push to main/develop branches and on pull requests.

**Key features:**
- Automatic validation on push and pull request
- Parallel execution via concurrency rules (cancels in-progress runs)
- Receipt file archival for inspection
- GitHub job summary with violation details
- Clear pass/fail status for CI/CD integration

## Workflow File

**Location**: `.github/workflows/validate-gates.yml`

**Trigger Configuration**:
- Push to `main` or `develop` branches
- Pull requests targeting `main` or `develop` branches

**Concurrency**:
- Group: `validate-${{ github.ref }}` (per branch)
- Cancels in-progress runs on new push (prevents CI queue buildup)

**Timeout**: 30 minutes

## Workflow Steps

### Step 1: Checkout Code
Standard GitHub Actions checkout with full history (`fetch-depth: 0`) to support git operations.

### Step 2: Set up Java 25
- Distribution: Temurin (OpenJDK)
- Version: 25
- Maven cache enabled for faster builds

### Step 3: Run YAWL Build & Validation Gates
Executes: `bash scripts/dx.sh all`

This runs the complete validation pipeline:
- **Phase Λ (Build)**: Compile checks
- **Phase H (Guards)**: Hyper-standards validation (TODO, MOCK, STUB, etc.)
- **Phase Q (Invariants)**: Real implementation verification (no silent fallbacks)

Environment: `CLAUDE_CODE_REMOTE=true` enables Maven proxy auto-configuration.

### Step 4: Archive Validation Receipts
Uploads receipt files from `.yawl/.dx-state/` to GitHub Actions artifacts.

**Retention**: 30 days
**If no files found**: Ignored (graceful degradation)

### Step 5: Parse & Report Validation Results
Runs `scripts/validate-receipts.sh check-all .yawl/.dx-state/`

Checks all receipt files and stores exit code:
- **0**: All GREEN or no violations
- **2**: Violations detected (RED status)

Exit code stored in GitHub output: `receipt_status`

### Step 6: Generate GitHub Job Summary
Formats receipt data as markdown and writes to `$GITHUB_STEP_SUMMARY`

For each receipt file:
1. Extracts phase name (guards, invariants)
2. Shows status (GREEN ✓ or RED ✗)
3. Lists files scanned and violation count
4. Shows pattern breakdown (if available)
5. Lists top violations with fix guidance

**Output format**: GitHub-flavored markdown

### Step 7: Fail if Violations Detected
Conditionally fails the job if `receipt_status == 2`

Only runs if previous step succeeded (always() condition)

### Step 8: Success Summary
Displays success message if all gates passed

## Receipt File Format

Receipts are JSON files generated by dx.sh phases. Two main types:

### Guard Receipt (`.yawl/.dx-state/guard-receipt.json`)

```json
{
  "phase": "guards",
  "timestamp": "2026-02-28T21:00:00Z",
  "emit_directory": "/path/to/code",
  "files_scanned": 42,
  "violations": [
    {
      "pattern": "H_TODO",
      "severity": "FAIL",
      "file": "Test.java",
      "line": 10,
      "content": "// TODO: implement",
      "fix_guidance": "Implement real logic or throw..."
    }
  ],
  "summary": {
    "h_todo_count": 1,
    "h_mock_count": 0,
    "h_mock_class_count": 0,
    "h_silent_count": 0,
    "total_violations": 1
  },
  "status": "RED"
}
```

### Invariant Receipt (`.yawl/.dx-state/invariant-receipt.json`)

```json
{
  "phase": "invariants",
  "timestamp": "2026-02-28T21:00:00Z",
  "code_directory": ".",
  "java_files_scanned": 2143,
  "violations_found": 3,
  "violations_by_type": {
    "Q1_empty_methods": 3,
    "Q2_mock_classes": 0,
    "Q3_silent_fallbacks": 0
  },
  "status": "RED",
  "passing_rate": "99.9%",
  "severity": "ERROR",
  "next_action": "Fix violations and re-run"
}
```

## Receipt Validation Utility

**Location**: `scripts/validate-receipts.sh`

This utility parses JSON receipts and reports results for CI/CD integration.

### Functions

#### `parse_receipt_json <receipt_file>`
Reads receipt and extracts metadata into shell variables:
- `RECEIPT_STATUS` (GREEN|RED|UNKNOWN)
- `FILES_SCANNED` (number)
- `TOTAL_VIOLATIONS` (number)
- `PHASE` (guards|invariants)

**Exit code**: 0 if successful, 1 if file not found or malformed JSON

**Usage**:
```bash
bash scripts/validate-receipts.sh parse guard-receipt.json
# Sets: RECEIPT_STATUS, FILES_SCANNED, TOTAL_VIOLATIONS, PHASE
```

#### `check_receipt_status <receipt_file>`
Returns exit code based on receipt status.

**Exit codes**:
- 0 if status is GREEN
- 2 if status is RED
- 1 if error (file not found, parse error)

**Usage**:
```bash
if bash scripts/validate-receipts.sh check guard-receipt.json; then
  echo "Validation passed"
fi
```

#### `summarize_violations <receipt_file> [limit]`
Extracts top N violations and formats for display.

**Parameters**:
- `receipt_file`: Path to receipt JSON
- `limit`: Max violations to show (default: 10)

**Output**: Formatted violation list with pattern, file, line, content

**Usage**:
```bash
bash scripts/validate-receipts.sh summarize guard-receipt.json 5
```

#### `format_for_github <receipt_file>`
Formats receipt as GitHub markdown for job summary.

**Output**: Markdown with status emoji, summary, pattern breakdown, top violations

**Usage in GitHub Actions**:
```bash
echo "$(bash scripts/validate-receipts.sh format-github guard-receipt.json)" >> $GITHUB_STEP_SUMMARY
```

**Example output**:
```markdown
## ✅ Validation Report: Phase 'guards'

**Status**: `GREEN`

### Summary
- **Files Scanned**: 42
- **Violations Found**: 0

No violations detected. ✓
```

#### `check_all_receipts <directory>`
Checks all receipt files in directory and returns aggregate status.

**Exit codes**:
- 0 if all receipts are GREEN or no receipts found
- 2 if any receipt is RED
- 1 if error

**Usage**:
```bash
bash scripts/validate-receipts.sh check-all .yawl/.dx-state/
```

**Output**:
```
Checking receipt: .yawl/.dx-state/guard-receipt.json
Checking receipt: .yawl/.dx-state/invariant-receipt.json

================================
Receipts checked: 2
Failed receipts: 1
  - .yawl/.dx-state/invariant-receipt.json
================================
```

## Usage Examples

### Local Development

**Check validation before commit**:
```bash
# Run validation gates locally
bash scripts/dx.sh all

# Check results
bash scripts/validate-receipts.sh check-all .yawl/.dx-state/
```

**Inspect specific violations**:
```bash
# Show detailed violations
bash scripts/validate-receipts.sh format-github .yawl/.dx-state/guard-receipt.json

# Show top 10 violations
bash scripts/validate-receipts.sh summarize .yawl/.dx-state/guard-receipt.json 10
```

### GitHub Actions

The workflow runs automatically on push and PR. To manually trigger:

```bash
# Via GitHub CLI
gh workflow run validate-gates.yml
```

### Troubleshooting

**Workflow fails but no receipts**:
- Check if dx.sh exited early (missing dependencies, compile errors)
- Review dx.sh output in workflow logs

**Job summary not showing violations**:
- Verify `validate-receipts.sh format-github` is executable
- Check receipt file exists at `.yawl/.dx-state/*-receipt.json`

**False positive violations**:
- Review fix guidance in receipt
- May need to implement real logic or throw exception
- See HYPER_STANDARDS.md for complete rules

## Integration with Development Workflow

### Before Pushing
```bash
bash scripts/dx.sh all
bash scripts/validate-receipts.sh check-all .yawl/.dx-state/
```

If exit code is 2, fix violations before pushing:
```bash
# View violations
bash scripts/validate-receipts.sh format-github .yawl/.dx-state/guard-receipt.json

# Fix issues and re-run
bash scripts/dx.sh all
```

### On GitHub
- Workflow runs automatically
- Job summary shows pass/fail and violation details
- PR blocks merge if violations detected (depends on branch protection rules)

### In CD/Deployment
- Validation gates must pass before deployment
- Exit code 0: Safe to proceed
- Exit code 2: Block deployment, require fixes

## Performance Characteristics

- **Workflow execution**: ~10-15 minutes on ubuntu-latest
- **Receipt generation**: Included in dx.sh timing
- **Receipt parsing**: <1 second per receipt
- **GitHub summary generation**: <5 seconds

## CI/CD Environment Variables

When running in GitHub Actions:

- `CLAUDE_CODE_REMOTE=true`: Enables Maven proxy auto-configuration
- `GITHUB_STEP_SUMMARY`: Path to job summary file (auto-set by GitHub)
- `GITHUB_OUTPUT`: Path to output variables (auto-set by GitHub)

## Debugging

To debug locally with CI-like environment:

```bash
export CLAUDE_CODE_REMOTE=true
bash scripts/dx.sh all
bash scripts/validate-receipts.sh check-all .yawl/.dx-state/
```

For verbose output:
```bash
bash -x scripts/validate-receipts.sh format-github .yawl/.dx-state/guard-receipt.json
```

## References

- **Workflow**: `.github/workflows/validate-gates.yml`
- **Receipt utility**: `scripts/validate-receipts.sh`
- **Build script**: `scripts/dx.sh`
- **Standards**: `.claude/HYPER_STANDARDS.md`
- **Architecture**: `CLAUDE.md` (Λ phase)

