# SPIRE Server Configuration for YAWL Multi-Cloud Deployment
#
# Deploy this configuration to run SPIRE Server in each cloud/region.
# The server issues SVIDs to attested workloads and manages trust bundles.
#
# Deployment:
#   1. Install SPIRE Server: https://spiffe.io/downloads/
#   2. Copy this file to /etc/spire/server.conf
#   3. Initialize: spire-server run -config /etc/spire/server.conf
#   4. Create registration entries for YAWL workloads
#
# For production, use cloud-managed databases (Cloud SQL, RDS, Cosmos DB)

server {
    # Trust domain for this deployment
    trust_domain = "yawl.cloud"

    # Server bind address
    bind_address = "0.0.0.0"
    bind_port = 8081

    # Path to server data directory
    data_dir = "/var/lib/spire/server"

    # Logging
    log_file = "/var/log/spire/server.log"
    log_level = "INFO"

    # CA configuration
    ca_subject = {
        country = ["US"],
        organization = ["YAWL Foundation"],
        common_name = "YAWL SPIRE CA",
    }

    # CA TTL (10 years)
    ca_ttl = "87600h"

    # Default SVID TTL (1 hour)
    default_svid_ttl = "1h"
}

# Plugins
plugins {
    # Data store - use SQL database in production
    DataStore "sql" {
        plugin_data {
            database_type = "postgres"
            connection_string = "host=localhost port=5432 dbname=spire user=spire password=CHANGEME sslmode=require"
        }
    }

    # Node attestation - verify agent identities
    NodeAttestor "join_token" {
        plugin_data {
            # Allow agents to join with pre-shared tokens
            # Use for initial bootstrap, then use cloud attestors
        }
    }

    NodeAttestor "aws_iid" {
        plugin_data {
            # AWS EC2 instance identity document attestation
            # Automatically verifies instances in your AWS account
        }
    }

    NodeAttestor "gcp_iit" {
        plugin_data {
            # GCP instance identity token attestation
            # Automatically verifies instances in your GCP project
            projectid_whitelist = ["yawl-production"]
        }
    }

    NodeAttestor "azure_msi" {
        plugin_data {
            # Azure managed service identity attestation
            # Automatically verifies VMs in your Azure subscription
            tenants = {
                "TENANT_ID" = {
                    resource_id = "SUBSCRIPTION_ID"
                }
            }
        }
    }

    # Node resolver
    NodeResolver "noop" {
        plugin_data {}
    }

    # Key manager
    KeyManager "disk" {
        plugin_data {
            keys_path = "/var/lib/spire/server/keys.json"
        }
    }

    # Upstream authority (for federation)
    UpstreamAuthority "disk" {
        plugin_data {
            # Path to upstream CA certificate
            cert_file_path = "/etc/spire/upstream_ca.pem"
            key_file_path = "/etc/spire/upstream_ca_key.pem"
        }
    }
}

# Health checks
health_checks {
    listener_enabled = true
    bind_address = "127.0.0.1"
    bind_port = 8080
    live_path = "/live"
    ready_path = "/ready"
}

# Federation bundle endpoint (for cross-cloud trust)
federation {
    bundle_endpoint {
        address = "0.0.0.0"
        port = 8443
    }

    # Federated trust domains
    federates_with "gcp.yawl.cloud" {
        bundle_endpoint_url = "https://spire-server-gcp.yawl.cloud:8443"
        bundle_endpoint_profile "https_spiffe" {
            endpoint_spiffe_id = "spiffe://gcp.yawl.cloud/spire/server"
        }
    }

    federates_with "aws.yawl.cloud" {
        bundle_endpoint_url = "https://spire-server-aws.yawl.cloud:8443"
        bundle_endpoint_profile "https_spiffe" {
            endpoint_spiffe_id = "spiffe://aws.yawl.cloud/spire/server"
        }
    }

    federates_with "azure.yawl.cloud" {
        bundle_endpoint_url = "https://spire-server-azure.yawl.cloud:8443"
        bundle_endpoint_profile "https_spiffe" {
            endpoint_spiffe_id = "spiffe://azure.yawl.cloud/spire/server"
        }
    }
}
