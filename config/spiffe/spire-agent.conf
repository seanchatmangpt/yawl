# SPIRE Agent Configuration for YAWL Workloads
#
# Deploy this configuration to run SPIRE Agent alongside YAWL services.
# The agent provides workload attestation and SVID distribution via Unix socket.
#
# Deployment:
#   1. Install SPIRE Agent: https://spiffe.io/downloads/
#   2. Copy this file to /etc/spire/agent.conf
#   3. Start agent: spire-agent run -config /etc/spire/agent.conf
#   4. Verify socket: ls -la /run/spire/sockets/agent.sock
#
# The agent must run on the same host as YAWL workloads.

agent {
    # Trust domain for this deployment
    trust_domain = "yawl.cloud"

    # Path to agent data directory
    data_dir = "/var/lib/spire/agent"

    # Path to agent log file
    log_file = "/var/log/spire/agent.log"
    log_level = "INFO"

    # Server address (SPIRE Server)
    server_address = "spire-server.yawl.cloud"
    server_port = 8081

    # Unix socket for Workload API
    socket_path = "/run/spire/sockets/agent.sock"
}

# Plugins for workload attestation
plugins {
    # Node attestation - proves this host's identity to SPIRE Server
    NodeAttestor "join_token" {
        plugin_data {
            # Join token provided during agent bootstrap
            # In production, use cloud-specific attestors (AWS, GCP, Azure)
        }
    }

    # Workload attestation - identifies workloads on this host
    WorkloadAttestor "unix" {
        plugin_data {
            # Attest based on Unix process UID/GID/PID
        }
    }

    WorkloadAttestor "docker" {
        plugin_data {
            # Attest based on Docker container labels
            docker_socket_path = "/var/run/docker.sock"
        }
    }

    WorkloadAttestor "k8s" {
        plugin_data {
            # Attest based on Kubernetes pod service account
            skip_kubelet_verification = false
            kubelet_read_only_port = 10255
        }
    }

    # Key manager
    KeyManager "disk" {
        plugin_data {
            directory = "/var/lib/spire/agent/keys"
        }
    }
}

# Health checks
health_checks {
    listener_enabled = true
    bind_address = "127.0.0.1"
    bind_port = 8080
    live_path = "/live"
    ready_path = "/ready"
}
