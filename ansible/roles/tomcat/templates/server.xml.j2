<?xml version='1.0' encoding='utf-8'?>
<!-- YAWL Tomcat Server Configuration - Generated by Ansible -->
<Server port="{{ tomcat_shutdown_port }}" shutdown="SHUTDOWN">
  <Listener className="org.apache.catalina.startup.VersionLoggerListener" />
  <Listener className="org.apache.catalina.core.AprLifecycleListener" SSLEngine="on" />
  <Listener className="org.apache.catalina.core.JreMemoryLeakPreventionListener" />
  <Listener className="org.apache.catalina.mbeans.GlobalResourcesLifecycleListener" />
  <Listener className="org.apache.catalina.core.ThreadLocalLeakPreventionListener" />

  <GlobalNamingResources>
    <!-- YAWL Database Connection Pool -->
    <Resource name="jdbc/yawl"
              auth="Container"
              type="javax.sql.DataSource"
              driverClassName="org.postgresql.Driver"
              url="jdbc:postgresql://{{ yawl_db_host }}:{{ yawl_db_port }}/{{ yawl_db_name }}"
              username="{{ yawl_db_user }}"
              password="{{ yawl_db_password }}"
              maxActive="{{ yawl_db_pool_size }}"
              maxIdle="10"
              minIdle="2"
              maxWait="{{ yawl_db_connection_timeout }}"
              validationQuery="SELECT 1"
              testOnBorrow="true"
              testWhileIdle="true"
              timeBetweenEvictionRunsMillis="30000"
              minEvictableIdleTimeMillis="{{ yawl_db_max_idle_time }}000"
              removeAbandoned="true"
              removeAbandonedTimeout="300" />
  </GlobalNamingResources>

  <Service name="Catalina">
    <!-- HTTP Connector -->
    <Connector port="{{ tomcat_port }}"
               protocol="HTTP/1.1"
               connectionTimeout="20000"
               redirectPort="{{ tomcat_ssl_enabled | ternary(tomcat_https_port, tomcat_port) }}"
               maxHttpHeaderSize="{{ tomcat_max_http_header_size }}"
               maxThreads="{{ tomcat_max_threads }}"
               minSpareThreads="{{ tomcat_min_spare_threads }}"
               acceptCount="{{ tomcat_accept_count }}"
               enableLookups="false"
               useBodyEncodingForURI="true"
               URIEncoding="UTF-8"
               disableUploadTimeout="{{ tomcat_disable_upload_timeout }}"
               connectionUploadTimeout="{{ tomcat_upload_timeout }}"
               compression="{{ tomcat_compression_enabled | lower }}"
               compressionMinSize="{{ tomcat_compression_min_size }}"
               noCompressionUserAgents="gozilla, traviata" />

    <!-- AJP Connector for load balancer -->
    <Connector port="{{ tomcat_ajp_port }}"
               protocol="AJP/1.3"
               address="0.0.0.0"
               redirectPort="{{ tomcat_ssl_enabled | ternary(tomcat_https_port, tomcat_port) }}"
               maxThreads="{{ tomcat_max_threads }}"
               minSpareThreads="{{ tomcat_min_spare_threads }}"
               acceptCount="{{ tomcat_accept_count }}" />

    {% if tomcat_ssl_enabled %}
    <!-- HTTPS Connector -->
    <Connector port="{{ tomcat_https_port }}"
               protocol="HTTP/1.1"
               SSLEnabled="true"
               scheme="https"
               secure="true"
               clientAuth="false"
               sslProtocol="TLSv1.2,TLSv1.3"
               keystoreFile="{{ tomcat_ssl_cert_file }}"
               keystorePass="{{ tomcat_ssl_key_password }}"
               maxThreads="{{ tomcat_max_threads }}"
               minSpareThreads="{{ tomcat_min_spare_threads }}" />
    {% endif %}

    <!-- Engine Configuration -->
    <Engine name="Catalina" defaultHost="localhost" jvmRoute="{{ tomcat_jvmroute }}">
      <Realm className="org.apache.catalina.realm.LockOutRealm">
        <Realm className="org.apache.catalina.realm.UserDatabaseRealm" resourceName="UserDatabase" />
      </Realm>

      <Host name="localhost" appBase="webapps" unpackWARs="true" autoDeploy="true">
        <Valve className="org.apache.catalina.valves.AccessLogValve"
               directory="logs"
               prefix="localhost_access_log"
               suffix=".txt"
               pattern="%h %l %u %t &quot;%r&quot; %s %b" />

        <!-- YAWL Application Context -->
        <Context path="{{ yawl_context }}"
                 docBase="yawl.war"
                 reloadable="false"
                 sessionCookiePath="{{ yawl_context }}"
                 sessionCookieName="YAWL_SESSION"
                 manager="org.apache.catalina.session.PersistentManager">
          <ResourceLink name="jdbc/yawl"
                        global="jdbc/yawl"
                        type="javax.sql.DataSource" />
        </Context>

        <!-- ROOT Context -->
        <Context path="" docBase="ROOT" reloadable="false" />
      </Host>
    </Engine>
  </Service>
</Server>
