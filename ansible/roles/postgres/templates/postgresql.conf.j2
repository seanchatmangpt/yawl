# PostgreSQL Configuration File - Generated by Ansible
# For detailed information see /usr/share/postgresql/{{ postgres_version }}/postgresql.conf.sample

# Connection Settings
listen_addresses = '{{ postgres_listen_addresses }}'
port = {{ postgres_port }}
max_connections = {{ postgres_max_connections }}
max_prepared_transactions = {{ postgres_max_prepared_transactions }}

# Memory Settings
shared_buffers = {{ postgres_shared_buffers }}
effective_cache_size = {{ postgres_effective_cache_size }}
maintenance_work_mem = {{ postgres_maintenance_work_mem }}
work_mem = {{ postgres_work_mem }}
wal_buffers = {{ postgres_wal_buffers }}

# Checkpoint/Logging Settings
checkpoint_completion_target = {{ postgres_checkpoint_completion_target }}
wal_buffers = {{ postgres_wal_buffers }}
default_statistics_target = {{ postgres_default_statistics_target }}
random_page_cost = {{ postgres_random_page_cost }}
effective_io_concurrency = {{ postgres_effective_io_concurrency }}
min_wal_size = {{ postgres_min_wal_size }}
max_wal_size = {{ postgres_max_wal_size }}

# WAL Settings
wal_level = replica
wal_log_hints = on

# Replication Settings
{% if postgres_replication_role == 'primary' %}
max_wal_senders = {{ postgres_max_wal_senders }}
wal_keep_size = {{ postgres_wal_keep_size }}
hot_standby = {{ postgres_hot_standby }}
{% endif %}

{% if postgres_replication_role == 'standby' %}
hot_standby = on
hot_standby_feedback = {{ postgres_hot_standby_feedback }}
recovery_min_apply_delay = 0
{% endif %}

# Archive Settings
{% if postgres_wal_archiving_enabled %}
archive_mode = on
archive_command = '{{ postgres_wal_archive_command }}'
archive_timeout = 300
{% endif %}

# Logging
logging_collector = on
log_directory = 'pg_log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_truncate_on_rotation = on
log_rotation_age = 1d
log_rotation_size = 100MB
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_checkpoints = on
log_connections = on
log_disconnections = on
log_duration = off
log_lock_waits = on
log_statement = 'ddl'
log_temp_files = 0
log_autovacuum_min_duration = 0

# Performance
statement_timeout = {{ postgres_statement_timeout }}
idle_in_transaction_session_timeout = {{ postgres_default_idle_in_transaction_session_timeout }}

# Monitoring
shared_preload_libraries = 'pg_stat_statements,pgcrypto'

# Security
password_encryption = {{ postgres_password_encryption }}
