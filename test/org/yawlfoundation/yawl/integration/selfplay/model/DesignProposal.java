package org.yawlfoundation.yawl.integration.selfplay.model;

import java.time.Instant;

/**
 * A design proposal generated by {@code V7DesignAgent} during a self-play round.
 *
 * <p>Each proposal targets one {@link V7Gap} and includes:
 * <ul>
 *   <li>{@code proposalId} — unique ID for this proposal</li>
 *   <li>{@code gap} — the v7 gap being addressed</li>
 *   <li>{@code title} — short human-readable title</li>
 *   <li>{@code rationale} — explanation of how this proposal addresses the gap</li>
 *   <li>{@code backwardCompatScore} — 0.0–1.0; 1.0 = fully backward-compatible</li>
 *   <li>{@code performanceGain} — estimated relative performance improvement (0.0–1.0)</li>
 *   <li>{@code round} — which self-play round produced this proposal</li>
 *   <li>{@code timestamp} — when the proposal was generated</li>
 * </ul>
 *
 * @param proposalId unique identifier for this proposal
 * @param gap the v7 gap this proposal addresses
 * @param title short human-readable title
 * @param rationale explanation of how this proposal resolves the gap
 * @param backwardCompatScore backward compatibility score (0.0 = breaking, 1.0 = fully compatible)
 * @param performanceGain estimated relative performance improvement (0.0–1.0)
 * @param round self-play round in which this proposal was generated
 * @param timestamp when the proposal was generated
 */
public record DesignProposal(
    String proposalId,
    V7Gap gap,
    String title,
    String rationale,
    double backwardCompatScore,
    double performanceGain,
    int round,
    Instant timestamp
) {
    public DesignProposal {
        if (proposalId == null || proposalId.isBlank()) {
            throw new IllegalArgumentException("proposalId is required");
        }
        if (gap == null) {
            throw new IllegalArgumentException("gap is required");
        }
        if (title == null || title.isBlank()) {
            throw new IllegalArgumentException("title is required");
        }
        if (rationale == null || rationale.isBlank()) {
            throw new IllegalArgumentException("rationale is required");
        }
        if (backwardCompatScore < 0.0 || backwardCompatScore > 1.0) {
            throw new IllegalArgumentException(
                "backwardCompatScore must be in [0.0, 1.0], got: " + backwardCompatScore);
        }
        if (performanceGain < 0.0 || performanceGain > 1.0) {
            throw new IllegalArgumentException(
                "performanceGain must be in [0.0, 1.0], got: " + performanceGain);
        }
        if (round < 1) {
            throw new IllegalArgumentException("round must be >= 1, got: " + round);
        }
        if (timestamp == null) {
            timestamp = Instant.now();
        }
    }

    /**
     * Returns a strengthened version of this proposal incorporating a response to prior challenges.
     * Used by the self-play agent when re-proposing a previously rejected gap.
     */
    public DesignProposal withStrengthened(int newRound, String additionalRationale) {
        return new DesignProposal(
            proposalId + "-r" + newRound,
            gap,
            title,
            rationale + " [Strengthened in round " + newRound + ": " + additionalRationale + "]",
            backwardCompatScore,
            performanceGain,
            newRound,
            Instant.now()
        );
    }
}
