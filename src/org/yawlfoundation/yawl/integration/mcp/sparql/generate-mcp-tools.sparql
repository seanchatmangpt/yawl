PREFIX yawl: <http://yawlfoundation.org/yawl#>
PREFIX mcp:  <http://modelcontextprotocol.io/schema#>
PREFIX rdf:  <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX xsd:  <http://www.w3.org/2001/XMLSchema#>

# ============================================================================
# CONSTRUCT: MCP Tool Schema Generation from YAWL Workflow Net
# ============================================================================
#
# This query embodies the core CONSTRUCT coordination claim:
#   Tool schemas are derived from the workflow's ontological description —
#   not authored by humans.
#
# For each atomic task in the workflow net, CONSTRUCT produces:
#   - An mcp:Tool resource with toolName, description, forTask, forWorkflow
#   - An mcp:ToolParam for case_id (always required — Petri net identity)
#   - Metadata asserting coordination cost: zero inference tokens
#
# Execution path:
#   1. WorkflowNetToRdfConverter converts YAWL XML spec → RDF graph
#   2. This query runs over that graph (via ggen-sync.sh / Oxigraph)
#   3. Output RDF encodes the MCP tool definitions as triples
#   4. yawl_generate_tool_schema MCP tool serializes output as JSON
#
# Cost comparison (per routing decision):
#   select/do agent:  ~2000 inference tokens, 200ms, non-deterministic
#   CONSTRUCT agent:  0 inference tokens,    <1ms,  deterministic, sound
#
# The generated tools are formally correct: task enablement is guaranteed by
# YAWL Petri net soundness — no deadlock, every enabled task will eventually
# fire or be withdrawn by cancellation.
# ============================================================================

CONSTRUCT {
    ?toolUri a mcp:Tool ;
        mcp:toolName      ?toolName ;
        mcp:description   ?description ;
        mcp:forTask       ?task ;
        mcp:forWorkflow   ?net ;
        mcp:coordinationModel "CONSTRUCT" ;
        mcp:routingCost   "zero_inference_tokens" ;
        mcp:soundnessProof "YAWL Petri net soundness: task enabled iff all preset conditions marked (AND-join) or any preset condition marked (XOR-join). No deadlock guarantee from workflow soundness verification." ;
        mcp:inputSchema [
            rdf:type             mcp:ObjectSchema ;
            mcp:requiredProperty "case_id"
        ] .

    ?caseParamUri a mcp:ToolParam ;
        mcp:inTool        ?toolUri ;
        mcp:paramName     "case_id" ;
        mcp:paramType     "string" ;
        mcp:required      true ;
        mcp:paramDescription "YAWL case identifier. Task enablement is validated via Petri net token marking query — no inference required." .
}
WHERE {
    ?net a yawl:WorkflowNet ;
         yawl:netId ?netId .

    ?task a yawl:AtomicTask ;
          yawl:taskId ?taskId ;
          yawl:inNet  ?net .

    OPTIONAL { ?task yawl:taskName ?taskNameOpt }

    BIND(IRI(CONCAT("http://modelcontextprotocol.io/tools/yawl/", ?netId, "/", ?taskId))
         AS ?toolUri)
    BIND(IRI(CONCAT("http://modelcontextprotocol.io/tools/yawl/", ?netId, "/", ?taskId, "/param/case_id"))
         AS ?caseParamUri)
    BIND(CONCAT("yawl_execute_", ?taskId) AS ?toolName)
    BIND(
        CONCAT(
            "Execute YAWL task '", COALESCE(?taskNameOpt, ?taskId),
            "' in workflow '", ?netId, "'. ",
            "CONSTRUCT-generated from YAWL specification ontology — not hand-authored. ",
            "Task enablement guaranteed by Petri net soundness. ",
            "Routing cost: 0 inference tokens (token marking query)."
        )
        AS ?description
    )
}
