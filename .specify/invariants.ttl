@prefix code: <http://yawlfoundation.org/code#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix yawl: <http://www.yawlfoundation.org/yawlschema#> .
@prefix schema: <https://schema.org/> .
@prefix prov: <http://www.w3.org/ns/prov#> .
@prefix dcterms: <http://purl.org/dc/terms/> .

# ============================================================================
# INVARIANT SHAPE DEFINITIONS FOR YAWL CODE GENERATION & ONTOLOGY
# Validates: real_impl ∨ throw, ¬mock, ¬silent_fallback, ¬lie, extension-only
# ============================================================================

# Namespace aliases for clarity
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix code: <http://yawlfoundation.org/code#> .

# ============================================================================
# SHAPE 1: Real Implementation or Throw Exception
# ============================================================================
# Invariant Q1: Every method must either implement real logic OR throw
# UnsupportedOperationException. No empty stubs.
# ============================================================================

code:RealImplOrThrowShape a sh:NodeShape ;
    sh:targetClass code:Method ;
    sh:name "Real Implementation or Throw Exception" ;
    sh:description
        "Each method must contain real implementation logic (body length >= 10 chars) " ;
        "OR throw UnsupportedOperationException. No empty method bodies allowed." ;
    sh:severity sh:Violation ;
    sh:sparql [
        a sh:SPARQLSelectValidator ;
        sh:message "Method {$this} ({?methodName} in {?className}): "
                   "Empty body (length {?bodyLen}) without throwing exception at line {?line}" ;
        sh:select """
            PREFIX code: <http://yawlfoundation.org/code#>
            SELECT $this ?className ?methodName ?line ?bodyLen WHERE {
                $this a code:Method ;
                      code:belongsTo ?class ;
                      code:name ?methodName ;
                      code:lineNumber ?line ;
                      code:body ?body .
                ?class code:name ?className .
                BIND(strlen(?body) AS ?bodyLen)
                
                # Violation: body too short (likely empty or stub)
                FILTER (?bodyLen < 10)
                
                # AND doesn't throw UnsupportedOperationException
                FILTER NOT EXISTS {
                    $this code:throwsException code:UnsupportedOperationException
                }
            }
            ORDER BY ?className ?methodName
        """
    ] .

# ============================================================================
# SHAPE 2: No Mock/Stub/Fake Objects
# ============================================================================
# Invariant Q2: No class or variable names containing mock/stub/fake/demo.
# All classes must represent real implementations.
# ============================================================================

code:NoMockObjectsShape a sh:NodeShape ;
    sh:targetClass code:Class ;
    sh:name "No Mock/Stub/Fake/Demo Classes" ;
    sh:description "Class names must not indicate mock, stub, fake, or demo implementations" ;
    sh:severity sh:Violation ;
    sh:property [
        sh:path code:name ;
        sh:pattern "^(?!Mock|Stub|Fake|Demo)" ;
        sh:flags "i" ;
        sh:message "Class name '{?value}' indicates mock/stub implementation (forbidden by invariant Q2)"
    ] .

code:NoMockVariablesShape a sh:NodeShape ;
    sh:targetClass code:Variable ;
    sh:name "No Mock Variables" ;
    sh:description "Variable names must not indicate mock or test data" ;
    sh:severity sh:Violation ;
    sh:sparql [
        a sh:SPARQLSelectValidator ;
        sh:message "Variable {?varName} in {?methodName}: name indicates mock/fake/test data" ;
        sh:select """
            PREFIX code: <http://yawlfoundation.org/code#>
            SELECT $this ?varName ?methodName WHERE {
                $this a code:Variable ;
                      code:name ?varName ;
                      code:belongsTo ?method .
                ?method code:name ?methodName .
                
                FILTER regex(?varName, "(mock|fake|test|stub|demo|sample)", "i")
            }
        """
    ] .

# ============================================================================
# SHAPE 3: No Silent Fallbacks in Exception Handlers
# ============================================================================
# Invariant Q3: Catch blocks must NOT silently return fake data.
# Must: re-throw, log + provide alternative, OR implement real recovery.
# ============================================================================

code:NoSilentFallbackShape a sh:NodeShape ;
    sh:targetClass code:CatchBlock ;
    sh:name "No Silent Fallback to Fake Data" ;
    sh:description
        "Exception handlers must not silently return fake/mock/test data. " ;
        "Must re-throw, log + alternative, or implement real recovery logic." ;
    sh:severity sh:Violation ;
    sh:sparql [
        a sh:SPARQLSelectValidator ;
        sh:message "Catch block in {?methodName} (line {?line}): "
                   "silent fallback detected (returns fake/mock/demo without re-throw)" ;
        sh:select """
            PREFIX code: <http://yawlfoundation.org/code#>
            SELECT $this ?methodName ?line WHERE {
                $this a code:CatchBlock ;
                      code:body ?body ;
                      code:lineNumber ?line ;
                      code:belongsTo ?method .
                ?method code:name ?methodName .
                
                # Violation: returns fake/mock/demo data
                FILTER regex(?body, "return\\s+(mock|fake|test|sample|demo|Demo|Fake)[A-Za-z0-9()]*", "i")
                
                # AND doesn't re-throw exception
                FILTER NOT EXISTS {
                    $this code:rethrows ?ex
                }
                
                # AND doesn't log error + alternative
                FILTER NOT EXISTS {
                    $this code:logsError code:Error
                }
            }
            ORDER BY ?methodName ?line
        """
    ] .

# ============================================================================
# SHAPE 4: Code Must Match Documentation (No Lies)
# ============================================================================
# Invariant Q4: Method behavior must align with javadoc @throws and description.
# If doc claims throws X, code must throw X. If doc claims behavior Y, code does Y.
# ============================================================================

code:NoLieShape a sh:NodeShape ;
    sh:targetClass code:Method ;
    sh:name "Code Matches Documentation" ;
    sh:description
        "Method implementation must match its javadoc contract. " ;
        "If javadoc @throws declares exception X, code must throw X. " ;
        "Method behavior must align with description." ;
    sh:severity sh:Violation ;
    sh:sparql [
        a sh:SPARQLSelectValidator ;
        sh:message "Method {?methodName} in {?className} (line {?line}): "
                   "Documentation claims 'throws {?docThrows}' but code doesn't throw it" ;
        sh:select """
            PREFIX code: <http://yawlfoundation.org/code#>
            PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
            SELECT $this ?className ?methodName ?line ?docThrows WHERE {
                $this a code:Method ;
                      code:belongsTo ?class ;
                      code:name ?methodName ;
                      code:lineNumber ?line ;
                      rdfs:comment ?documentation ;
                      code:body ?body .
                ?class code:name ?className .
                
                # Extract expected exception from javadoc
                # Pattern: @throws ExceptionType or throws ExceptionType
                BIND(
                    REGEX(?documentation, "@throws\\s+([A-Za-z0-9]+Exception)|throws\\s+([A-Za-z0-9]+Exception)", "i")
                    AS ?docThrows
                )
                FILTER BOUND(?docThrows)
                
                # Violation: doc mentions exception but code doesn't throw it
                FILTER NOT EXISTS {
                    $this code:throwsException ?exception .
                    FILTER regex(str(?exception), ?docThrows)
                }
            }
            ORDER BY ?className ?methodName
        """
    ] .

code:MethodReturnTypeMatchesDocShape a sh:NodeShape ;
    sh:targetClass code:Method ;
    sh:name "Return Type Matches Documentation" ;
    sh:description "Method return type must match what javadoc claims" ;
    sh:severity sh:Violation ;
    sh:sparql [
        a sh:SPARQLSelectValidator ;
        sh:message "Method {?methodName}: return type mismatch with javadoc" ;
        sh:select """
            PREFIX code: <http://yawlfoundation.org/code#>
            PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
            SELECT $this ?methodName WHERE {
                $this a code:Method ;
                      code:name ?methodName ;
                      code:returnType ?actualType ;
                      rdfs:comment ?documentation .
                
                # Extract @return statement from javadoc
                BIND(
                    REGEX(?documentation, "@return\\s+([A-Za-z0-9<>]+)", "i")
                    AS ?docType
                )
                FILTER BOUND(?docType)
                
                # Violation: documented type doesn't match actual return type
                FILTER (!regex(str(?actualType), ?docType, "i"))
            }
        """
    ] .

# ============================================================================
# METADATA SHAPES (for compliance tracking)
# ============================================================================

code:MethodMetadataShape a sh:NodeShape ;
    sh:targetClass code:Method ;
    sh:name "Method Metadata Completeness" ;
    sh:description "Method must have essential metadata for validation" ;
    sh:property [
        sh:path code:name ;
        sh:minCount 1 ;
        sh:message "Method missing name"
    ] ;
    sh:property [
        sh:path code:body ;
        sh:minCount 1 ;
        sh:message "Method missing body"
    ] ;
    sh:property [
        sh:path code:lineNumber ;
        sh:minCount 1 ;
        sh:message "Method missing line number"
    ] ;
    sh:property [
        sh:path code:belongsTo ;
        sh:minCount 1 ;
        sh:message "Method not associated with class"
    ] .

code:ClassMetadataShape a sh:NodeShape ;
    sh:targetClass code:Class ;
    sh:name "Class Metadata Completeness" ;
    sh:description "Class must have essential metadata" ;
    sh:property [
        sh:path code:name ;
        sh:minCount 1 ;
        sh:message "Class missing name"
    ] ;
    sh:property [
        sh:path code:package ;
        sh:minCount 1 ;
        sh:message "Class missing package"
    ] .

# ============================================================================
# SHAPE COLLECTION FOR BATCH PROCESSING
# ============================================================================

code:AllInvariantShapes a rdf:Bag ;
    rdf:_1 code:RealImplOrThrowShape ;
    rdf:_2 code:NoMockObjectsShape ;
    rdf:_3 code:NoMockVariablesShape ;
    rdf:_4 code:NoSilentFallbackShape ;
    rdf:_5 code:NoLieShape ;
    rdf:_6 code:MethodReturnTypeMatchesDocShape ;
    rdf:_7 code:MethodMetadataShape ;
    rdf:_8 code:ClassMetadataShape ;
    rdf:_9 yawl:ExtensionOnlyConstraintShape .

# ============================================================================
# SHAPE 9: Extension-Only Architectural Constraint (Ontology Alignment)
# ============================================================================
# Invariant O1: Every YAWL workflow specification instance must extend at
# least one public ontology type (Schema.org, PROV-O, Dublin Core, etc.).
# No proprietary-only instances allowed.
#
# Rationale: YAWL is middleware. Workflow data must be semantically grounded
# in standard reference models to enable interoperability, integration, and
# automated reasoning. Proprietary types impede knowledge sharing.
#
# Compliance: All rdf:type triples on YAWL instances must include at least
# one type from: schema:, prov:, dcterms:, http://www.w3.org/ namespaces
# ============================================================================

yawl:ExtensionOnlyConstraintShape a sh:NodeShape ;
    sh:name "Extension-Only Ontology Alignment" ;
    sh:description
        "Every YAWL workflow instance must have at least one rdf:type " ;
        "from a public ontology namespace (Schema.org, PROV-O, Dublin Core, etc.). " ;
        "This enforces semantic grounding and interoperability." ;
    sh:severity sh:Violation ;

    sh:sparql [
        a sh:SPARQLSelectValidator ;
        sh:message "Instance {$this}: has only proprietary YAWL types, no public ontology alignment. " ;
                   "Add rdf:type from schema:, prov:, dcterms:, or other public ontology." ;
        sh:prefixes yawl: ;
        sh:select """
            PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
            PREFIX yawl: <http://www.yawlfoundation.org/yawlschema#>
            PREFIX schema: <https://schema.org/>
            PREFIX prov: <http://www.w3.org/ns/prov#>
            PREFIX dcterms: <http://purl.org/dc/terms/>

            SELECT $this
            WHERE {
              # Find YAWL instances (has at least one yawl: type)
              $this rdf:type ?yawlType .
              FILTER(STRSTARTS(STR(?yawlType), STR(yawl:)))

              # Violation: MUST have at least one non-YAWL public type
              # If NOT EXISTS, then all types are yawl: (violation)
              FILTER NOT EXISTS {
                $this rdf:type ?publicType .
                FILTER(
                  !STRSTARTS(STR(?publicType), STR(yawl:)) &&
                  (
                    STRSTARTS(STR(?publicType), "https://schema.org/") ||
                    STRSTARTS(STR(?publicType), "http://schema.org/") ||
                    STRSTARTS(STR(?publicType), STR(prov:)) ||
                    STRSTARTS(STR(?publicType), STR(dcterms:)) ||
                    STRSTARTS(STR(?publicType), "http://www.w3.org/ns/") ||
                    STRSTARTS(STR(?publicType), "http://purl.org/")
                  )
                )
              }
            }
        """
    ] .

# TBox Alignment: All YAWL classes must declare rdfs:subClassOf to public ontology
yawl:ExtensionOnlyTBoxShape a sh:NodeShape ;
    sh:name "Extension-Only TBox Alignment" ;
    sh:description
        "Every YAWL ontology class must declare rdfs:subClassOf to a public " ;
        "ontology class, or be defined via owl:unionOf/intersectionOf with public types." ;
    sh:severity sh:Warning ;

    sh:sparql [
        a sh:SPARQLSelectValidator ;
        sh:message "Class {$this}: proprietary root (no public superclass). " ;
                   "Add rdfs:subClassOf pointing to schema.org or other public ontology class." ;
        sh:prefixes yawl: ;
        sh:select """
            PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
            PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
            PREFIX owl: <http://www.w3.org/2002/07/owl#>
            PREFIX yawl: <http://www.yawlfoundation.org/yawlschema#>
            PREFIX schema: <https://schema.org/>
            PREFIX prov: <http://www.w3.org/ns/prov#>

            SELECT $this
            WHERE {
              # YAWL class definition in TBox
              $this a owl:Class .
              FILTER(STRSTARTS(STR($this), STR(yawl:)))

              # Check: has rdfs:subClassOf to public ontology?
              FILTER NOT EXISTS {
                $this rdfs:subClassOf ?publicParent .
                FILTER(!STRSTARTS(STR(?publicParent), STR(yawl:)))
              }

              # Check: has owl:unionOf or owl:intersectionOf with public types?
              FILTER NOT EXISTS {
                { $this owl:unionOf ?u . } UNION { $this owl:intersectionOf ?i . }
              }
            }
        """
    ] .
