# YAWL MCP Server - Multi-Architecture Docker Build
#
# Builds the YAWL Model Context Protocol server with:
# - Multi-arch support (linux/amd64, linux/arm64)
# - Java 25 with virtual threads (standard, no preview required)
# - Non-root security context (UID 10001)
# - Minimal Alpine JRE runtime for reduced attack surface
# - Structured health checks for Kubernetes liveness/readiness probes
# - STDIO transport for MCP protocol over stdin/stdout
#
# Required environment variables at runtime:
#   YAWL_ENGINE_URL - YAWL engine base URL (e.g. http://yawl-engine:8080/yawl)
#   YAWL_USERNAME   - YAWL admin username (mount from Kubernetes Secret)
#   YAWL_PASSWORD   - YAWL admin password (mount from Kubernetes Secret)
#
# Optional environment variables:
#   ZAI_API_KEY     - Z.AI / ZHIPU API key for natural language tool (ZhipuAI GLM-4)
#   ZHIPU_API_KEY   - Alias for ZAI_API_KEY (ZHIPU platform naming)
#   MCP_LOG_LEVEL   - MCP server log verbosity (DEBUG|INFO|WARN|ERROR, default: INFO)
#   JAVA_OPTS       - Additional JVM flags (appended to defaults)

# ============================================================================
# Build Stage - Maven with full JDK (cached dependency layer)
# ============================================================================
FROM eclipse-temurin:25-jdk-alpine AS builder

ARG MAVEN_VERSION=3.9.9
ARG BUILD_DATE
ARG VCS_REF

# Install Maven and build tools in one cached layer
RUN apk add --no-cache curl tar \
    && curl -fsSL \
       https://archive.apache.org/dist/maven/maven-3/${MAVEN_VERSION}/binaries/apache-maven-${MAVEN_VERSION}-bin.tar.gz \
       | tar -xzf - -C /opt \
    && ln -s /opt/apache-maven-${MAVEN_VERSION}/bin/mvn /usr/local/bin/mvn \
    && rm -rf /var/cache/apk/*

WORKDIR /build

# Layer: pom files only (dependency resolution cache - most stable)
COPY pom.xml ./
COPY yawl-utilities/pom.xml     ./yawl-utilities/
COPY yawl-elements/pom.xml      ./yawl-elements/
COPY yawl-authentication/pom.xml ./yawl-authentication/
COPY yawl-engine/pom.xml        ./yawl-engine/
COPY yawl-stateless/pom.xml     ./yawl-stateless/
COPY yawl-resourcing/pom.xml    ./yawl-resourcing/
COPY yawl-worklet/pom.xml       ./yawl-worklet/
COPY yawl-scheduling/pom.xml    ./yawl-scheduling/
COPY yawl-integration/pom.xml   ./yawl-integration/
COPY yawl-monitoring/pom.xml    ./yawl-monitoring/
COPY yawl-webapps/pom.xml       ./yawl-webapps/
COPY yawl-control-panel/pom.xml ./yawl-control-panel/

# Download dependencies (cached when pom files unchanged)
RUN mvn dependency:go-offline \
      --batch-mode \
      --no-transfer-progress \
      -P mcp-server \
    || true

# Layer: source (changes frequently)
COPY src ./src
COPY yawl-utilities/src ./yawl-utilities/src
COPY yawl-elements/src  ./yawl-elements/src
COPY yawl-authentication/src ./yawl-authentication/src
COPY yawl-engine/src    ./yawl-engine/src
COPY yawl-stateless/src ./yawl-stateless/src
COPY yawl-resourcing/src ./yawl-resourcing/src
COPY yawl-worklet/src   ./yawl-worklet/src
COPY yawl-scheduling/src ./yawl-scheduling/src
COPY yawl-integration/src ./yawl-integration/src
COPY yawl-monitoring/src ./yawl-monitoring/src
COPY yawl-control-panel/src ./yawl-control-panel/src
COPY schema ./schema
COPY build  ./build

# Build the MCP server shaded JAR (yawl-integration module contains McpServer main)
RUN mvn package \
      --batch-mode \
      --no-transfer-progress \
      -Dmaven.test.skip=true \
      -pl yawl-integration \
      -am \
    && find /build -name "yawl-integration-*-mcp.jar" -o -name "yawl-integration-*-shaded.jar" \
       | head -1 \
       | xargs -I{} cp {} /build/yawl-mcp-server.jar \
    || (find /build -name "yawl-integration-*.jar" ! -name "*sources*" ! -name "*javadoc*" \
        | head -1 \
        | xargs -I{} cp {} /build/yawl-mcp-server.jar)

# ============================================================================
# Runtime Stage - Minimal JRE 25 on Alpine
# ============================================================================
FROM eclipse-temurin:25-jre-alpine AS runtime

ARG VERSION=6.0.0-Alpha
ARG BUILD_DATE
ARG VCS_REF
ARG MAINTAINER="YAWL Foundation <info@yawlfoundation.org>"

# OCI Image Labels
LABEL maintainer="${MAINTAINER}"
LABEL org.opencontainers.image.title="YAWL MCP Server"
LABEL org.opencontainers.image.description="YAWL Workflow Engine Model Context Protocol Server - exposes workflow operations to AI agents via MCP"
LABEL org.opencontainers.image.version="${VERSION}"
LABEL org.opencontainers.image.created="${BUILD_DATE}"
LABEL org.opencontainers.image.revision="${VCS_REF}"
LABEL org.opencontainers.image.source="https://github.com/yawlfoundation/yawl"
LABEL org.opencontainers.image.url="https://yawlfoundation.org"
LABEL org.opencontainers.image.vendor="YAWL Foundation"
LABEL org.opencontainers.image.licenses="LGPL-3.0-or-later"
LABEL org.opencontainers.image.documentation="https://yawlfoundation.github.io/yawl/mcp"
LABEL org.yawlfoundation.yawl.component="mcp-server"
LABEL org.yawlfoundation.yawl.java-version="25"
LABEL org.yawlfoundation.yawl.transport="stdio"
LABEL org.yawlfoundation.yawl.protocol="mcp-0.17.2"

# Runtime dependencies
RUN apk add --no-cache \
    bash \
    curl \
    ca-certificates \
    tzdata \
    && rm -rf /var/cache/apk/*

# Non-root user for security (UID 10001 - outside typical privileged range)
RUN addgroup -S mcp --gid 10001 \
    && adduser -S mcp --uid 10001 --ingroup mcp \
       --home /app --shell /sbin/nologin \
       --no-create-home

WORKDIR /app

# Create working directories
RUN mkdir -p /app/logs /app/temp \
    && chown -R mcp:mcp /app

# Copy built JAR from builder stage
COPY --from=builder --chown=mcp:mcp /build/yawl-mcp-server.jar /app/yawl-mcp-server.jar

# Copy health check script (checks process liveness, not HTTP since MCP uses STDIO)
COPY --chown=mcp:mcp docker/mcp-healthcheck.sh /app/healthcheck.sh
RUN chmod +x /app/healthcheck.sh

USER mcp

# MCP server communicates via STDIO - no network ports exposed
# The sidecar pattern in Kubernetes routes MCP traffic through stdin/stdout

# JVM settings optimised for MCP workload:
# - Container-aware memory limits
# - ZGC generational for low-latency GC pauses during tool calls
# - Virtual thread scheduler tuned for many concurrent AI agent requests
ENV JAVA_OPTS="\
    -XX:+UseContainerSupport \
    -XX:MaxRAMPercentage=75.0 \
    -XX:InitialRAMPercentage=40.0 \
    -XX:+UseZGC \
    -XX:+ZGenerational \
    -XX:+UseCompactObjectHeaders \
    -XX:+ExitOnOutOfMemoryError \
    -XX:HeapDumpPath=/app/logs/heap-dump.hprof \
    -Djava.security.egd=file:/dev/./urandom \
    -Djava.io.tmpdir=/app/temp \
    -Dfile.encoding=UTF-8 \
    -Djdk.virtualThreadScheduler.parallelism=64 \
    -Djdk.virtualThreadScheduler.maxPoolSize=128"

ENV MCP_LOG_LEVEL=INFO
ENV TZ=UTC

# Health check verifies the Java process is alive
# MCP servers are process-based (STDIO), not HTTP-based
HEALTHCHECK --interval=30s \
            --timeout=10s \
            --start-period=30s \
            --retries=3 \
    CMD /app/healthcheck.sh

# Start MCP server - reads from stdin, writes to stdout (MCP STDIO protocol)
ENTRYPOINT ["sh", "-c", \
    "exec java $JAVA_OPTS \
     -Dorg.yawlfoundation.yawl.mcp.log.level=${MCP_LOG_LEVEL} \
     -jar /app/yawl-mcp-server.jar"]
